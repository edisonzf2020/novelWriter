# Story 4.1: 增强的Diff预览与回滚体验

## Status
Approved

## Story
**As a** 经常使用AI修改功能的作者,
**I want** Diff预览界面更友好，并且能够轻松地回滚到多个历史版本,
**so that** 我可以更直观地比较和选择AI的建议。

## Acceptance Criteria
1. Diff预览界面优化，提供左右并排（Side-by-side）或行内（Inline）视图选项
2. 增强事务回滚功能，允许用户在操作历史中进行多步撤销
3. 在文档导出前，提供可选的"AI校对"步骤

## Tasks / Subtasks
- [ ] Task 1: 设计和实现增强的Diff预览UI组件 (AC: 1)
  - [ ] 创建支持Side-by-side和Inline两种视图模式的Diff组件
  - [ ] 实现视图模式切换的用户界面控件
  - [ ] 优化Diff内容的语法高亮和可读性
  - [ ] 添加Diff导航功能（跳转到上/下一个变更）
- [ ] Task 2: 扩展事务系统以支持多步回滚 (AC: 2)
  - [ ] 扩展现有的事务审计日志以支持历史记录浏览
  - [ ] 实现多步撤销的用户界面（操作历史列表）
  - [ ] 添加选择性回滚功能（回滚到指定的历史点）
  - [ ] 确保回滚操作的数据一致性和安全性
- [ ] Task 3: 集成AI校对功能到导出流程 (AC: 3)
  - [ ] 在导出对话框中添加"AI校对"选项
  - [ ] 实现导出前的AI校对建议生成
  - [ ] 提供校对建议的预览和应用界面
  - [ ] 集成校对结果到导出流程中
- [ ] Task 4: 测试和验证
  - [ ] 编写Diff预览组件的UI测试
  - [ ] 编写多步回滚功能的集成测试
  - [ ] 编写AI校对功能的端到端测试
  - [ ] 验证用户体验和界面响应性

## Dev Notes

### Previous Story Insights
从 Story 4.0 学到的关键经验：
- 性能优化的后台处理机制为复杂UI操作提供了基础，Diff预览可以利用异步处理避免界面卡顿
- 事务系统和审计日志已经建立，可以扩展用于多步回滚的历史记录管理
- 缓存机制可以用于优化重复的Diff计算和AI校对操作

从 Story 3.0-3.1 学到的关键经验：
- 事务管理系统已经实现，包含`begin_transaction()`, `commit_transaction()`, `rollback_transaction()`
- 审计日志系统通过`get_audit_log()`提供操作历史，可以作为多步回滚的数据基础
- `setDocText`和`applySuggestion`已经支持Diff预览（`apply=False`），可以扩展为更丰富的预览界面

### 架构约束和设计原则
- **严格遵守分层**: `ai` 包不能有任何 `from novelwriter.gui import ...` 的语句 [Source: docs/architecture/增强功能影响分析.md#新增功能必须遵守的设计标准]
- **使用信号/槽**: `ai_copilot` 与 `gui` 之间的通信必须通过信号/槽，特别是Diff预览和回滚操作的状态更新 [Source: docs/architecture/增强功能影响分析.md#新增功能必须遵守的设计标准]
- **可配置与可禁用**: Diff预览选项和AI校对功能必须可以通过 `AIConfig` 配置 [Source: docs/architecture/增强功能影响分析.md#新增功能必须遵守的设计标准]

### 技术实现细节

#### 增强的Diff预览组件 [Source: docs/architecture/源码树与模块组织.md]
- 文件位置: `novelwriter/extensions/ai_copilot/diff_viewer.py` (新建)
- 基于PyQt6的`QTextEdit`或`QPlainTextEdit`实现，支持富文本格式的Diff显示
- 实现Side-by-side模式：使用`QSplitter`分割原文和修改后文本的并排显示
- 实现Inline模式：在单一视图中显示增删改的行内标记
- 集成语法高亮：利用novelWriter现有的语法高亮系统

#### 多步回滚的历史管理 [Source: docs/architecture/源码树与模块组织.md]
- 扩展文件: `novelwriter/ai/api.py` (修改，添加历史管理功能)
- 新建文件: `novelwriter/ai/history.py` (新建，专门处理操作历史)
- 利用现有的`get_audit_log()`接口，扩展为可导航的历史视图
- 实现历史点的快照管理，确保回滚操作可以准确恢复到任意历史状态
- 设计历史压缩机制，避免历史记录过度增长影响性能

#### AI校对集成到导出流程
- 修改文件: `novelwriter/dialogs/` 下的导出对话框 (修改)
- 新建文件: `novelwriter/ai/proofreading.py` (新建)
- 在导出流程中添加可选的AI校对步骤，利用现有的AI Provider架构
- 实现校对建议的批量处理和应用机制
- 设计校对结果的用户审核界面

#### UI组件集成 [Source: docs/architecture/源码树与模块组织.md]
- Diff预览组件集成到AI Copilot面板中
- 历史回滚界面作为独立对话框或面板标签页
- 确保所有UI组件遵循novelWriter的主题系统和样式指南

### 文件位置 [Source: docs/architecture/源码树与模块组织.md]
- Diff预览组件: `novelwriter/extensions/ai_copilot/diff_viewer.py` (新建)
- 历史管理: `novelwriter/ai/history.py` (新建)
- AI校对: `novelwriter/ai/proofreading.py` (新建)
- API扩展: `novelwriter/ai/api.py` (修改，添加历史和校对支持)
- UI集成: `novelwriter/extensions/ai_copilot/` (修改现有组件)
- 导出集成: `novelwriter/dialogs/` (修改导出对话框)
- 测试文件: `tests/test_ai/test_diff_viewer.py` (新建)
- 测试文件: `tests/test_ai/test_history_management.py` (新建)
- 测试文件: `tests/test_ai/test_proofreading.py` (新建)

### Testing [Source: docs/source/technical/tests.rst]
测试策略遵循项目现有的pytest框架：
- 使用 `pytest` 和 `pytest-qt` 进行UI组件测试
- GUI测试需要考虑 `QT_QPA_PLATFORM=offscreen` 设置
- Diff预览组件需要测试不同文本大小和格式的处理能力
- 多步回滚需要测试复杂操作序列的一致性
- AI校对需要测试与导出流程的集成和错误处理
- 性能测试确保大型文档的Diff预览不会影响用户体验

### 技术约束
- Python 3.7+ 兼容性要求 [Source: docs/architecture/高层架构.md#当前技术栈-已验证]
- PyQt6>=6.4.0 依赖要求，充分利用PyQt6的富文本和布局功能 [Source: docs/architecture/高层架构.md#当前技术栈-已验证]
- 必须通过现有的可选依赖系统 `pip install novelWriter[ai]` 进行安装
- 遵循MVC + 分层架构模式 [Source: docs/architecture/高层架构.md#当前技术栈-已验证]

### 用户体验目标
- Diff预览界面应直观易懂，支持大型文档的快速浏览
- 历史回滚操作应提供清晰的预览，避免意外的数据丢失
- AI校对应无缝集成到现有的导出工作流程中
- 所有操作应提供适当的进度指示和取消机制

### 与现有功能的集成
- 利用Story 4.0的性能优化，确保Diff计算在后台线程执行
- 集成Story 3.0-3.1的事务和审计系统，确保所有操作可追溯
- 保持与现有AI Provider架构的兼容性
- 遵循现有的配置和主题系统

## Testing
- `pytest tests/test_ai/test_diff_viewer.py tests/test_ai/test_history_management.py tests/test_ai/test_proofreading.py`

## Change Log
| Date | Version | Description | Author |
| --- | --- | --- | --- |
| 2025-09-18 | 0.1 | Initial draft for Epic 3 Story 1 - Enhanced Diff Preview | Bob (Scrum Master) |

## Dev Agent Record
### Agent Model Used
*To be filled by Dev Agent*

### Debug Log References
*To be filled by Dev Agent*

### Completion Notes List
*To be filled by Dev Agent*

### File List
*To be filled by Dev Agent*

## QA Results
*To be filled by QA Agent*