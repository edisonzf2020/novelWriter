# Story 4.1: 增强的 Diff 预览与回滚体验

## Status
Approved

## Story
**As a** 经常使用 AI 修改功能的作者,
**I want** 获得更直观的 Diff 预览与可控的多步回滚流程,
**so that** 我可以安全地比较 AI 建议并在需要时恢复指定历史版本。

## Acceptance Criteria
1. Diff 预览界面提供 Side-by-side 与 Inline 两种视图，并在后台线程生成与渲染 Diff，确保 UI 始终响应。[Source: docs/prd.md#史诗-4-性能优化与用户体验提升]
2. 事务回滚界面支持浏览与回放多条 AI 操作历史，复用审计日志实现选择性回滚，且在回滚前显示预览 Diff。[Source: docs/stories/2.1.nwaiapi-write-ops.md]
3. 文档导出流程新增可选的 "AI 校对" 步骤，允许用户在导出前审阅与应用校对建议，默认关闭且可通过 `AIConfig` 配置。[Source: docs/brownfield-architecture.md#核心架构原则-源自-docstechnical]

## Tasks / Subtasks
- [ ] Task 1: 设计异步 Diff 预览组件 (AC: 1)
  - [ ] 在 `novelwriter/extensions/ai_copilot/diff_viewer.py` 中实现可切换 Side-by-side/Inline 模式的组件，复用 Story 4.0 的后台线程服务以避免主线程阻塞。[Source: docs/architecture/源码树与模块组织.md]
  - [ ] 为大文档 Diff 计算接入缓存与取消功能，确保用户切换视图或请求新 Diff 时不会堆积任务。[Source: docs/stories/4.0.performance-optimization.md]
  - [ ] 调整 `AICopilotDock` 信号/槽，实时更新 Diff 状态、进度与错误提示，并遵守分层约束。[Source: docs/architecture/增强功能影响分析.md#新增功能必须遵守的设计标准]
  - [ ] 编写 UI 与异步测试，覆盖视图切换、取消与错误分支。[Source: docs/source/technical/tests.rst]
- [ ] Task 2: 扩展事务历史与多步回滚 (AC: 2)
  - [ ] 在 `novelwriter/ai/history.py` 中实现操作时间线与分组展示，支持选择任意历史点预览 Diff。[Source: docs/prd.md#史诗-4-性能优化与用户体验提升]
  - [ ] 扩展 `NWAiApi` 审计条目，记录 Diff 摘要、Provider、耗时与缓存命中信息，保证回滚时可复用。[Source: docs/stories/4.0.performance-optimization.md]
  - [ ] 在 UI 中新增历史浏览对话框或面板页签，提供过滤、预览与回滚确认操作。[Source: docs/architecture/集成点与外部依赖.md#内部集成点]
  - [ ] 添加集成测试，验证多步回滚后文档状态与审计日志一致性。[Source: docs/source/technical/tests.rst]
- [ ] Task 3: 集成 AI 校对到导出流程 (AC: 3)
  - [ ] 在导出对话框中新增校对开关与预览面板，默认关闭并在缺失依赖时提示安装 `novelWriter[ai]`。[Source: docs/architecture/部署与运维指引.md]
  - [ ] 调用 `AIConfig` 配置并复用 Provider 能力检测，确保 Responses 与 Chat 端点均可生成校对建议。[Source: docs/stories/3.2.openai-official-sdk-integration.md]
  - [ ] 为校对建议提供应用/跳过与回滚记录，接入事务和缓存以便回放。[Source: docs/stories/2.1.nwaiapi-write-ops.md]
  - [ ] 编写端到端测试，验证导出流程在启用/禁用校对、Provider 缺失、网络失败等场景的表现。[Source: docs/source/technical/tests.rst]
- [ ] Task 4: 用户体验与 QA 验证 (AC: 1,2,3)
  - [ ] 收集 Diff 渲染耗时、回滚完成时间、校对命中率等指标并写入 `.ai/debug-log.md`。[Source: docs/architecture/部署与运维指引.md]
  - [ ] 评估与记录大文档下的 UI 响应情况，确保响应 <100ms 且取消操作在 500ms 内生效。[Source: docs/AI/AI_ASSISTANT_PLAN.md#14-成功指标与性能要求]
  - [ ] 更新 QA 回归清单，加入 Diff/回滚/导出校对的手动与自动测试说明。[Source: docs/architecture/部署与运维指引.md]
  - [ ] 准备用户文档或内置提示，解释 Diff 视图切换、历史浏览与校对开关的使用方式。[Source: docs/prd.md#史诗-4-性能优化与用户体验提升]

## Dev Notes

### Previous Story Insights
- Story 4.0 提供的异步执行、性能日志与缓存能力是 Diff 生成与历史查看的基础，必须直接复用线程池与指标采集接口。[Source: docs/stories/4.0.performance-optimization.md]
- Story 3.2 中官方 SDK Provider 的输入转换与降级策略需要在 Diff 预览和校对场景下保持一致，以防再次出现 `input` 类型错误。[Source: docs/stories/3.2.openai-official-sdk-integration.md]
- Story 2.1 的事务与审计日志实现已包含 Diff 与建议缓存，可扩展为多步回滚的时间线数据源。[Source: docs/stories/2.1.nwaiapi-write-ops.md]

### Data Models
- `Suggestion`、`TransactionRecord` 与审计日志条目需扩展元数据字段，承载 Diff 视图模式与校对来源。[Source: docs/brownfield-architecture.md#核心架构原则-源自-docstechnical]
- 校对结果可复用 `ProviderCapabilities` 提供的模型描述，避免在 UI 层硬编码模型信息。[Source: docs/stories/3.1.api-endpoint-capability-detection.md]

### API Specifications
- `NWAiApi.previewSuggestion` 与 `applySuggestion` 应保持干净的异步契约，将 Diff 生成交由线程池，回滚时需在事务内执行并记录指标。[Source: docs/stories/2.1.nwaiapi-write-ops.md]
- 校对调用需根据能力检测选择 Responses 或 Chat 端点，并在审计日志中注明路径与耗时。[Source: docs/stories/3.2.openai-official-sdk-integration.md]

### Component Specifications
- `AICopilotDock` 须通过信号/槽更新 Diff 组件和历史面板，禁止直接访问 `ai` 包内部对象。[Source: docs/architecture/增强功能影响分析.md#新增功能必须遵守的设计标准]
- 导出对话框需以插件化方式引入校对面板，保持对未安装 AI 依赖的友好降级体验。[Source: docs/brownfield-architecture.md#核心架构原则-源自-docstechnical]

### File Locations
- Diff 组件: `novelwriter/extensions/ai_copilot/diff_viewer.py` (新建/扩展)。[Source: docs/architecture/源码树与模块组织.md]
- 历史管理: `novelwriter/ai/history.py` 与 `novelwriter/ai/api.py` (扩展)。[Source: docs/architecture/源码树与模块组织.md]
- 导出对话框与校对: `novelwriter/dialogs/export_dialog.py` 及相关 UI 模块 (修改)。[Source: docs/architecture/集成点与外部依赖.md#内部集成点]
- 测试: `tests/test_ai/test_history_management.py`, `tests/test_ai/test_proofreading.py`, `tests/test_gui/test_diff_viewer.py`, `tests/test_gui/test_export_proofreading.py` (新建/更新)。[Source: docs/source/technical/tests.rst]

### Testing Requirements
- 使用 `pytest-qt` 验证 Diff UI 与历史面板的交互，必要时设置 `QT_QPA_PLATFORM=offscreen`。[Source: docs/source/technical/tests.rst]
- 针对校对流程编写网络失败、超时、依赖缺失的回归测试，并记录对调试日志的断言。[Source: docs/architecture/部署与运维指引.md]

### Technical Constraints
- 保持分层架构，`ai` 包不得依赖 `gui`；所有新功能必须可通过 `AIConfig` 禁用。[Source: docs/architecture/增强功能影响分析.md#新增功能必须遵守的设计标准]
- 继续支持 Python 3.7+ 与 PyQt6>=6.4.0，Diff 渲染应兼容现有主题与国际化设置。[Source: docs/architecture/高层架构.md]

### Project Structure Notes
- 新增/扩展文件位于 `novelwriter/ai/` 与 `novelwriter/extensions/ai_copilot/`，与既有结构一致；导出对话框改动需遵守 `gui` 层模块边界。[Source: docs/brownfield-architecture.md#源码树与模块组织]

## Testing
- `pytest tests/test_gui/test_diff_viewer.py tests/test_ai/test_history_management.py tests/test_ai/test_proofreading.py tests/test_gui/test_export_proofreading.py`

## Dev Agent Record
### Agent Model Used
*To be filled by Dev Agent*

### Debug Log References
*To be filled by Dev Agent*

### Completion Notes List
*To be filled by Dev Agent*

### File List
*To be filled by Dev Agent*

## QA Results
*To be filled by QA Agent*