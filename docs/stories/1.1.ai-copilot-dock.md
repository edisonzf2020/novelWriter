# Story 1.1: AI Copilot 面板的无缝集成

## Status
Done

## Story
**As an** novelWriter 作者,
**I want** 在主界面右侧看到可停靠的 AI Copilot 面板,
**so that** 我能在不离开写作环境的情况下与 AI 辅助工具交互。

## Acceptance Criteria
1. 应用启动后默认在右侧停靠一个名为 “AI Copilot” 的 `QDockWidget` 面板。[Source: prd/第一部分p0-基础框架与只读-api.md#用户故事-11-ai-copilot-面的无缝集成]
2. 面板支持用户手动折叠、展开、分离并重新停靠，符合 Qt Dock 行为。[Source: prd/第一部分p0-基础框架与只读-api.md#用户故事-11-ai-copilot-面的无缝集成]
3. 面板 UI 自动遵循当前主题与 i18n 规则（包括 Dock 标题与占位文本）。[Source: prd/第一部分p0-基础框架与只读-api.md#用户故事-11-ai-copilot-面的无缝集成][Source: docs/AI/AI_ASSISTANT_PLAN.md#4-ui右侧-copilot-面板]
4. 在缺少 AI 可选依赖（或配置禁用）时，主程序正常启动且面板不加载或显示友好提示，不影响其他功能。[Source: prd/第一部分p0-基础框架与只读-api.md#用户故事-11-ai-copilot-面的无缝集成][Source: docs/AI/AI_ASSISTANT_PLAN.md#2-1-目录与命名]

## Tasks / Subtasks
- [x] 创建 `novelwriter/extensions/ai_copilot/__init__.py` 暴露 Dock 与集成入口，保持包结构与命名符合架构规划。(AC: 1) [Source: docs/AI/AI_ASSISTANT_PLAN.md#2-1-目录与命名]
- [x] 实现 `novelwriter/extensions/ai_copilot/dock.py`，提供 `AICopilotDock(QDockWidget)`：设置 objectName、窗口标题、可停靠区域与功能，并创建遵循主题和 i18n 的占位内容。(AC: 1,2,3) [Source: docs/AI/AI_ASSISTANT_PLAN.md#4-ui右侧-copilot-面板][Source: novelwriter/guimain.py:200]
  - [x] 在 Dock 内检测 AI 依赖状态（如缺少 provider/配置），展示友好不可用提示而非抛出异常。(AC: 4) [Source: docs/AI/AI_ASSISTANT_PLAN.md#4-ui右侧-copilot-面板]
- [x] 实现 `novelwriter/extensions/ai_copilot/integration.py` 中的 `MainWindowIntegration.integrate_ai_dock(main_window)`，确保幂等调用、失败日志与 i18n 支持。(AC: 1,2,4) [Source: docs/AI/AI_ASSISTANT_PLAN.md#主窗口安全集成推荐]
- [x] 在 `GuiMain` 初始化流程调用 `MainWindowIntegration.integrate_ai_dock(self)`，让面板在中央部件构建后默认停靠右侧。(AC: 1) [Source: novelwriter/guimain.py:180]
- [x] 新增 GUI 冒烟测试（如 `tests/test_gui/test_gui_ai_copilot.py`），使用 `nwGUI` fixture 验证 Dock 自动挂载、标题可翻译、缺失依赖时仍安全加载。(AC: 2,3,4) [Source: tests/conftest.py:68]

## Dev Notes

### Previous Story Insights
- Story 0.2 完成只读 API，为 Copilot 面板提供项目上下文；Dock 仅需调用 `NWAiApi` 时再注入，当前可展示占位状态。[Source: docs/stories/0.2.nwaiapi-read-only.md]
- 现有 pytest-qt fixture（`nwGUI`、`mockGUIwithTheme` 等）可直接用于验证 Dock 行为及主题联动。[Source: tests/conftest.py:101]

### UI & Integration Guidance
- AI 计划建议在 `extensions/ai_copilot/` 中实现 Dock + Integration 薄层，并通过 `MainWindowIntegration.integrate_ai_dock` 连接主窗体。[Source: docs/AI/AI_ASSISTANT_PLAN.md#2-1-目录与命名][Source: docs/AI/AI_ASSISTANT_PLAN.md#主窗口安全集成推荐]
- Dock 默认停靠右侧，需启用可折叠/可分离特性，保持主题与翻译一致；可使用 `main_window.tr()` 与 `SHARED.theme` 提供颜色/图标。[Source: docs/AI/AI_ASSISTANT_PLAN.md#4-ui右侧-copilot-面板]
- 集成失败时不得阻塞启动，应捕获异常并记录日志，遵循计划中的“失败静默跳过”原则。[Source: docs/AI/AI_ASSISTANT_PLAN.md#主窗口安全集成推荐]

### Optional Dependencies & Configuration
- 在可选依赖缺失（如未来的 provider 库或 `CONFIG.ai` 未启用）时，Dock 应显示不可用提示或直接跳过加载，避免破坏 GUI。[Source: prd/第一部分p0-基础框架与只读-api.md#用户故事-11-ai-copilot-面的无缝集成][Source: docs/AI/AI_ASSISTANT_PLAN.md#7-配置与可选依赖]
- 当前尚未实现 `AIConfig` 行为，需以防御式代码检测配置属性存在性，后续故事会补充真实配置逻辑。[Source: docs/AI/AI_ASSISTANT_PLAN.md#7-1-ai-配置解耦]

### File Locations
- 新建 `novelwriter/extensions/ai_copilot/`（含 `__init__.py`, `integration.py`, `dock.py`）；必要时在 `novelwriter/extensions/__init__` 等导出位置登记模块，以保持包可发现性。[Source: docs/architecture/源码树与模块组织.md#项目结构-集成后]
- GUI 主窗体更新集中在 `novelwriter/guimain.py`，需保持现有布局（`splitMain` + `mainStack`）不受 Dock 影响，仅新增 `addDockWidget` 与状态记录。[Source: novelwriter/guimain.py:180]
- 测试位于 `tests/test_gui/`，建议新增 `test_gui_ai_copilot.py` 验证 Dock 集成与降级提示。[Source: docs/AI/AI_ASSISTANT_PLAN.md#5-目录与命名]

### Testing
- 已运行 `QT_QPA_PLATFORM=offscreen pytest tests/test_gui/test_gui_ai_copilot.py` 并全部通过
- 建议后续在回归阶段复跑 `tests/test_gui/test_gui_guimain.py` 确认主窗体无回归

## Change Log
| Date | Version | Description | Author |
| --- | --- | --- | --- |
| 2025-09-16 | 0.2 | Delivered AI Copilot dock integration与测试 | Codex (Developer) |
| 2025-09-17 | 0.1 | Initial draft | Codex (Scrum Master) |

## Dev Agent Record
### Agent Model Used
- Codex (GPT-5)

### Debug Log References
- `QT_QPA_PLATFORM=offscreen pytest tests/test_gui/test_gui_ai_copilot.py`

### Completion Notes List
- 新增 `novelwriter/extensions/ai_copilot/` 扩展包并实现 Dock 占位 UI 与防御式依赖检测
- 通过 `MainWindowIntegration.integrate_ai_dock` 在 `GuiMain` 构造流程中默认挂载 Dock，确保幂等
- 增补 GUI 冒烟测试验证 Dock 加载、禁用提示及多次集成场景

### File List
- novelwriter/guimain.py
- novelwriter/extensions/ai_copilot/__init__.py
- novelwriter/extensions/ai_copilot/dock.py
- novelwriter/extensions/ai_copilot/integration.py
- tests/test_gui/test_gui_ai_copilot.py

## QA Results
- **PASS** Dock 默认集成到右侧并保持 Qt Dock 行为，主题/翻译更新与禁用降级逻辑符合 AC（参考 novelwriter/extensions/ai_copilot/dock.py:25 与 novelwriter/guimain.py:211）。
- **Risk** AI 可用性仅在 Dock 构造时检测，后续偏好设置切换仍需依赖后续故事处理刷新流程。
- **Testing** `QT_QPA_PLATFORM=offscreen pytest tests/test_gui/test_gui_ai_copilot.py`（4 passed in 0.54s）。
