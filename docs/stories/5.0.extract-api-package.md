# Story 5.0: 提取 `NWAiApi` 到独立的 `api` 包

## Status
Approved

## Story
**As a** novelWriter 的核心开发者,
**I want** 将 `NWAiApi` 重构为一个独立的 `novelwriter.api` 包,
**so that** 实现更好的关注点分离，提升模块的可重用性，并为未来的插件系统或第三方集成打下坚实的基础。

## Acceptance Criteria
1. `novelwriter/ai/api.py` 被移动到 `novelwriter/api/api.py`，保持完整的 API 接口不变。[Source: docs/prd.md#史诗-5-架构重构与优化]
2. 所有之前 `from novelwriter.ai.api import NWAiApi` 的引用都已更新为 `from novelwriter.api import NWAiApi`，确保向后兼容性。[Source: docs/prd.md#史诗-5-架构重构与优化]
3. `novelwriter.ai` 包不再包含 `api.py`，AI 模块单向依赖于新的 `api` 模块，符合分层架构原则。[Source: docs/architecture/核心架构原则-源自-docstechnical.md]
4. 所有现有测试（尤其是 AI 相关的测试）都能成功通过，证明重构未破坏现有功能。[Source: docs/prd.md#史诗-5-架构重构与优化]

## Tasks / Subtasks
- [ ] Task 1: 创建新的 `api` 包结构 (AC: 1, 3)
  - [ ] 在 `novelwriter/` 下创建新的 `api/` 目录和 `__init__.py` 文件，遵循现有包结构约定。[Source: docs/architecture/源码树与模块组织.md]
  - [ ] 将 `novelwriter/ai/api.py` 移动到 `novelwriter/api/api.py`，保持文件内容完全不变。[Source: docs/prd.md#史诗-5-架构重构与优化]
  - [ ] 在 `novelwriter/api/__init__.py` 中导出 `NWAiApi` 类，确保 `from novelwriter.api import NWAiApi` 可用。[Source: docs/architecture/核心架构原则-源自-docstechnical.md]
  - [ ] 更新 `novelwriter/ai/__init__.py`，移除对 `api.py` 的任何引用或导出。[Source: docs/architecture/源码树与模块组织.md]
- [ ] Task 2: 更新所有模块引用 (AC: 2, 3)
  - [ ] 搜索并更新 `novelwriter/ai/` 目录下所有 Python 文件中的 `from .api import` 引用为 `from ..api import`。[Source: docs/architecture/核心架构原则-源自-docstechnical.md]
  - [ ] 更新 `novelwriter/extensions/ai_copilot/` 目录下所有文件中的 API 引用路径。[Source: docs/architecture/源码树与模块组织.md]
  - [ ] 更新 `novelwriter/gui/main_window.py` 和其他 GUI 模块中可能存在的直接 API 引用。[Source: docs/architecture/集成点与外部依赖.md]
  - [ ] 检查并更新 `novelwriter/core/` 和其他核心模块中的任何 API 引用。[Source: docs/architecture/核心架构原则-源自-docstechnical.md]
- [ ] Task 3: 更新测试文件引用 (AC: 4)
  - [ ] 更新 `tests/test_ai/` 目录下所有测试文件中的 API 导入语句，从 `from novelwriter.ai.api` 改为 `from novelwriter.api`。[Source: docs/prd.md#史诗-5-架构重构与优化]
  - [ ] 更新 `tests/test_gui/` 目录下涉及 AI 功能的测试文件中的 API 引用。[Source: docs/architecture/核心架构原则-源自-docstechnical.md]
  - [ ] 检查并更新 `tests/test_core/` 和其他测试目录中可能存在的 API 引用。[Source: docs/prd.md#史诗-5-架构重构与优化]
  - [ ] 运行完整测试套件确认所有测试通过：`pytest tests/test_ai/ tests/test_gui/test_ai* tests/test_core/`。[Source: docs/prd.md#史诗-5-架构重构与优化]
- [ ] Task 4: 文档和配置更新 (AC: 1, 2, 3)
  - [ ] 更新 `docs/architecture/源码树与模块组织.md` 中的项目结构图，反映新的 `api/` 包位置。[Source: docs/architecture/源码树与模块组织.md]
  - [ ] 检查并更新 `pyproject.toml` 或 `setup.cfg` 中可能存在的 API 包引用。[Source: docs/architecture/核心架构原则-源自-docstechnical.md]
  - [ ] 更新开发者文档或注释中提及 API 位置的部分，确保新开发者能正确理解模块结构。[Source: docs/architecture/快速参考-关键文件和入口点.md]
  - [ ] 验证在没有安装 AI 可选依赖的情况下，应用仍能正常启动并显示友好的降级体验。[Source: docs/architecture/核心架构原则-源自-docstechnical.md]

## Dev Notes

### Previous Story Insights
- Story 4.1 的实现显示了 AI 功能模块的成熟度和稳定性，为架构重构提供了良好的基础，所有核心功能都有完整的测试覆盖。[Source: docs/stories/4.1.enhanced-diff-preview.md]
- 当前的 `NWAiApi` 实现已经具备了完整的事务、审计、缓存等功能，重构时需要保持这些核心能力不受影响。[Source: docs/stories/2.1.nwaiapi-write-ops.md]
- 现有的 Provider 系统和配置管理都依赖于 `NWAiApi`，移动时需要确保这些依赖关系正确更新。[Source: docs/stories/3.2.openai-official-sdk-integration.md]

### Data Models
- `NWAiApi` 中定义的所有数据模型（如 `DocumentRef`, `TextRange`, `Suggestion`, `TransactionRecord` 等）需要保持在 API 层，不得分散到其他包中。[Source: docs/architecture/核心架构原则-源自-docstechnical.md]
- 现有的审计日志和事务相关的数据结构必须随 API 一起移动，保持数据模型的内聚性。[Source: docs/stories/2.1.nwaiapi-write-ops.md]

### API Specifications
- 新的 `novelwriter.api` 包必须暴露与原 `novelwriter.ai.api` 完全相同的公共接口，确保现有调用者无需修改业务逻辑。[Source: docs/prd.md#史诗-5-架构重构与优化]
- `NWAiApi` 的所有方法签名、异常类型和返回值必须保持不变，只改变包的组织结构。[Source: docs/architecture/核心架构原则-源自-docstechnical.md]

### Component Specifications
- `novelwriter.ai` 包重构后将专注于 AI Provider、配置管理和辅助工具，不再包含核心 API 接口。[Source: docs/architecture/源码树与模块组织.md]
- `extensions/ai_copilot/` 中的 UI 组件将通过 `from novelwriter.api import NWAiApi` 访问 API，保持与 GUI 层的清晰分离。[Source: docs/architecture/核心架构原则-源自-docstechnical.md]

### File Locations
- 新包结构: `novelwriter/api/__init__.py`, `novelwriter/api/api.py` (从 `novelwriter/ai/api.py` 移动)。[Source: docs/architecture/源码树与模块组织.md]
- 需要更新引用的主要文件: `novelwriter/ai/*.py`, `novelwriter/extensions/ai_copilot/*.py`, `tests/test_ai/*.py`, `tests/test_gui/test_ai*.py`。[Source: docs/architecture/源码树与模块组织.md]
- 配置和文档文件: `docs/architecture/源码树与模块组织.md`, 可能包括 `pyproject.toml` 或 `setup.cfg`。[Source: docs/architecture/快速参考-关键文件和入口点.md]

### Testing Requirements
- 必须运行完整的测试套件（包括 AI、GUI 和核心测试）确保重构未破坏任何现有功能。[Source: docs/prd.md#史诗-5-架构重构与优化]
- 特别关注 `tests/test_ai/test_api.py` 等直接测试 API 功能的测试文件，确保导入路径正确更新。[Source: docs/architecture/核心架构原则-源自-docstechnical.md]
- 验证在可选依赖缺失情况下的降级行为，确保重构未影响应用的可选依赖处理机制。[Source: docs/architecture/核心架构原则-源自-docstechnical.md]

### Technical Constraints
- 严格遵循分层架构原则，新的 `api` 包不得依赖 `gui` 或 `ai` 包，只能依赖 `core` 和 `formats` 等基础层。[Source: docs/architecture/核心架构原则-源自-docstechnical.md]
- 保持对 Python 3.7+ 的兼容性，重构不得引入新的语言特性或依赖要求。[Source: docs/architecture/高层架构.md]
- 确保重构后的包结构支持现有的可选依赖机制，`api` 包本身不应依赖任何 AI 相关的可选依赖。[Source: docs/architecture/核心架构原则-源自-docstechnical.md]

### Project Structure Notes
- 重构完成后，项目将形成更清晰的依赖层次：`core` ← `api` ← `ai` ← `extensions/ai_copilot`，每层单向依赖下层。[Source: docs/architecture/源码树与模块组织.md]
- 新的 `api` 包将成为未来插件系统或第三方集成的标准接口，为 novelWriter 的可扩展性奠定基础。[Source: docs/prd.md#史诗-5-架构重构与优化]

## Testing
- `pytest tests/test_ai/ tests/test_gui/test_ai* tests/test_core/ -v --tb=short`
- `source /Users/fanmac/AI/novelWriter/writer/bin/activate && export QT_SCALE_FACTOR=1 && pytest --compat-env-file=test.env`

## Dev Agent Record
### Agent Model Used
[待填写]

### Debug Log References
[待填写]

### Completion Notes List
[待填写]

### File List
[待填写]