# Story 1.6: 安全控制和权限管理

## Status
Approved

## Story
**As a** 系统管理员，
**I want** 确保所有工具调用都经过安全验证和审计，
**so that** 我就能够控制访问权限并跟踪所有操作记录。

## Acceptance Criteria
1. 在`NovelWriterAPI`集成权限验证机制
2. 实现参数清理和注入攻击防护
3. 建立完整的审计日志系统，记录所有工具调用
4. 实现数据敏感性分级和屏蔽机制
5. 建立外部工具的资源使用限制

## Tasks / Subtasks

- [ ] Task 1: 权限验证机制实现 (AC: 1)
  - [ ] 扩展NovelWriterAPI中现有的权限控制装饰器系统
  - [ ] 实现基于角色的访问控制（RBAC）框架
  - [ ] 创建权限级别枚举（READ, WRITE, ADMIN, TOOL_CALL）
  - [ ] 建立API方法和工具调用的权限映射关系
  - [ ] 集成安全上下文管理，支持会话级权限检查

- [ ] Task 2: 参数清理和防护机制 (AC: 2)
  - [ ] 实现输入参数的SQL注入防护
  - [ ] 建立XSS攻击防护机制
  - [ ] 创建参数白名单验证系统
  - [ ] 实现路径遍历攻击防护
  - [ ] 添加恶意代码检测和隔离机制

- [ ] Task 3: 完整审计日志系统 (AC: 3)
  - [ ] 设计审计日志数据模型和Schema
  - [ ] 实现结构化日志记录器（JSON格式）
  - [ ] 建立日志轮转和归档机制
  - [ ] 创建审计事件分类系统（操作类型、风险级别）
  - [ ] 实现日志完整性验证和防篡改机制

- [ ] Task 4: 数据敏感性分级和屏蔽 (AC: 4)
  - [ ] 建立数据敏感性分级标准（PUBLIC, INTERNAL, CONFIDENTIAL, SECRET）
  - [ ] 实现敏感数据自动检测和标记
  - [ ] 创建数据屏蔽和匿名化机制
  - [ ] 建立日志中敏感信息的自动过滤
  - [ ] 实现数据访问权限的细粒度控制

- [ ] Task 5: 外部工具资源使用限制 (AC: 5)
  - [ ] 实现API调用频率限制（Rate Limiting）
  - [ ] 建立资源使用配额管理（内存、CPU、网络）
  - [ ] 创建工具调用超时和中断机制
  - [ ] 实现并发调用数量限制
  - [ ] 建立资源使用监控和告警系统

- [ ] Task 6: 安全配置管理界面 (AC: 1, 4, 5)
  - [ ] 扩展AI设置对话框，添加"安全设置"配置页面
  - [ ] 实现权限级别配置和管理界面
  - [ ] 建立审计日志查看和过滤功能
  - [ ] 添加资源限制配置界面
  - [ ] 遵循现有PyQt6主题和国际化规范

- [ ] Task 7: 安全测试和验证 (AC: 所有)
  - [ ] 创建安全控制专项测试套件
  - [ ] 实现渗透测试和漏洞扫描
  - [ ] 验证权限控制的正确性和完整性
  - [ ] 测试审计日志的准确性和完整性
  - [ ] 验证资源限制的有效性和可靠性

- [ ] Task 8: 性能优化和监控集成 (AC: 1, 3)
  - [ ] 优化权限检查的性能开销（目标<1ms）
  - [ ] 实现安全控制的异步处理机制
  - [ ] 集成性能监控到SecurityController
  - [ ] 建立安全事件的实时告警系统
  - [ ] 创建安全指标的仪表板显示

## Dev Notes

### Previous Story Insights
基于Story 1.1-1.5的关键成果和安全基础：
- ✅ `NovelWriterAPI`: 已有基础权限控制装饰器（@requiresWritePermission等）可扩展
- ✅ `MCPServer`: MCP工具路由系统已就位，需要集成安全验证层
- ✅ `ExternalMCPManager`: 外部工具调用系统已实现，需要资源限制机制
- ✅ `PerformanceMonitor`: 性能监控基础设施可扩展支持安全指标
- ✅ 现有装饰器模式: 可以复用和扩展现有的装饰器架构

### Data Models [Source: mcp-hybrid-architecture.md#5.1]
安全控制需要实现的核心数据模型：

```python
class SecurityPermission(Enum):
    """权限级别枚举"""
    READ = "read"
    WRITE = "write"
    ADMIN = "admin"
    TOOL_CALL = "tool_call"
    EXTERNAL_TOOL = "external_tool"

class AuditLogEntry(BaseModel):
    """审计日志条目"""
    timestamp: datetime
    user_context: str
    operation: str
    resource: str
    permission_required: SecurityPermission
    result: Literal["allowed", "denied", "error"]
    parameters: Dict[str, Any]  # 已清理的参数
    execution_time_ms: int
    risk_level: Literal["low", "medium", "high", "critical"]

class SecurityContext(BaseModel):
    """安全上下文"""
    session_id: str
    permissions: List[SecurityPermission]
    resource_quotas: Dict[str, int]
    current_usage: Dict[str, int]
    last_activity: datetime
    trusted_sources: List[str]
```

### API Specifications [Source: mcp-hybrid-architecture.md#7.2]
安全控制的API接口设计：

**审计日志查询接口**：
```http
GET /api/security/audit-logs
{
  "filters": {
    "start_time": "2025-09-25T00:00:00Z",
    "end_time": "2025-09-25T23:59:59Z",
    "operation": "tool_call",
    "risk_level": "high"
  },
  "pagination": {
    "page": 1,
    "size": 50
  }
}
```

**权限验证接口**：
```http
POST /api/security/validate-permission
{
  "operation": "external_tool_call",
  "resource": "time-service:get_current_time",
  "context": {
    "session_id": "sess_123",
    "source": "local"
  }
}
```

### Component Specifications [Source: mcp-hybrid-architecture.md#6.2]
基于架构设计的安全控制组件规范：

```
novelwriter/api/base/security.py - 安全控制器主实现
├── SecurityController          # 主安全控制类
├── PermissionValidator         # 权限验证器
├── ParameterSanitizer         # 参数清理器
├── AuditLogger                # 审计日志记录器
├── DataClassifier             # 数据敏感性分类器
├── ResourceLimiter            # 资源使用限制器
└── SecurityDecorators         # 安全装饰器集合
```

**集成点与现有组件**：
- **NovelWriterAPI扩展**: 集成SecurityController到所有API方法
- **MCPServer路由**: 在工具调用前后添加安全验证和审计
- **ExternalMCPManager**: 集成资源限制和使用监控
- **PerformanceMonitor**: 扩展支持安全性能指标收集

### File Locations [Source: mcp-hybrid-architecture.md#8.2]
基于统一API中间层架构的精确文件位置：
- 安全控制器: `novelwriter/api/base/security.py`
- 安全数据模型: `novelwriter/api/models.py` (扩展现有)
- 安全配置管理: `novelwriter/api/base/config.py` (扩展现有)
- 审计日志管理: `novelwriter/api/base/audit.py` (新增)
- UI安全设置: `novelwriter/dialogs/security_settings.py` (新增)
- 测试文件: `tests/test_api/test_security.py`

### Testing Requirements [Source: mcp-hybrid-architecture.md#10.3]
安全控制的测试策略：
- **单元测试**: 权限验证、参数清理、审计日志的独立功能测试
- **集成测试**: 安全控制与现有API系统的完整集成测试
- **性能测试**: 安全验证开销<1ms的性能要求验证
- **安全测试**: 渗透测试、注入攻击防护、权限绕过尝试测试
- **压力测试**: 高并发场景下安全控制的稳定性测试

### Technical Constraints [Source: mcp-hybrid-architecture.md#9.3]
安全控制的技术约束和要求：
- **性能要求**: 权限验证延迟<1ms，审计日志记录<0.5ms
- **兼容性要求**: 与现有权限装饰器完全兼容，零破坏性集成
- **存储要求**: 审计日志支持轮转，默认保留30天，可配置
- **安全标准**: 遵循OWASP安全最佳实践，支持GDPR合规
- **可扩展性**: 支持自定义权限级别，插件化安全策略

### Security Standards [Source: OWASP最佳实践]
基于行业标准的安全实现要求：
- **认证机制**: 支持多因素认证，会话管理和超时控制
- **授权控制**: 基于角色的访问控制（RBAC），最小权限原则
- **数据保护**: 传输加密（TLS），存储加密，敏感数据屏蔽
- **审计跟踪**: 完整的操作记录，防篡改，可追溯性
- **输入验证**: 白名单验证，参数清理，注入攻击防护

## Testing

#### 测试环境设置 [Source: mcp-hybrid-architecture.md#10.3]
```bash
# 1. 激活虚拟环境
source writer/bin/activate

# 2. 运行安全测试
export QT_SCALE_FACTOR=1 && pytest tests/test_api/test_security.py --compat-env-file=test.env

# 3. 运行渗透测试
pytest tests/test_security/ -v --cov=novelwriter/api/base/security
```

### Test file location
- 主测试文件: `tests/test_api/test_security.py`
- 权限测试文件: `tests/test_api/test_permissions.py`
- 审计日志测试: `tests/test_api/test_audit_logging.py`
- 安全UI测试: `tests/test_dialogs/test_security_settings.py`
- 渗透测试套件: `tests/test_security/test_penetration.py`

### Test standards [Source: mcp-hybrid-architecture.md#10.4]
- **测试框架**: pytest + pytest-security，支持安全测试扩展
- **Mock策略**: 创建恶意输入模拟器，模拟各种攻击场景
- **覆盖率要求**: >95%代码覆盖率，特别关注安全边界和异常处理
- **性能验证**: 权限验证P95延迟<1ms的基准测试

### Testing frameworks and patterns to use
```python
# 安全控制测试模式
@pytest.mark.security
def test_permission_validation_performance():
    """测试权限验证性能要求"""
    start_time = time.perf_counter()
    result = security_controller.validate_permission(
        SecurityPermission.TOOL_CALL, "test_resource"
    )
    duration = (time.perf_counter() - start_time) * 1000
    
    assert duration < 1.0  # <1ms requirement
    assert result.is_allowed is True

@pytest.mark.security
def test_sql_injection_protection():
    """测试SQL注入防护"""
    malicious_input = "'; DROP TABLE users; --"
    sanitized = parameter_sanitizer.sanitize(malicious_input)
    
    assert "DROP TABLE" not in sanitized
    assert malicious_input != sanitized

@pytest.mark.security
def test_audit_log_integrity():
    """测试审计日志完整性"""
    original_log = audit_logger.create_entry("test_operation")
    stored_log = audit_logger.retrieve_entry(original_log.id)
    
    assert audit_logger.verify_integrity(stored_log) is True
    assert stored_log.tamper_proof_hash is not None
```

### Specific testing requirements for this story
1. **权限控制测试**: 验证各种权限级别的正确实施和边界检查
2. **注入攻击防护测试**: 测试SQL注入、XSS、路径遍历等攻击防护
3. **审计日志完整性测试**: 验证日志记录的完整性和防篡改机制
4. **性能安全测试**: 验证安全控制在高负载下的性能和稳定性
5. **数据敏感性测试**: 验证敏感数据分级和屏蔽的准确性
6. **资源限制测试**: 验证外部工具资源使用限制的有效性
7. **配置安全测试**: 验证安全配置界面的安全性和易用性

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-25 | v1.0 | Initial story creation based on PRD v3.0 Epic 1 Story 1.6, following create-next-story task flow and architecture alignment | BMAD SM |