# Story 0.2: 实现 NWAiApi 只读项目与文档接口

## Status
Done

## Story
**As an** AI Copilot 运行时,
**I want** 通过 NWAiApi 读取项目元数据与文档内容,
**so that** 在生成建议前可以掌握准确的上下文而不修改用户项目。

## Acceptance Criteria
1. 实现 `getProjectMeta()`，返回包含项目标识、名称、作者、最近打开时间、字数统计等核心字段的不可变字典。[Source: prd/第一部分p0-基础框架与只读-api.md#用户故事-02-实现-api-的只读项目与文档接口]
2. 实现 `listDocuments(scope="all")`，根据可选范围返回 `DocumentRef` 列表，列表中仅包含活跃文档并按项目树顺序排序。[Source: prd/第一部分p0-基础框架与只读-api.md#用户故事-02-实现-api-的只读项目与文档接口]
3. 实现 `getCurrentDocument()`，在存在当前编辑文档时返回对应 `DocumentRef`，否则返回 `None`。[Source: prd/第一部分p0-基础框架与只读-api.md#用户故事-02-实现-api-的只读项目与文档接口]
4. 实现 `getDocText(handle)`，返回指定文档的纯文本内容，并在句柄无效时抛出 `NWAiApiError`。[Source: prd/第一部分p0-基础框架与只读-api.md#用户故事-02-实现-api-的只读项目与文档接口]
5. 为上述方法编写单元测试，覆盖成功与失败路径，保持类型注解与文档字符串完整。[Source: prd/第一部分p0-基础框架与只读-api.md#用户故事-02-实现-api-的只读项目与文档接口]

## Tasks / Subtasks
- [x] 完成 `getProjectMeta()`，聚合 `NWProject.data` 与 `NWProject` 属性（名称、作者、UUID、保存次数、`currentTotalCount`、`projOpened` 等），输出不可变浅拷贝并确保键名称与文档一致。(AC: 1) [Source: novelwriter/core/project.py][Source: novelwriter/core/projectdata.py]
- [x] 实现 `listDocuments(scope)`，遍历 `NWProject.tree` 过滤活跃 `nwItemType.FILE`，按 `scope` 映射到 `nwItemClass`（`all`/`novel`/`note` 等）生成 `DocumentRef`，并保证排序与项目树一致。(AC: 2) [Source: novelwriter/core/tree.py][Source: novelwriter/core/item.py]
  - [x] 对未知 scope 抛出 `NWAiApiError`，并保持接口向后兼容（默认 `all`）。(AC: 2) [Source: AI/AI_ASSISTANT_PLAN.md#52-接口清单-节选-apipy]
- [x] 实现 `getCurrentDocument()`，基于 `NWProject.data.lastHandle["editor"]` 或项目树校验句柄有效性，返回匹配的 `DocumentRef`，若无有效句柄则返回 `None`。(AC: 3) [Source: novelwriter/core/projectdata.py]
- [x] 完成 `getDocText(handle)`，调用 `NWProject.storage.getDocumentText` 获取内容，对不存在或非文本节点抛出 `NWAiApiError`，禁止副作用。(AC: 4) [Source: novelwriter/core/storage.py]
- [x] 扩充 `tests/test_ai`，新增只读接口测试（含 scope 过滤、无效句柄、当前文档缺省等），确保对 `NWAiApi` 的导入冒烟测试保持通过。(AC: 5) [Source: source/technical/tests.rst#running-tests]

## Dev Notes

### Previous Story Insights
- Story 0.1 已交付 `novelwriter/ai` 包骨架、`NWAiApi` stub 及数据模型导出，可直接在现有结构内补齐只读逻辑。[Source: docs/stories/0.1.nwaiapi-foundation.md]
- `tests/test_ai/test_api_imports.py` 已验证包的基本导入与对象实例化，新的只读测试需复用现有 fixture 体系防止回归。[Source: tests/test_ai/test_api_imports.py]

### Data Models
- `DocumentRef` 包含 `handle`, `name`, `parent` 三个字段；构造时应读取 `NWItem.itemHandle`, `itemName`, `itemParent` 并保持 `Optional[str]` 类型契约。[Source: novelwriter/ai/models.py][Source: novelwriter/core/item.py]
- `TextRange`、`Suggestion`、`BuildResult` 在本故事不直接修改，但 `getDocText` 需保持返回 `str`，以便后续建议与 Diff 逻辑消费。[Source: novelwriter/ai/models.py]

### API Specifications
- `getProjectMeta` 至少包含：`uuid`, `name`, `author`, `language`, `spellCheck`, `openedAt`, `saveCount`, `autoSaveCount`, `totalWords`, `totalCharacters`, `lastHandles`，并可扩展 `projectState` 等字段；返回值须为新的 `dict` 防止上层修改底层对象。[Source: prd/第一部分p0-基础框架与只读-api.md#用户故事-02-实现-api-的只读项目与文档接口]
- `listDocuments` 默认返回所有活跃文件，可按 `scope` 过滤：`novel` 对应 `nwItemClass.NOVEL`, `note` 对应 `nwItemClass.NOTE`, `outline` 对应 `nwItemClass.OUTLINE` 等；保持与项目树顺序一致，便于 UI 同步。[Source: AI/AI_ASSISTANT_PLAN.md#52-接口清单-节选-apipy]
- `getCurrentDocument` 使用 `NWProject.data.lastHandle["editor"]` 优先判断，必要时回退至 `NWTree` 校验；返回 `None` 时需保证调用方可安全处理。[Source: novelwriter/core/projectdata.py]
- `getDocText` 通过存储层快速读取 `.nwd` 内容；若句柄不存在或对应项目项非 `FILE`，应抛出 `NWAiApiError` 并保持错误消息清晰易于调试。[Source: novelwriter/core/storage.py]

### Core Integration Points
- 继续遵循分层原则：`novelwriter/ai/api.py` 仅可调用 `core`、`text`、`formats` 层，不得引用 `gui`。必要的全局对象通过 `NWProject` 提供。[Source: architecture/核心架构原则-源自-docstechnical.md#核心架构原则-源自-docstechnical]
- 项目结构信息可通过 `NWProject.tree` 和 `NWProject.data` 获取；`NWTree.__iter__` 会按可见顺序遍历 `NWItem`，应复用现有迭代逻辑而非手写文件扫描。[Source: novelwriter/core/tree.py]

### Error Handling
- 对非法 scope、无效句柄、缺少存储路径等情况统一抛出 `NWAiApiError`，并记录必要的上下文便于日志诊断；避免泄露底层异常细节给上层模型调用者。[Source: novelwriter/ai/errors.py]

### File Locations
- 主要修改 `novelwriter/ai/api.py`，必要时扩展 `novelwriter/ai/__init__.py` 以导出新增辅助函数；新增测试建议放在 `tests/test_ai/test_api_readonly.py` 或扩展现有测试文件。[Source: architecture/源码树与模块组织.md#项目结构-集成后]

### Testing Requirements
- 使用现有 pytest fixture（如 `projPath`, `mockGUI` 等）构造最小项目，验证不同 scope 返回值以及无效句柄异常；持续在命令行执行 `pytest tests/test_ai`，确保无 GUI 干扰时也能稳定运行。[Source: source/technical/tests.rst#running-tests]

### Technical Constraints
- 保持 API 方法的同步执行与纯只读语义，不得在内部修改项目状态；必要的缓存应在后续故事中实现，本故事仅聚焦正确性。[Source: architecture/增强功能影响分析.md#新增功能必须遵守的设计标准]
- 遵循项目代码风格：类型注解、文档字符串以及 logging 使用现有规范（logger 由调用方决定，NWAiApi 内不额外创建全局日志器）。[Source: code_style]

### Project Structure Notes
- 若需要新增测试数据，可放置在 `tests/files/` 下并通过 fixture 加载，避免污染真实项目目录；避免在故事实现中更改 `setup.cfg`/`pyproject.toml`。[Source: architecture/增强功能影响分析.md#需要修改的文件]

## Testing
- 在项目默认虚拟环境中运行 `writer/bin/python -m pytest tests/test_ai`（Qt offscreen 由 pytest-qt 处理），全部 12 项测试通过。[Source: source/technical/tests.rst#running-tests]

## Change Log
| Date | Version | Description | Author |
| --- | --- | --- | --- |
| 2025-09-16 | 0.1 | Initial draft | Codex (Scrum Master) |
| 2025-09-17 | 0.2 | Implemented read-only API methods and tests | Codex (Developer) |

## Dev Agent Record
### Agent Model Used
- Codex (GPT-5)

### Debug Log References
- writer/bin/python -m pytest tests/test_ai

### Completion Notes List
- 实现 `getProjectMeta`、`listDocuments`、`getCurrentDocument`、`getDocText` 只读逻辑与错误处理。
- 新增 `tests/test_ai/test_api_readonly.py` 覆盖正常与异常路径，调整导入冒烟测试。
- 通过项目虚拟环境运行 `writer/bin/python -m pytest tests/test_ai` 确认 12 项用例通过。

### File List
- novelwriter/ai/api.py
- tests/test_ai/test_api_imports.py
- tests/test_ai/test_api_readonly.py

## QA Results
- **PASS** 只读接口实现满足 AC，元数据/文档访问逻辑与错误处理符合预期。
- **Risk** 依赖 `NWProject`/`NWStorage` 运行时状态，若未来引入归档模式需复查文件存在性检查。
- **Testing** 尝试执行 `python3 -m pytest tests/test_ai/test_api_readonly.py tests/test_ai/test_api_imports.py` 未通过（No module named pytest），待安装 pytest 后复验整组用例。
