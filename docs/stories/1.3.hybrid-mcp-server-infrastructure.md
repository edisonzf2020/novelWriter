# Story 1.3: 混合MCP服务器基础架构

## Status
Approved

## Story
**As a** AI agent开发者,  
**I want** 有一个统一的工具调用接口，  
**so that** 我就能够无缝地使用本地和外部工具来操作novelWriter。

## Acceptance Criteria
1. 创建`MCPServer`类，基于FastMCP框架
2. 实现统一的`call_tool`接口，支持工具路由
3. 建立本地工具和外部工具的注册发现机制
4. 实现基于streamable-http的传输协议支持
5. 集成安全控制和性能监控基础设施

## Tasks / Subtasks

- [ ] Task 1: MCP服务器基础架构创建 (AC: 1)
  - [ ] 创建 `novelwriter/api/mcp_server.py` 文件，定义`MCPServer`类
  - [ ] 基于FastMCP框架实现MCP协议服务器
  - [ ] 实现服务器初始化和配置管理
  - [ ] 集成streamable-http传输协议支持
  - [ ] 添加服务器生命周期管理（启动、停止、重启）

- [ ] Task 2: 统一工具调用接口实现 (AC: 2)
  - [ ] 实现`call_tool(name, parameters)`统一接口
  - [ ] 建立工具路由机制，区分本地和外部工具
  - [ ] 实现工具调用的参数验证和类型转换
  - [ ] 添加工具调用的结果标准化处理
  - [ ] 实现异步工具调用支持

- [ ] Task 3: 本地工具注册和发现机制 (AC: 3)
  - [ ] 创建工具注册表，支持动态工具发现
  - [ ] 实现基于`NovelWriterAPI`的本地工具包装器
  - [ ] 建立工具元数据管理（名称、描述、参数Schema）
  - [ ] 实现工具权限管理和访问控制
  - [ ] 添加工具状态监控和健康检查

- [ ] Task 4: 外部工具连接管理 (AC: 3)
  - [ ] 实现外部MCP服务器连接管理
  - [ ] 建立外部工具自动发现机制
  - [ ] 实现连接池和连接复用
  - [ ] 添加连接健康检查和自动重连
  - [ ] 实现外部工具的代理调用

- [ ] Task 5: 传输协议和通信层 (AC: 4)
  - [ ] 配置streamable-http传输协议
  - [ ] 实现HTTP/2支持，提升传输效率
  - [ ] 添加请求/响应的序列化和反序列化
  - [ ] 实现流式响应处理
  - [ ] 添加连接超时和重试机制

- [ ] Task 6: 安全控制集成 (AC: 5)
  - [ ] 复用Story 1.1中NovelWriterAPI的权限控制装饰器
  - [ ] 实现工具调用的身份验证和权限检查
  - [ ] 添加API访问频率限制
  - [ ] 扩展现有审计日志记录所有MCP工具调用
  - [ ] 建立MCP安全策略配置管理

- [ ] Task 7: 性能监控基础设施 (AC: 5)
  - [ ] 扩展Story 1.1中NovelWriterAPI的性能监控装饰器功能
  - [ ] 实现MCP工具调用延迟监控（本地<10ms，外部<200ms）
  - [ ] 添加并发调用数量监控
  - [ ] 实现工具调用成功率统计
  - [ ] 建立性能告警和自动降级机制

- [ ] Task 8: 编写单元测试和集成验证
  - [ ] 创建`tests/test_api/test_mcp_server.py`测试MCP服务器核心功能
  - [ ] 测试工具路由和调用机制
  - [ ] 验证本地工具包装器功能
  - [ ] 测试外部工具连接和代理调用
  - [ ] 性能测试：验证延迟要求（本地<10ms，外部<200ms）

## Dev Notes

### 架构设计要点 [Source: mcp-hybrid-architecture.md]

#### 1. 基于已完成基础设施
依赖Story 1.1和1.2的关键成果：
- ✅ `NovelWriterAPI`: 提供统一的数据访问接口，集成权限控制和性能监控
- ✅ `AICoreService`: 重构后的AI业务逻辑层，通过依赖注入使用NovelWriterAPI
- ✅ 依赖注入架构: 避免循环导入的清洁架构
- ✅ 装饰器系统: @validateParams, @requiresWritePermission等安全机制

#### 2. MCP服务器架构设计 [Source: mcp-hybrid-architecture.md#6.2]
```python
class MCPServer:
    """混合MCP服务器 - 统一本地和外部工具调用"""
    
    def __init__(self, nw_api: NovelWriterAPI):
        self._nw_api = nw_api
        self._local_tools = LocalToolRegistry()
        self._external_tools = ExternalToolManager()
        self._transport = StreamableHttpTransport()
    
    async def call_tool(self, name: str, parameters: Dict[str, Any]) -> ToolExecutionResult:
        """统一工具调用接口"""
        if self._local_tools.has_tool(name):
            return await self._call_local_tool(name, parameters)
        else:
            return await self._call_external_tool(name, parameters)
```

#### 3. 文件组织结构 [Source: mcp-hybrid-architecture.md#8.2]
```
novelwriter/api/
├── novelwriter_api.py         # 已存在：统一API（Story 1.1）
├── mcp_server.py              # 新增：MCP服务器核心
├── tools/                     # 新增：工具实现模块
│   ├── __init__.py
│   ├── local_tools.py        # 本地工具包装器
│   └── registry.py           # 工具注册表
├── external_mcp/              # 新增：外部MCP管理
│   ├── __init__.py  
│   ├── connection.py         # 连接管理
│   ├── discovery.py          # 工具发现
│   └── client.py             # MCP客户端
└── exceptions.py              # 已存在：统一异常处理（Story 1.1）
```

#### 4. 技术规范 [Source: mcp-hybrid-architecture.md#4.2]
- **MCP Python SDK**: 官方SDK，pip install "novelwriter[ai-mcp]"
- **传输协议**: streamable-http（性能优于WebSocket）
- **性能要求**: 本地工具<10ms，外部工具<200ms (P95)
- **安全要求**: 复用NovelWriterAPI的权限控制机制

#### 5. 与现有系统集成 [Source: prd-mcp-hybrid.md]
- **向后兼容**: MCP功能作为可选特性，不影响现有用户体验
- **AI模块兼容**: 确保新的MCP服务器不影响现有AI功能
- **渐进式启用**: 用户可控制MCP功能开关
- **故障安全**: MCP服务器故障时，应用其他功能正常工作

### Testing

#### 测试要求 [Source: mcp-hybrid-architecture.md#10.3]
- **测试文件位置**: `tests/test_api/test_mcp_server.py`
- **测试框架**: pytest，复用现有fixtures
- **性能测试**: 验证本地工具<10ms，外部工具<200ms
- **集成测试**: MCP服务器与NovelWriterAPI集成

#### 测试环境设置 [Source: mcp-hybrid-architecture.md#10.3]
```bash
# 1. 激活虚拟环境
source writer/bin/activate

# 2. 安装MCP依赖
pip install "novelwriter[ai-mcp]"

# 3. 运行完整测试
export QT_SCALE_FACTOR=1 && pytest --compat-env-file=test.env

# 4. MCP专项测试  
pytest tests/test_api/test_mcp_server.py -v
```

#### 关键测试验证点
- 验证MCP服务器正确集成NovelWriterAPI
- 验证本地工具调用延迟<10ms
- 验证外部工具连接和代理调用功能
- 验证工具路由机制的准确性
- 验证安全控制和审计日志功能
- 验证故障时的优雅降级

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-24 | v1.0 | Initial story creation based on PRD v3.0 and Architecture v1.1 | Bob (SM) |

## Dev Agent Record

### Agent Model Used
*[To be filled during development]*

### Debug Log References
*[To be filled during development]*

### Completion Notes List
*[To be filled during development]*

### File List
- **新增文件:**
  - *[To be filled during development]*
  
- **修改文件:**
  - *[To be filled during development]*

## QA Results

### Review Date: 
*[To be filled during QA review]*

### Reviewed By:
*[To be filled during QA review]*

### Code Quality Assessment
*[To be filled during QA review]*

### Refactoring Performed
*[To be filled during QA review]*

### Compliance Check
*[To be filled during QA review]*

### Improvements Checklist
*[To be filled during QA review]*

### Security Review
*[To be filled during QA review]*

### Performance Considerations
*[To be filled during QA review]*

### Files Modified During Review
*[To be filled during QA review]*

### Gate Status
*[To be filled during QA review]*

### Recommended Status
*[To be filled during QA review]*
