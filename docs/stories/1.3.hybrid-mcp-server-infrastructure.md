# Story 1.3: 混合MCP服务器基础架构

## Status
Approved

## Story
**As a** AI agent开发者,  
**I want** 有一个统一的工具调用接口，  
**so that** 我就能够无缝地使用本地和外部工具来操作novelWriter。

## Acceptance Criteria
1. 创建`MCPServer`类，基于FastMCP框架
2. 实现统一的`call_tool`接口，支持工具路由
3. 建立本地工具和外部工具的注册发现机制
4. 实现基于streamable-http的传输协议支持
5. 集成安全控制和性能监控基础设施

## Tasks / Subtasks

- [ ] Task 1: MCP Python SDK集成和基础架构 (AC: 1)
  - [ ] 安装并集成MCP Python SDK到项目依赖
  - [ ] 研究FastMCP框架的服务器创建最佳实践
  - [ ] 创建`novelwriter/mcp/`模块目录结构
  - [ ] 创建`novelwriter/mcp/server.py`，定义`MCPServer`基类
  - [ ] 实现基础的MCP协议消息处理框架

- [ ] Task 2: 统一工具调用接口实现 (AC: 2)
  - [ ] 设计`call_tool(name, parameters)`统一接口签名
  - [ ] 实现工具路由逻辑：区分本地工具vs外部工具
  - [ ] 创建工具调用结果的标准化格式
  - [ ] 实现异步工具调用支持（基于现有QThread架构）
  - [ ] 添加工具调用的请求ID跟踪和会话管理

- [ ] Task 3: 本地和外部工具注册发现机制 (AC: 3)
  - [ ] 设计工具注册表数据结构和接口
  - [ ] 实现本地工具自动发现和注册
  - [ ] 实现外部MCP工具连接和发现协议
  - [ ] 创建工具元数据管理（名称、参数Schema、描述）
  - [ ] 实现工具可用性检查和状态管理

- [ ] Task 4: 传输协议支持实现 (AC: 4)
  - [ ] 实现streamable-http传输协议（基于现有httpx）
  - [ ] 集成stdio传输支持（开发和测试使用）
  - [ ] 实现Server-Sent Events (SSE) 传输选项
  - [ ] 创建传输协议的配置和切换机制
  - [ ] 实现连接管理、超时处理和重连逻辑

- [ ] Task 5: 安全控制和监控集成 (AC: 5)
  - [ ] 集成Story 1.1创建的SecurityController到MCP服务器
  - [ ] 实现MCP工具调用的权限验证和审计
  - [ ] 集成PerformanceMonitor监控MCP调用性能
  - [ ] 实现工具调用的参数验证和清理
  - [ ] 创建MCP服务器健康检查和状态报告

- [ ] Task 6: 服务器生命周期管理
  - [ ] 实现MCP服务器的启动/停止生命周期管理
  - [ ] 集成到novelWriter主应用的启动序列
  - [ ] 实现优雅关闭和资源清理
  - [ ] 创建服务器状态的UI状态栏指示器
  - [ ] 实现配置热重载支持

- [ ] Task 7: 编写单元测试和集成验证
  - [ ] 创建`tests/test_mcp/test_server.py`测试MCPServer类
  - [ ] 测试工具路由逻辑和调用接口
  - [ ] 测试各种传输协议的功能
  - [ ] 创建模拟外部MCP工具用于测试
  - [ ] 验证性能指标和安全控制集成

## Dev Notes

### MCP协议架构要点 [Source: mcp-hybrid-architecture.md]

#### 1. MCP Python SDK技术选择 [Source: mcp-hybrid-architecture.md#4.2]
基于Context7 MCP协议调研，选择官方技术栈：
- **MCP Python SDK**: 官方SDK，支持多传输协议
- **FastMCP**: 内置于SDK，简化服务器创建，内置功能丰富
- **Pydantic v2**: MCP工具Schema验证标准
- **传输协议**: streamable-http（生产推荐），stdio（开发/测试），sse（浏览器客户端）

#### 2. 统一工具调用架构 [Source: mcp-hybrid-architecture.md#6.2]
```mermaid
Agent --> MCPServer --> NovelWriterAPI
MCPServer --> ExternalMCPManager --> 外部MCP工具
MCPServer --> SecurityController + PerformanceMonitor
```

#### 3. 传输协议支持策略 [Source: mcp-hybrid-architecture.md#4.3]
**最佳传输方案**：
- **本地工具**：直接调用，无传输开销
- **外部MCP工具**：`streamable-http`传输（性能最优）
- **开发测试**：`stdio`传输（简单调试）

支持的传输方式：
```python
transport_options = [
    "stdio",           # 标准输入输出（开发/测试）
    "streamable-http", # HTTP流传输（生产推荐）  
    "sse"             # Server-Sent Events（浏览器客户端）
]
```

#### 4. 现有基础设施复用 [Source: mcp-hybrid-architecture.md#4.1]
- **HTTP客户端**: 现有httpx，支持streamable-http传输
- **异步处理**: 现有asyncio + QThread，完美匹配MCP异步架构
- **安全和监控**: 复用Story 1.1的SecurityController和PerformanceMonitor

### 前序故事依赖 [Source: docs/stories/]
本故事依赖以下已完成的基础设施：

**Story 1.1 (统一API中间层创建)**:
- ✅ NovelWriterAPI提供统一数据访问
- ✅ SecurityController实现权限验证和审计
- ✅ PerformanceMonitor提供性能监控基础

**Story 1.2 (AI模块职责分离重构)**:
- 🔄 AICoreService通过依赖注入使用NovelWriterAPI（预期完成）
- 🔄 AI功能模块架构清洁，为MCP集成做好准备

### 文件组织结构 [Source: mcp-hybrid-architecture.md#8.1]
```
novelwriter/mcp/                # 新增MCP模块
├── __init__.py                 # MCPServer等主要导出
├── server.py                   # MCPServer主要实现
├── transport.py                # 传输协议抽象
├── registry.py                 # 工具注册和发现
└── external_client.py          # 外部MCP工具客户端
```

### 集成点和兼容性要求 [Source: prd-mcp-hybrid.md#NFR4]
- **优雅降级**: 外部工具不可用时本地功能完全正常
- **性能要求**: 本地工具调用延迟<10ms (P95)，外部MCP工具调用延迟<200ms (P95)
- **向后兼容**: MCP功能作为可选依赖，不影响现有用户

### MCP协议标准接口 [Source: mcp-hybrid-architecture.md#7.2]
**工具调用接口标准**：
```http
POST /mcp/tools/call
Content-Type: application/json

{
  "method": "tools/call", 
  "params": {
    "name": "read_document",
    "arguments": {
      "item_handle": "doc123",
      "include_metadata": true
    }
  }
}
```

### 编码标准 [Source: mcp-hybrid-architecture.md#10.1]
- **类命名**: `MCPServer`, `ToolRegistry` (PascalCase)
- **方法命名**: `callTool`, `registerTool` (camelCase匹配Qt)
- **异步方法**: 使用`async def`，集成QThread处理
- **类型提示**: 完整的类型提示，特别是MCP协议消息类型

### Testing

#### 测试要求 [Source: mcp-hybrid-architecture.md#10.3]
- **测试文件位置**: `tests/test_mcp/test_server.py`
- **测试框架**: pytest，支持异步测试
- **性能测试**: 验证工具调用延迟符合要求
- **模拟测试**: 创建模拟外部MCP服务器用于测试

#### MCP协议兼容性测试
- 验证与MCP标准协议的兼容性
- 测试不同传输协议的功能正确性
- 测试工具发现和注册机制
- 验证错误处理和异常场景

#### 测试环境设置 [Source: mcp-hybrid-architecture.md#10.3]
```bash
# 1. 激活虚拟环境并安装MCP SDK
source writer/bin/activate
pip install mcp-python-sdk

# 2. 运行MCP模块测试
pytest tests/test_mcp/ -v

# 3. 集成测试验证
source writer/bin/activate && export QT_SCALE_FACTOR=1 && pytest --compat-env-file=test.env
```

#### 关键测试验证点
- MCP服务器成功启动和关闭
- 工具路由正确区分本地和外部工具
- 各传输协议功能正常
- 安全控制和性能监控正确集成
- 外部工具不可用时的优雅降级

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-24 | v1.0 | Initial story creation based on PRD v3.0 and Architecture v1.1 | Bob (SM) |
