# Story 2.0: NWAiApi 事务与审计能力

## Status
Done

## Story
**As an** AI Agent,
**I want** 在执行一组写入操作前能够开启事务并在失败时回滚,
**so that** AI 助手可以在 novelWriter 中安全地修改文档且所有关键操作可追溯。

## Acceptance Criteria
1. `NWAiApi` 提供 `begin_transaction()`, `commit_transaction()`, `rollback_transaction()`，并在无活动事务时拒绝提交/回滚请求。[Source: docs/prd/第二部分p1-核心功能与写入-api.md#用户故事-03-为-nwaiapi-集成事务与审计功能]
2. 所有写入型 API（包括后续故事引入的 `setDocText`、`applySuggestion` 等）必须在活动事务内执行，否则抛出 `NWAiApiError`。[Source: docs/prd/第二部分p1-核心功能与写入-api.md#用户故事-04-实现-api-的安全写入与建议应用接口]
3. 提供 `get_audit_log()` 返回按时间排序的不可变记录，记录至少包含事务 ID、操作类型、目标句柄、摘要信息和时间戳。[Source: docs/prd/第二部分p1-核心功能与写入-api.md#用户故事-03-为-nwaiapi-集成事务与审计功能]
4. 事务支持嵌套或“多次 begin”场景，设计应确保最外层提交才真正持久化；嵌套 `rollback` 会回滚至事务开始前状态。[Source: docs/AI/AI_ASSISTANT_PLAN.md#事务机制考量]
5. 为事务与审计实现新增单元测试，覆盖成功路径、嵌套事务、异常回滚以及审计记录内容；保证现有只读测试继续通过。

## Tasks / Subtasks
- [ ] 在 `novelwriter/ai/api.py` 引入事务管理内部状态（唯一事务 ID、嵌套计数、挂起操作容器）及 `_assert_transaction_active()` 等辅助方法。(AC: 1,2,4)[Source: novelwriter/ai/api.py:55]
- [ ] 实现 `begin_transaction()`：生成唯一 ID（可使用 `uuid4`）、递增嵌套层级并返回当前事务 ID；若已有事务则仍返回外层 ID。(AC: 1,4)
- [ ] 实现 `commit_transaction(transaction_id)`：仅允许最外层提交；在内层调用时减少嵌套计数，最外层提交时调用实际持久化逻辑（后续故事将挂接），并清空挂起操作。(AC: 1,4)
- [ ] 实现 `rollback_transaction(transaction_id)`：无论嵌套层级，撤销当前事务及内层收集的挂起操作（利用 `NWProject` 的 undo/变更缓存机制或临时快照），恢复初始状态。(AC: 1,2,4)
- [ ] 设计挂起操作存储结构（如 `self._pending_operations` 列表），后续故事的写入方法将往其中推送操作描述；本故事确保在事务结束或回滚时正确清理。(AC: 2)
- [ ] 实现 `get_audit_log()`：返回最近 N 条审计记录（默认全量），记录包含事务 ID、操作类型、目标、参数摘要、时间戳；使用 `collections.deque` 维护固定上限以防内存膨胀。(AC: 3)
- [ ] 当事务提交时，将挂起操作转化为审计记录并写入队列；回滚时也记录一条说明回滚原因/触发点的审计记录。(AC: 3)
- [ ] 扩展异常抛出逻辑：在非事务上下文调用写入方法或提交/回滚不存在的事务时抛出 `NWAiApiError`，并将错误信息纳入审计。(AC: 2,3)
- [ ] 新增单元测试 `tests/test_ai/test_api_transactions.py`：覆盖基本事务流程、嵌套提交、异常回滚、审计日志格式以及写入前置事务校验；测试需模拟挂起操作（可通过临时 stub 或直接操作 `_pending_operations`）。(AC: 5)
- [ ] 更新现有写入方法 stub（如 `setDocText`, `applySuggestion`）添加 `# TODO` 或 guard，确保未实现情况下也会检查事务状态，为后续故事铺路。(AC: 2)

## Dev Notes

### Previous Story Insights
- Story 1.2 已实现 AI 配置解耦与偏好设置，可通过 `CONFIG.ai` 控制写入能力开关，事务实现需读取配置以决定默认行为（例如 Dry-run 默认值）。[Source: docs/stories/1.2.ai-preferences.md]
- Story 1.1 的 Dock 会根据配置刷新状态，未来当事务失败 / 回滚时可利用审计记录向 UI 提示；建议保持审计结构易于序列化。[Source: docs/stories/1.1.ai-copilot-dock.md]

### Architecture & Implementation Guidance
- 事务实现应避免直接依赖 GUI；限制在 `novelwriter/ai` 层内操作 `NWProject`/`NWStorage`，符合分层原则。[Source: docs/architecture/核心架构原则-源自-docstechnical.md#核心架构原则-源自-docstechnical]
- 可利用 `NWProject.storage` 提供的临时副本/快照功能（若无现成 API，可在本故事内通过内存缓存实现最小化挂起记录），确保不破坏现有项目打开流程。[Source: novelwriter/core/storage.py:289]
- 审计日志建议使用轻量结构（例如 `dataclass` 或 `NamedTuple`），便于后续写入文件或导出；为了性能可限制记录数量（如 1000 条）并提供截断警告。[Source: docs/AI/AI_ASSISTANT_PLAN.md#事务机制考量]

### Testing Strategy
- 单元测试可利用 `pytest` fixture 创建最小 `NWProject`，模拟 begin/commit/rollback；对 `_pending_operations` 注入伪操作（如字符串或 dict）验证序列化逻辑。
- 使用 `freeze_time` 或 `monkeypatch` 控制时间戳，确保审计记录可预测；检查异常情况下的日志条目（例如尝试 `commit_transaction("invalid")`）。

## Testing
- `pytest tests/test_ai/test_api_transactions.py`
- 回归：`pytest tests/test_ai/test_api_readonly.py`

## Change Log
| Date | Version | Description | Author |
| --- | --- | --- | --- |
| 2025-09-17 | 0.1 | Initial draft | Codex (Scrum Master) |

## Dev Agent Record
### Agent Model Used
_TBD_

### Debug Log References
_TBD_

### Completion Notes List
_TBD_

### File List
_TBD_

## QA Results
- **PASS** 事务栈实现支持嵌套 begin/commit/rollback，并在提交与回滚时写入审计记录，满足写操作需在事务内执行的约束（参见 novelwriter/ai/api.py:107,novelwriter/ai/api.py:289）。
- **Risk** 当前审计日志存储于内存 deque，若未来需要持久化或跨会话分析需追加同步机制。
- **Testing** `pytest tests/test_ai/test_api_transactions.py tests/test_ai/test_api_readonly.py`（12 passed in 0.52s）。
