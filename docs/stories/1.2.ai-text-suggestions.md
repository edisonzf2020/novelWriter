# Story 1.2: 基础的 AI 文本建议与预览

## Status
Approved

## Story
**As a** novelWriter 作者,
**I want** 向 AI Copilot 请求文本建议并在应用前预览,
**so that** 我可以安全、可控地利用 AI 提升写作效率。

## Acceptance Criteria
1. Copilot 面板包含输入框和消息区，能流式显示 AI 响应不卡顿 UI。[Source: docs/prd/第一部分p0-基础框架与只读-api.md#用户故事-12-基础的-ai-文本建议与预览]
2. 提供至少 3 个基础快捷动作（如："摘要"、"续写"、"改写"）。[Source: docs/prd/第一部分p0-基础框架与只读-api.md#用户故事-12-基础的-ai-文本建议与预览]
3. 当 AI 生成修改建议时，通过 `previewSuggestion` API 提供清晰的 Diff 预览。[Source: docs/prd/第一部分p0-基础框架与只读-api.md#用户故事-12-基础的-ai-文本建议与预览][Source: novelwriter/ai/api.py:590]
4. P0 阶段写操作为手动应用，用户预览后需点击按钮确认。[Source: docs/prd/第一部分p0-基础框架与只读-api.md#用户故事-12-基础的-ai-文本建议与预览]
5. AI 网络调用支持超时（默认 30 秒）和取消操作。[Source: docs/prd/第一部分p0-基础框架与只读-api.md#用户故事-12-基础的-ai-文本建议与预览]

## Tasks / Subtasks
- [ ] 扩展 AI Copilot Dock UI 组件 (AC: 1,2)
  - [ ] 在 `novelwriter/extensions/ai_copilot/dock.py` 中替换占位内容为功能性 UI
  - [ ] 添加用户输入区域：包含多行文本输入框（QTextEdit）和发送按钮（QPushButton）
  - [ ] 添加快捷动作区域：至少包含"摘要"、"续写"、"改写"三个预设按钮
  - [ ] 添加响应显示区域：支持流式文本显示的 QTextBrowser 或类似组件
  - [ ] 确保所有控件支持主题切换和 i18n 翻译
- [ ] 实现 AI 请求处理逻辑 (AC: 1,3,5)
  - [ ] 创建 `novelwriter/extensions/ai_copilot/handler.py` 处理 AI 交互
  - [ ] 实现异步 AI 请求发送，使用 QThread 或 QTimer 避免 UI 阻塞
  - [ ] 集成 NWAiApi 的事务管理和上下文获取功能
  - [ ] 实现超时控制（默认30秒）和用户取消操作
  - [ ] 处理网络错误和 API 错误，显示用户友好的错误消息
- [ ] 实现建议预览和应用功能 (AC: 3,4)
  - [ ] 使用 `NWAiApi.previewSuggestion()` 生成 Diff 预览
  - [ ] 创建建议预览 UI 组件，清晰展示原文本和建议文本的差异
  - [ ] 实现"应用建议"和"拒绝建议"按钮
  - [ ] 集成 `NWAiApi.applySuggestion()` 完成建议应用
  - [ ] 在应用建议后更新编辑器视图和项目状态
- [ ] 实现快捷动作处理 (AC: 2,3)
  - [ ] 为"摘要"动作：基于当前上下文生成内容摘要
  - [ ] 为"续写"动作：基于当前文档位置生成后续内容建议
  - [ ] 为"改写"动作：基于选中文本生成替换建议，使用 previewSuggestion 流程
  - [ ] 根据用户选择的上下文范围（选中文本、当前文档等）调整请求内容
- [ ] 增强错误处理和用户体验 (AC: 5)
  - [ ] 实现请求进度指示器和加载状态
  - [ ] 添加取消按钮允许用户中断正在进行的 AI 请求
  - [ ] 处理 AI 服务不可用、网络超时等异常情况
  - [ ] 提供清晰的状态反馈和错误消息
- [ ] 更新测试覆盖 (AC: 1-5)
  - [ ] 扩展 `tests/test_gui/test_gui_ai_copilot.py` 验证新增 UI 组件
  - [ ] 新增 `tests/test_ai/test_ai_suggestions.py` 测试建议预览和应用流程
  - [ ] 添加异步请求和错误处理的单元测试
  - [ ] 验证快捷动作功能和上下文处理

## Dev Notes

### Previous Story Insights
- Story 1.0 已完成 AI Copilot Dock 的基础集成，提供了占位 UI 和依赖检测。[Source: docs/stories/1.0.ai-copilot-dock.md]
- Story 1.1 已完成 AI 配置系统，提供了 `CONFIG.ai` 配置和偏好设置界面。[Source: docs/stories/1.1.ai-preferences.md]
- Story 2.1 已完成 NWAiApi 写入功能，提供了 `previewSuggestion` 和 `applySuggestion` API。[Source: docs/stories/2.1.nwaiapi-write-ops.md]

### Architecture Integration
- 当前 Dock 实现位于 `novelwriter/extensions/ai_copilot/dock.py`，包含上下文选择器和占位内容。[Source: novelwriter/extensions/ai_copilot/dock.py:25]
- NWAiApi 已提供完整的事务支持、建议预览和应用功能。[Source: novelwriter/ai/api.py:590]
- 主窗口集成已完成，Dock 可以通过 `contextScopeChanged` 信号获取上下文变更。[Source: novelwriter/extensions/ai_copilot/dock.py:15]

### UI Implementation Guidelines
- 使用 PyQt6 组件构建响应式 UI，确保在不同主题下正确显示。[Source: novelwriter/extensions/ai_copilot/dock.py:142]
- 遵循现有的 i18n 模式，所有用户可见文本通过 `self.tr()` 包装。[Source: novelwriter/extensions/ai_copilot/dock.py:224]
- 利用 `SHARED.theme` 获取主题相关的颜色和字体设置。[Source: novelwriter/extensions/ai_copilot/dock.py:225]

### AI Request Handling
- 使用异步模式避免 UI 阻塞，推荐 QThread 或 QTimer 实现。
- 集成现有的 NWAiApi 事务管理，确保所有写入操作在事务上下文中执行。[Source: novelwriter/ai/api.py:221]
- 处理 `CONFIG.ai.timeout` 配置，默认30秒超时。[Source: novelwriter/ai/config.py:26]

### Suggestion Preview Implementation
- 使用 `NWAiApi.previewSuggestion()` 生成 unified diff 格式的预览。[Source: novelwriter/ai/api.py:590]
- 建议展示应该清晰区分原文本和建议文本，可考虑使用颜色编码或并排显示。
- 预览后的应用操作使用 `NWAiApi.applySuggestion()` 确保一致的事务处理。[Source: novelwriter/ai/api.py:647]

### Quick Actions Design
- "摘要"：基于当前上下文生成内容概要，不涉及文本修改
- "续写"：在当前光标位置或文档末尾生成继续内容建议
- "改写"：基于选中文本生成替换建议，使用 previewSuggestion 流程
- 根据 Dock 的上下文选择器（selection、current_document、outline、project）调整请求范围

### Error Handling Strategy
- 网络超时：显示友好提示并允许重试
- API 错误：解析 NWAiApiError 并显示具体错误信息
- 配置错误：引导用户检查 AI 配置设置
- 服务不可用：提供离线模式或降级功能提示

### Testing Strategy
- GUI 测试：使用 `nwGUI` fixture 和 `QT_QPA_PLATFORM=offscreen` 模式
- API 集成测试：模拟 AI 响应和网络条件
- 异步操作测试：验证请求取消和超时处理
- 用户交互测试：验证按钮点击、文本输入和预览应用流程

## Testing
- `QT_QPA_PLATFORM=offscreen pytest tests/test_gui/test_gui_ai_copilot.py`
- `pytest tests/test_ai/test_ai_suggestions.py`
- `pytest tests/test_ai/test_api_write.py` (确保无回归)

## Change Log
| Date | Version | Description | Author |
| --- | --- | --- | --- |
| 2025-09-18 | 0.1 | Initial draft as补充故事 | Bob (Scrum Master) |

## Dev Agent Record
### Agent Model Used
_TBD_

### Debug Log References
_TBD_

### Completion Notes List
_TBD_

### File List
_TBD_

## QA Results
_TBD_