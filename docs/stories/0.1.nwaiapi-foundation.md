# Story 0.1: 设计并实现 NWAiApi 基础结构与数据模型

## Status
Done

## Story
**As a** novelWriter 平台开发者,
**I want** 在 `novelwriter/ai/` 中建立 NWAiApi 及其配套模型骨架,
**so that** AI Copilot 能通过安全、类型化的领域 API 与核心系统交互。

## Acceptance Criteria
1. `models.py` 中定义核心数据类，如 `DocumentRef`, `TextRange` 等。[Source: prd/第一部分p0-基础框架与只读-api.md#用户故事-01-设计并实现-nwaiapi-的基础结构与数据模型]
2. `errors.py` 中定义基础异常类，如 `NWAiError`。[Source: prd/第一部分p0-基础框架与只读-api.md#用户故事-01-设计并实现-nwaiapi-的基础结构与数据模型]
3. `api.py` 中定义 `NWAiApi` 类的基本结构。[Source: prd/第一部分p0-基础框架与只读-api.md#用户故事-01-设计并实现-nwaiapi-的基础结构与数据模型]

## Tasks / Subtasks
- [x] 建立 `novelwriter/ai` 包的最小骨架（含 `__init__.py`）并保持与 GUI 解耦。(AC: 3) [Source: architecture/核心架构原则-源自-docstechnical.md#核心架构原则-源自-docstechnical]
  - [x] 在包初始化文件记录模块用途并确保未引入 GUI 依赖。(AC: 3)
- [x] 在 `models.py` 定义 `DocumentRef`, `TextRange`, `Suggestion`, `BuildResult` 等 dataclass，补充类型注解与导出清单。(AC: 1) [Source: prd/第一部分p0-基础框架与只读-api.md#用户故事-01-设计并实现-nwaiapi-的基础结构与数据模型]
  - [x] 为每个数据类提供文档字符串，描述与 AI Copilot 的关联。(AC: 1)
- [x] 在 `errors.py` 实现 `NWAiError` 及派生错误类型，提供基础 docstring 便于统一捕获。(AC: 2) [Source: prd/第一部分p0-基础框架与只读-api.md#用户故事-01-设计并实现-nwaiapi-的基础结构与数据模型]
- [x] 在 `api.py` 声明 `NWAiApi` 类、构造函数及关键只读/事务方法签名，使用类型注解并临时抛出 `NotImplementedError`。(AC: 3) [Source: AI/AI_ASSISTANT_PLAN.md#52-接口清单-节选-apipy]
  - [x] 为 `NWAiApi` 编写类级 docstring，说明其作为 AI 安全动作层的定位。(AC: 3) [Source: architecture/集成点与外部依赖.md#内部集成点]
- [x] 初步搭建 `tests/test_ai` 目录并添加导入冒烟测试，确保新包在 pytest 中可加载。(AC: 1, 2, 3) [Source: source/technical/tests.rst#running-tests]

## Dev Notes

### Previous Story Insights
- 本故事为 AI Copilot 迭代的首个工作项，暂无可复用的前置实施记录，需在实现中记录关键决策以供后续故事参考。

### Data Models
- `novelwriter/ai/models.py` 需提供 dataclass `DocumentRef`, `TextRange`, `Suggestion`, `BuildResult`，为 AI API 传递项目与文档上下文提供统一结构。[Source: prd/第一部分p0-基础框架与只读-api.md#用户故事-01-设计并实现-nwaiapi-的基础结构与数据模型]

### API Specifications
- `NWAiApi` 需包含事务管理、项目/文档读取、建议预览等方法签名，当前阶段可以抛出待实现异常，但必须具备完整的类型注解与文档字符串，后续故事将在此基础上填充实现。[Source: AI/AI_ASSISTANT_PLAN.md#52-接口清单-节选-apipy]
- API 层必须保持与 GUI 的松耦合，仅依赖核心数据与文本处理模块，确保符合分层架构约束。[Source: architecture/核心架构原则-源自-docstechnical.md#核心架构原则-源自-docstechnical]

### Component Specifications
- P0 范围不涉及 UI 组件，Copilot 面板和配置界面由后续故事交付；保持 API 包纯后端特性即可。[Source: prd/第一部分p0-基础框架与只读-api.md#史诗-0-构建-ai-安全动作领域-api-nwaiapi]

### File Locations
- 新模块位于 `novelwriter/ai/`，对应 `extensions/ai_copilot/` UI 层的后续集成点；文件组织需与架构规划保持一致。[Source: architecture/源码树与模块组织.md#项目结构-集成后]
- 相关测试应放置在 `tests/test_ai/` 下，按照现有 pytest 约定命名，便于与 core/gui 测试分组管理。[Source: source/technical/tests.rst#running-tests]

### Testing Requirements
- 使用 `pytest` 与 `pytest-qt` 运行测试，建议在 CI 中设置 `QT_QPA_PLATFORM=offscreen` 避免 GUI 干扰；为 API 包至少提供导入级冒烟测试，为后续功能实现留出扩展点。[Source: source/technical/tests.rst#running-tests]

### Technical Constraints
- `ai` 包不得依赖 GUI 层，所有未来的 UI 交互将通过信号/槽或扩展层封装完成，确保模块可以在无 GUI 环境下导入和测试。[Source: architecture/核心架构原则-源自-docstechnical.md#核心架构原则-源自-docstechnical]
- 未来的配置读取需通过 `Config.ai` 懒加载接口，在当前骨架中预留占位但避免直接访问 CONFIG 单例，保持最小侵入式改动。[Source: architecture/增强功能影响分析.md#新增功能必须遵守的设计标准]

### Project Structure Notes
- 当前仓库已包含空的 `novelwriter/ai/` 目录，创建骨架文件时需遵循既有命名规范，并确认 `setup.cfg` 或 `pyproject.toml` 不需要额外调整；如需后续扩展 extras 依赖，将在后续故事中处理。[Source: architecture/增强功能影响分析.md#需要修改的文件]

## Testing
- 建议在新增 `tests/test_ai/test_api_imports.py`（或同类命名）中验证 `NWAiApi`, `DocumentRef` 等可以成功导入，为后续实现提供安全网。[Source: source/technical/tests.rst#running-tests]

## Change Log
| Date | Version | Description | Author |
| --- | --- | --- | --- |
| 2025-09-16 | 0.1 | Initial draft | Codex (Scrum Master) |

## Dev Agent Record
### Agent Model Used
_TBD_

### Debug Log References
_TBD_

### Completion Notes List
_TBD_

### File List
_TBD_

## QA Results
- **PASS** 未发现阻断性问题，`novelwriter/ai` 骨架实现符合接口与数据模型约束。
- **Risk** 当前仅有导入冒烟测试，建议后续补充对关键 stub 方法抛出 `NotImplementedError` 的断言以防回归。
- **Testing** `source writer/bin/activate && python -m pytest tests/test_ai/test_api_imports.py`（6 passed in 0.26s）。
