# Story 0.1: 设计并实现 NWAiApi 基础结构与数据模型

## Status
Done

## Story
**As a** novelWriter 平台开发者,
**I want** 在 `novelwriter/ai/` 中建立 NWAiApi 及其配套模型骨架,
**so that** AI Copilot 能通过安全、类型化的领域 API 与核心系统交互。

## Acceptance Criteria
1. `models.py` 中定义核心数据类，如 `DocumentRef`, `TextRange` 等。[Source: prd/第一部分p0-基础框架与只读-api.md#用户故事-01-设计并实现-nwaiapi-的基础结构与数据模型]
2. `errors.py` 中定义基础异常类，如 `NWAiError`。[Source: prd/第一部分p0-基础框架与只读-api.md#用户故事-01-设计并实现-nwaiapi-的基础结构与数据模型]
3. `api.py` 中定义 `NWAiApi` 类的基本结构。[Source: prd/第一部分p0-基础框架与只读-api.md#用户故事-01-设计并实现-nwaiapi-的基础结构与数据模型]

## Tasks / Subtasks
- [x] 建立 `novelwriter/ai` 包的最小骨架（含 `__init__.py`）并保持与 GUI 解耦。(AC: 3) [Source: architecture/核心架构原则-源自-docstechnical.md#核心架构原则-源自-docstechnical]
  - [x] 在包初始化文件记录模块用途并确保未引入 GUI 依赖。(AC: 3)
- [x] 在 `models.py` 定义 `DocumentRef`, `TextRange`, `Suggestion`, `BuildResult` 等 dataclass，补充类型注解与导出清单。(AC: 1) [Source: prd/第一部分p0-基础框架与只读-api.md#用户故事-01-设计并实现-nwaiapi-的基础结构与数据模型]
  - [x] 为每个数据类提供文档字符串，描述与 AI Copilot 的关联。(AC: 1)
- [x] 在 `errors.py` 实现 `NWAiError` 及派生错误类型，提供基础 docstring 便于统一捕获。(AC: 2) [Source: prd/第一部分p0-基础框架与只读-api.md#用户故事-01-设计并实现-nwaiapi-的基础结构与数据模型]
- [x] 在 `api.py` 声明 `NWAiApi` 类、构造函数及关键只读/事务方法签名，使用类型注解并临时抛出 `NotImplementedError`。(AC: 3) [Source: AI/AI_ASSISTANT_PLAN.md#52-接口清单-节选-apipy]
  - [x] 为 `NWAiApi` 编写类级 docstring，说明其作为 AI 安全动作层的定位。(AC: 3) [Source: architecture/集成点与外部依赖.md#内部集成点]
- [x] 初步搭建 `tests/test_ai` 目录并添加导入冒烟测试，确保新包在 pytest 中可加载。(AC: 1, 2, 3) [Source: source/technical/tests.rst#running-tests]

## Dev Notes

### Previous Story Insights
- 本故事为 AI Copilot 迭代的首个工作项，暂无可复用的前置实施记录，需在实现中记录关键决策以供后续故事参考。

### Data Models
- `novelwriter/ai/models.py` 已定义 `DocumentRef`, `TextRange`, `Suggestion`, `BuildResult` 等 dataclass，并通过 `__all__` 控制导出范围；后续扩展时应保持类型注解与文档字符串完整。[Source: prd/第一部分p0-基础框架与只读-api.md#用户故事-01-设计并实现-nwaiapi-的基础结构与数据模型]

### API Specifications
- `NWAiApi` 现已声明事务、只读访问、建议、上下文与构建等方法，并统一抛出 `NotImplementedError` 占位，确保下一故事可以逐项按验收标准补全实现。[Source: AI/AI_ASSISTANT_PLAN.md#52-接口清单-节选-apipy]
- API 层保持与 GUI 的松耦合，仅注入 `NWProject` 并依赖核心层，后续实现务必延续该分层原则。[Source: architecture/核心架构原则-源自-docstechnical.md#核心架构原则-源自-docstechnical]

### Component Specifications
- P0 范围不涉及 UI 组件，Copilot 面板和配置界面由后续故事交付；保持 API 包纯后端特性即可。[Source: prd/第一部分p0-基础框架与只读-api.md#史诗-0-构建-ai-安全动作领域-api-nwaiapi]

### File Locations
- `novelwriter/ai/__init__.py`, `api.py`, `models.py`, `errors.py` 已创建并遵循架构规划的包结构，未与 `gui/` 产生耦合。[Source: architecture/源码树与模块组织.md#项目结构-集成后]
- 冒烟测试位于 `tests/test_ai/test_api_imports.py`，与现有 pytest 目录结构保持一致，后续测试扩展可继续放在该子目录。[Source: source/technical/tests.rst#running-tests]

### Testing Requirements
- 当前冒烟测试验证数据类与错误层可实例化，后续在实现各 API 方法时需补充针对成功路径与失败分支的单元测试；继续遵循 `pytest`/`pytest-qt` 运行规范，并在 CI 中使用 `QT_QPA_PLATFORM=offscreen` 防止 GUI 干扰。[Source: source/technical/tests.rst#running-tests]

### Technical Constraints
- `ai` 包不得依赖 GUI 层，所有未来的 UI 交互将通过信号/槽或扩展层封装完成，确保模块可以在无 GUI 环境下导入和测试。[Source: architecture/核心架构原则-源自-docstechnical.md#核心架构原则-源自-docstechnical]
- 未来的配置读取需通过 `Config.ai` 懒加载接口，在当前骨架中预留占位但避免直接访问 CONFIG 单例，保持最小侵入式改动。[Source: architecture/增强功能影响分析.md#新增功能必须遵守的设计标准]

### Project Structure Notes
- 新增文件均落在 `novelwriter/ai/` 与 `tests/test_ai/` 下，未触及现有 `setup.cfg` / `pyproject.toml`；后续若引入可选依赖需按架构文档在 extras 中增量配置。[Source: architecture/增强功能影响分析.md#需要修改的文件]

## Testing
- 已执行 `pytest tests/test_ai/test_api_imports.py` 验证导入与基础实例化逻辑，通过 6 项断言；后续在实现只读接口时需扩展对应的功能测试。[Source: source/technical/tests.rst#running-tests]

## Change Log
| Date | Version | Description | Author |
| --- | --- | --- | --- |
| 2025-09-16 | 0.1 | Initial draft | Codex (Scrum Master) |
| 2025-09-16 | 1.0 | Implemented AI 包骨架、导出符号与冒烟测试 | Dev Team

## Dev Agent Record
### Agent Model Used
Manual implementation (model信息未记录)

### Debug Log References
无专门调试日志

### Completion Notes List
- 新增 `novelwriter/ai` 包骨架并在 `__all__` 中集中导出对外接口。
- `NWAiApi` 以 stub 形式定义事务、只读、搜索与构建方法，为后续故事提供清晰挂钩。
- `tests/test_ai/test_api_imports.py` 增加导入与基础实例化断言，防止回归破坏骨架结构。

### File List
- novelwriter/ai/__init__.py
- novelwriter/ai/api.py
- novelwriter/ai/errors.py
- novelwriter/ai/models.py
- tests/test_ai/test_api_imports.py

## QA Results
- **PASS** 未发现阻断性问题，`novelwriter/ai` 骨架实现符合接口与数据模型约束。
- **Risk** 当前仅有导入冒烟测试，建议后续补充对关键 stub 方法抛出 `NotImplementedError` 的断言以防回归。
- **Testing** `source writer/bin/activate && python -m pytest tests/test_ai/test_api_imports.py`（6 passed in 0.26s）。
