# **第三部分：P2 - 完善、优化与生态扩展**

**阶段目标:** 提升 AI Copilot 的性能、稳定性和用户体验，并引入对更多主流 AI 模型的支持，为用户提供更丰富的选择。

## **史诗 4: 性能优化与用户体验提升**

> **作为一名高频使用者，** 我希望 AI Copilot 的响应速度更快，交互更流畅，
> **以便** AI 辅助功能不会打断我的创作心流。

**用户故事 4.0: 优化的性能与响应机制**
> **作为一名追求效率的作者，** 我希望 AI 操作的后台处理机制得到优化，应用的界面绝不卡顿，
> **以便** 我可以随时取消不需要的 AI 请求。
> **验收标准:**
> * 所有 AI 网络调用和密集计算必须在后台线程中执行。
> * 增强日志记录，包含 AI 请求时长、成功率等关键性能指标。
> * 引入精细化缓存机制，对重复性查询可返回缓存结果。

**用户故事 4.1: 增强的 Diff 预览与回滚体验**
> **作为一名经常使用 AI 修改功能的作者，** 我希望 Diff 预览界面更友好，并且能够轻松地回滚到多个历史版本，
> **以便** 我可以更直观地比较和选择 AI 的建议。
> **验收标准:**
> * Diff 预览界面优化，提供左右并排（Side-by-side）或行内（Inline）视图选项。
> * 增强事务回滚功能，允许用户在操作历史中进行多步撤销。
> * 在文档导出前，提供可选的“AI 校对”步骤。

## **史诗 5: 架构重构与优化**

> **作为 novelWriter 的核心开发者，** 我希望将 `NWAiApi` 重构为一个独立的 `novelwriter.api` 包，
> **以便** 实现更好的关注点分离，提升模块的可重用性，并为未来的插件系统或第三方集成打下坚实的基础。

**用户故事 5.0: 提取 `NWAiApi` 到独立的 `api` 包**
> **作为一名开发者，** 我需要将 `novelwriter/ai/api.py` 移动到新的 `novelwriter/api/` 目录下，并更新所有相关的引用，
> **以便** 使 AI 模块单向依赖于新的 `api` 模块，从而优化项目架构。
> **验收标准:**
> *   `novelwriter/ai/api.py` 被移动到 `novelwriter/api/api.py`。
> *   所有之前 `from novelwriter.ai.api import NWAiApi` 的引用都已更新为 `from novelwriter.api import NWAiApi`。
> *   `novelwriter.ai` 包不再包含 `api.py`。
> *   所有现有测试（尤其是 AI 相关的测试）都能成功通过，证明重构未破坏现有功能。

**用户故事 5.1 (修正版): 统一并简化 OpenAI Provider**
> **作为 novelWriter 的核心开发者，** 我希望将所有 OpenAI 兼容的连接逻辑统一到 `OpenAISDKProvider` 中，并移除基于 `httpx` 的 `OpenAICompatibleProvider`，
> **以便** 减少代码冗余、降低维护成本，并利用官方 SDK 的稳定性与健壮性来统一处理所有 OpenAI 及其兼容端点的连接。
> **验收标准:**
> 1.  **移除 `OpenAICompatibleProvider`:**
>     *   从项目中删除 `novelwriter/ai/providers/openai_compatible.py` 文件。
>     *   更新 Provider 工厂和 `AIConfig`，移除对 "openai" (兼容模式) Provider 的引用。
> 2.  **增强 `OpenAISDKProvider`:**
>     *   确保 `OpenAISDKProvider` 在连接到第三方 OpenAI 兼容端点（如 Ollama 的兼容 API）时，仅通过修改 `base_url` 即可正常工作。
>     *   保留所有必要的功能，如能力探测、模型列表获取等，但全部通过官方 SDK 的方式实现。
> 3.  **更新配置和 UI:**
>     *   在应用的设置界面，Provider 选项中不再有 "OpenAI Compatible" 和 "OpenAI Official SDK" 的区分，统一为一个 "OpenAI (SDK)" 选项。
>     *   确保连接测试功能 (`_test_ai_connection`) 能正常工作。
> 4.  **回归测试:**
>     *   所有 AI 相关功能（流式输出、模型切换、参数配置等）必须通过回归测试，确保功能的连续性。
