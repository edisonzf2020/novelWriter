# **第一部分：P0 - 基础框架与只读 API**

**阶段目标:** 搭建 AI 助手的核心技术框架，实现 `NWAiApi` 的基础结构和只读功能，并为用户提供一个最小化可用的 Copilot 交互界面。

## **史诗 0: 构建 AI 安全动作领域 API (`NWAiApi`)**

> **作为 novelWriter 的核心架构师，** 我希望设计并实现一个强类型、安全且支持事务的领域 API，
> **以便** 为上层的 AI Agent 提供一个标准化的、可控的接口，来与应用的核心数据和功能进行交互，确保所有 AI 操作的可追溯性、安全性和可回滚性。

**用户故事 0.0: 设计并实现 `NWAiApi` 的基础结构与数据模型**
> **作为一名开发者，** 我需要根据方案文档，在 `novelwriter/ai/` 目录下创建 `api.py`, `models.py`, `errors.py` 的骨架，
> **以便** 为 AI Agent 的所有领域操作定义统一的数据传输对象（DTOs）和异常类型。
> **验收标准:**
> * `models.py` 中定义了核心数据类，如 `DocumentRef`, `TextRange` 等。
> * `errors.py` 中定义了基础异常类，如 `NWAiError`。
> * `api.py` 中定义了 `NWAiApi` 类的基本结构。

**用户故事 0.1: 实现 API 的只读项目与文档接口**
> **作为 AI Agent，** 我需要能够通过 `NWAiApi` 查询项目元数据、文档列表和指定文档的文本内容，
> **以便** 我可以获取执行任务所需的基础上下文信息。
> **验收标准:**
> * 成功实现 `getProjectMeta()`, `listDocuments()`, `getCurrentDocument()`, `getDocText()` 等只读方法。
> * 所有方法都有完整的类型注解和文档字符串。
> * 为这些核心只读方法编写单元测试。

## **史诗 1: AI Copilot 基础框架与只读功能集成**

> **作为 novelWriter 的开发者，** 我希望为应用集成一个基础的、对现有系统影响最小的 AI Copilot 框架，
> **以便** 为后续更复杂的 AI 功能提供一个稳定且可扩展的平台，并为用户提供初步的 AI 辅助体验。

**用户故事 1.0: AI Copilot 面板的无缝集成**
> **作为一名作者，** 我希望在 novelWriter 的主界面右侧看到一个可停靠的 AI Copilot 面板，
> **以便** 我可以在不离开写作环境的情况下，与 AI 助手进行交互。
> **验收标准:**
> * 应用启动后，主窗口右侧默认显示一个名为 “AI Copilot” 的 `QDockWidget` 面板。
> * 面板可以被用户手动折叠、展开、分离和重新停靠。
> * 面板的 UI 风格自动遵循应用当前的主题，并支持国际化（i18n）。
> * 如果 AI 相关的可选依赖库未安装，应用正常启动，AI 面板不加载或显示友好提示。

**用户故事 1.1: AI 功能的独立配置**
> **作为一名注重隐私和自定义的用户，** 我希望能在应用的设置中找到专门的 AI 选项，
> **以便** 我可以根据自己的需要启用或禁用 AI 功能，并配置相关的模型参数。
> **验收标准:**
> * 在“设置”窗口中新增 “AI” 选项卡。
> * 提供总开关以启用/禁用 AI 功能，默认为禁用。
> * 提供配置项以设置 AI Provider，允许用户配置 `openai_base_url` 和 API Key。
> * 凭据优先从环境变量 `OPENAI_API_KEY` 读取。
> * AI 配置的加载/保存与主配置解耦，失败时不影响主程序。

**用户故事 1.2: 基础的 AI 文本建议与预览**
> **作为一名作者，** 我希望可以向 AI Copilot 请求文本建议并在应用前预览，
> **以便** 我可以安全、可控地利用 AI 提升写作效率。
> **验收标准:**
> * Copilot 面板包含输入框和消息区，能流式显示 AI 响应不卡顿 UI。
> * 提供至少 3 个基础快捷动作（如：“摘要”、“续写”）。
> * 当 AI 生成修改建议时，通过 `previewSuggestion` API 提供清晰的 Diff 预览。
> * P0 阶段写操作为手动应用，用户预览后需点击按钮确认。
> * AI 网络调用支持超时（默认 30 秒）和取消操作。

**用户故事 1.3: 可配置的 AI 模型管理与持久化**
> **作为一名频繁切换不同模型的作者，** 我希望在 AI Copilot 面板中快速查看和切换当前使用的 AI 模型，
> **以便** 根据不同写作任务选用最合适的模型，而无需重复配置。
> **验收标准:**
> * Copilot 面板底部显示当前模型名称，点击后打开模型选择界面，模型列表通过 OpenAI 兼容 API 实时获取并展示核心元数据。
> * 用户选择新模型后，Copilot 立即切换至该模型并把选择持久化到本地配置，界面同步更新当前模型文案。
> * 模型名称左侧提供模型图标按钮，点击进入模型参数设置对话框，可配置温度、最大生成长度等关键参数，设置需验证并持久化保存。
> * "设置 > AI" 中在填写或更新 Base URL 与 API Key 后主动校验凭据，校验通过则拉取可用模型清单并允许选择默认模型；失败需提示错误原因。
> * 应用重启后自动恢复上次选定的模型和参数，Copilot 面板及设置页面保持一致显示。

---
