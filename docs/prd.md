# 产品需求文档 (PRD): novelWriter AI 助手

**版本:** 2.0 (重构版)
**功能:** AI Copilot 集成
**产品经理:** John
**需求来源:** `novelWriter AI 助手集成方案 v1.1`
**编号规则:** Epic编号从0开始连续递增，Story编号格式为Epic.Story（从0开始）

---

## 1. 背景与目标

本文档定义了在 novelWriter 中集成一个 AI 辅助创作助手（代号 AI Copilot）的完整产品需求。目标是在不破坏现有架构的前提下，为 novelWriter 用户提供一个强大的、安全的、可配置的 AI 创作伙伴。

该助手将以右侧可停靠面板的形式存在，能够执行从内容建议、预览到安全写入、事务回滚等一系列操作。其核心是构建一个强大、安全的领域 API (`NWAiApi`)，作为 AI Agent 与 novelWriter 核心功能交互的唯一通道，确保所有 AI 操作的可控性、可追溯性和安全性。

项目将分三个阶段实施：P0 (基础框架与只读 API)，P1 (核心写入能力与事务)，P2 (完善、优化与生态扩展)。

---

## **第一部分：P0 - 基础框架与只读 API**

**阶段目标:** 搭建 AI 助手的核心技术框架，实现 `NWAiApi` 的基础结构和只读功能，并为用户提供一个最小化可用的 Copilot 交互界面。

### **史诗 0: 构建 AI 安全动作领域 API (`NWAiApi`)**

> **作为 novelWriter 的核心架构师，** 我希望设计并实现一个强类型、安全且支持事务的领域 API，
> **以便** 为上层的 AI Agent 提供一个标准化的、可控的接口，来与应用的核心数据和功能进行交互，确保所有 AI 操作的可追溯性、安全性和可回滚性。

**用户故事 0.0: 设计并实现 `NWAiApi` 的基础结构与数据模型**
> **作为一名开发者，** 我需要根据方案文档，在 `novelwriter/ai/` 目录下创建 `api.py`, `models.py`, `errors.py` 的骨架，
> **以便** 为 AI Agent 的所有领域操作定义统一的数据传输对象（DTOs）和异常类型。
> **验收标准:**
> * `models.py` 中定义了核心数据类，如 `DocumentRef`, `TextRange` 等。
> * `errors.py` 中定义了基础异常类，如 `NWAiError`。
> * `api.py` 中定义了 `NWAiApi` 类的基本结构。

**用户故事 0.1: 实现 API 的只读项目与文档接口**
> **作为 AI Agent，** 我需要能够通过 `NWAiApi` 查询项目元数据、文档列表和指定文档的文本内容，
> **以便** 我可以获取执行任务所需的基础上下文信息。
> **验收标准:**
> * 成功实现 `getProjectMeta()`, `listDocuments()`, `getCurrentDocument()`, `getDocText()` 等只读方法。
> * 所有方法都有完整的类型注解和文档字符串。
> * 为这些核心只读方法编写单元测试。

### **史诗 1: AI Copilot 基础框架与只读功能集成**

> **作为 novelWriter 的开发者，** 我希望为应用集成一个基础的、对现有系统影响最小的 AI Copilot 框架，
> **以便** 为后续更复杂的 AI 功能提供一个稳定且可扩展的平台，并为用户提供初步的 AI 辅助体验。

**用户故事 1.0: AI Copilot 面板的无缝集成**
> **作为一名作者，** 我希望在 novelWriter 的主界面右侧看到一个可停靠的 AI Copilot 面板，
> **以便** 我可以在不离开写作环境的情况下，与 AI 助手进行交互。
> **验收标准:**
> * 应用启动后，主窗口右侧默认显示一个名为 "AI Copilot" 的 `QDockWidget` 面板。
> * 面板可以被用户手动折叠、展开、分离和重新停靠。
> * 面板的 UI 风格自动遵循应用当前的主题，并支持国际化（i18n）。
> * 如果 AI 相关的可选依赖库未安装，应用正常启动，AI 面板不加载或显示友好提示。

**用户故事 1.1: AI 功能的独立配置**
> **作为一名注重隐私和自定义的用户，** 我希望能在应用的设置中找到专门的 AI 选项，
> **以便** 我可以根据自己的需要启用或禁用 AI 功能，并配置相关的模型参数。
> **验收标准:**
> * 在"设置"窗口中新增 "AI" 选项卡。
> * 提供总开关以启用/禁用 AI 功能，默认为禁用。
> * 提供配置项以设置 AI Provider，允许用户配置 `openai_base_url` 和 API Key。
> * 凭据优先从环境变量 `OPENAI_API_KEY` 读取。
> * AI 配置的加载/保存与主配置解耦，失败时不影响主程序。

**用户故事 1.2: 基础的 AI 文本建议与预览**
> **作为一名作者，** 我希望可以向 AI Copilot 请求文本建议并在应用前预览，
> **以便** 我可以安全、可控地利用 AI 提升写作效率。
> **验收标准:**
> * Copilot 面板包含输入框和消息区，能流式显示 AI 响应不卡顿 UI。
> * 提供至少 3 个基础快捷动作（如："摘要"、"续写"）。
> * 当 AI 生成修改建议时，通过 `previewSuggestion` API 提供清晰的 Diff 预览。
> * P0 阶段写操作为手动应用，用户预览后需点击按钮确认。
> * AI 网络调用支持超时（默认 30 秒）和取消操作。

---

## **第二部分：P1 - 核心功能与写入 API**

**阶段目标:** 将 AI 助手从“建议者”升级为“协作者”。核心是为 `NWAiApi` 赋予安全的写入能力，并引入事务和上下文管理机制。

### **史诗 2: AI 安全写入与事务化操作**

> **作为一名作者，** 我希望 AI 助手能够安全地执行写入操作，并且所有关键变更都是可回滚的，
> **以便** 我可以放心地授权 AI 对我的稿件进行实质性修改。

**用户故事 2.0: 为 `NWAiApi` 集成事务与审计功能**
> **作为 AI Agent，** 我需要在执行一系列写入操作前开启一个事务，并在操作完成后提交或回滚，
> **以便** 保证复杂操作的原子性和数据一致性。
> **验收标准:**
> * 实现 `begin_transaction()`, `commit_transaction()`, `rollback_transaction()` 接口。
> * 实现 `get_audit_log()` 接口，用于追踪 AI 发起的关键操作。

**用户故事 2.1: 实现 API 的安全写入与建议应用接口**
> **作为 AI Agent，** 我需要能够通过 `NWAiApi` 安全地修改文档内容或应用一个建议，
> **以便** 我可以在用户的授权下，对文学作品进行实质性的修改。
> **验收标准:**
> * 实现 `setDocText(..., apply=True)` 和 `applySuggestion()` 等写入方法。
> * 所有写入方法都必须在事务块内执行。
> * 实现安全栅栏，如对大量内容变更进行二次确认。

### **史诗 3: 增强的上下文理解与会话记忆**

> **作为一名创作者，** 我希望 AI 助手能够理解更广泛的上下文并记住我们之前的对话，
> **以便** AI 能够提供更贴切、更连贯的建议。

**用户故事 3.0: 灵活的上下文选择**
> **作为一名长篇小说作者，** 我希望在与 AI 交互时，可以手动指定当前的上下文范围，
> **以便** AI 的回答和建议能更精准地聚焦于我正在处理的部分。
> **验收标准:**
> * Copilot 面板中增加一个上下文范围选择器（选项："选区"、"当前文档"、"大纲"、"整个项目"）。
> * `NWAiApi` 的 `collectContext` 方法能根据所选范围正确收集上下文。
> * AI Copilot 具备基础的会话记忆能力。

**用户故事 3.1: 智能的 API 端点能力检测**
> **作为一名开发者，** 我希望 AI Provider 能够自动检测所连接的 API 端点支持哪些高级功能，
> **以便** 系统能够自动选择最优的协议路径，最大化功能可用性。
> **验收标准:**
> * `OpenAICompatibleProvider` 在首次连接时进行懒检测。
> * 能自动判断并优先使用 `POST /v1/responses` 接口，否则回退到 `POST /v1/chat/completions`。
> * 检测结果在会话级别缓存，并记入调试日志。

---

## **第三部分：P2 - 完善、优化与生态扩展**

**阶段目标:** 提升 AI Copilot 的性能、稳定性和用户体验，并引入对更多主流 AI 模型的支持，为用户提供更丰富的选择。

### **史诗 4: 性能优化与用户体验提升**

> **作为一名高频使用者，** 我希望 AI Copilot 的响应速度更快，交互更流畅，
> **以便** AI 辅助功能不会打断我的创作心流。

**用户故事 4.0: 优化的性能与响应机制**
> **作为一名追求效率的作者，** 我希望 AI 操作的后台处理机制得到优化，应用的界面绝不卡顿，
> **以便** 我可以随时取消不需要的 AI 请求。
> **验收标准:**
> * 所有 AI 网络调用和密集计算必须在后台线程中执行。
> * 增强日志记录，包含 AI 请求时长、成功率等关键性能指标。
> * 引入精细化缓存机制，对重复性查询可返回缓存结果。

**用户故事 4.1: 增强的 Diff 预览与回滚体验**
> **作为一名经常使用 AI 修改功能的作者，** 我希望 Diff 预览界面更友好，并且能够轻松地回滚到多个历史版本，
> **以便** 我可以更直观地比较和选择 AI 的建议。
> **验收标准:**
> * Diff 预览界面优化，提供左右并排（Side-by-side）或行内（Inline）视图选项。
> * 增强事务回滚功能，允许用户在操作历史中进行多步撤销。
> * 在文档导出前，提供可选的“AI 校对”步骤。

### **史诗 5: 扩展 AI 模型支持与生态**

> **作为一名追求最佳生成效果的用户，** 我希望能够选择使用 Anthropic (Claude) 系列模型，
> **以便** 我可以根据不同的创作任务选择最适合的 AI 模型。

**用户故事 5.0: 集成 Anthropic (Claude) 模型支持**
> **作为一名希望使用 Claude 模型的作者，** 我希望可以在 AI 设置中选择并配置 Anthropic 作为我的 AI Provider，
> **以便** 利用 Claude 模型在长文本处理和创意写作方面的优势。
> **验收标准:**
> * 在 AI Provider 列表中增加 “Anthropic” 选项。
> * 允许用户在设置中配置 Anthropic API Key 和模型名称。
> * 系统能通过 `AnthropicProvider` 与 Anthropic API 成功通信。
> * `pyproject.toml` 中包含 `ai-anthropic` 可选依赖分组。