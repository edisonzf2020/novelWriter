# 6. Epic 1: novelWriter MCP混合架构与职责分离重构

**Epic目标**: 通过统一API中间层和AI模块职责分离重构，实现完整的混合MCP架构，将novelWriter核心功能抽象为高性能本地工具，同时集成外部MCP工具生态，为AI agent深度参与文学创作提供稳定、安全、高性能的技术基础。

**集成要求**: 保持现有所有功能完整性，通过依赖注入避免循环导入，实现零破坏性架构演进。

## Story 1.1: 统一API中间层创建

**用户故事**:  
作为一个 系统架构师，  
我想要创建统一的数据访问API层，  
这样所有模块就能够通过一致的接口访问项目数据，避免直接依赖core模块。

**验收标准**:
1. 创建`novelwriter/api/novelwriter_api.py`，实现`NovelWriterAPI`类
2. 抽象出8个核心数据访问方法：项目元数据、文档列表、文档读写、项目树、搜索、标签、统计
3. 实现统一的权限控制、参数验证和错误处理
4. 建立与现有`NWProject`的清洁依赖注入关系
5. 添加完整的类型提示和API文档

**集成验证**:
- IV1: 验证统一API不影响现有应用启动时间
- IV2: 验证API调用延迟小于5ms (P95)
- IV3: 验证现有所有功能保持完全可用

## Story 1.2: AI模块职责分离重构

**用户故事**:  
作为一个 AI功能维护者，  
我想要将AI模块的职责清晰分离，  
这样通用数据访问和AI业务逻辑就能够独立演进和维护。

**验收标准**:
1. 将`ai/api.py`重构为`ai/ai_core.py`，保留AI特定业务逻辑
2. 重构`AICoreService`类，通过依赖注入使用`NovelWriterAPI`
3. 保留所有AI核心功能：对话、建议、校对、记忆管理
4. 更新`extensions/ai_copilot/`的依赖注入以使用新架构
5. 确保所有AI provider和配置系统继续工作

**集成验证**:
- IV1: 验证现有AI Copilot功能100%可用且性能无回退
- IV2: 验证AI对话、建议、校对功能完全正常
- IV3: 验证AI配置和provider系统无任何破坏

## Story 1.3: 混合MCP服务器基础架构

**用户故事**:  
作为一个 AI agent开发者，  
我想要有一个统一的工具调用接口，  
这样我就能够无缝地使用本地和外部工具来操作novelWriter。

**验收标准**:
1. 创建`MCPServer`类，基于FastMCP框架
2. 实现统一的`call_tool`接口，支持工具路由
3. 建立本地工具和外部工具的注册发现机制
4. 实现基于streamable-http的传输协议支持
5. 集成安全控制和性能监控基础设施

**集成验证**:
- IV1: 验证MCP服务器不影响应用正常使用
- IV2: 验证工具路由准确性和响应时间
- IV3: 验证与外部MCP协议的标准兼容性

## Story 1.4: 本地工具抽象层实现

**用户故事**:  
作为一个 AI agent，  
我想要能够通过标准化接口调用novelWriter的核心功能，  
这样我就能够高效地进行文档操作、搜索和项目管理。

**验收标准**:
1. 基于`NovelWriterAPI`实现8个核心本地工具类
2. 所有工具实现零开销的直接调用，延迟<10ms (P95)
3. 建立统一的工具基类和参数验证Schema
4. 实现工具结果的标准化格式化
5. 添加完整的单元测试覆盖，确保与直接API调用结果一致

**集成验证**:
- IV1: 验证本地工具性能优于外部MCP调用5倍以上
- IV2: 验证工具调用结果与现有功能完全一致
- IV3: 验证工具异常处理不影响应用稳定性

## Story 1.5: 外部MCP工具集成和发现

**用户故事**:  
作为一个 AI agent，  
我想要能够访问外部MCP工具生态（如时间服务、GitHub集成等），  
这样我就能够扩展novelWriter的功能边界。

**验收标准**:
1. 实现MCP协议客户端，支持streamable-http传输
2. 建立外部工具自动发现和动态注册机制
3. 实现工具调用的超时管理和重试机制
4. 建立连接健康检查和自动重连
5. 实现外部工具调用的结果缓存优化

**集成验证**:
- IV1: 验证外部工具不可用时不影响本地工具使用
- IV2: 验证外部工具调用延迟小于200ms (P95)
- IV3: 验证网络异常的优雅降级和恢复

## Story 1.6: 安全控制和权限管理

**用户故事**:  
作为一个 系统管理员，  
我想要确保所有工具调用都经过安全验证和审计，  
这样我就能够控制访问权限并跟踪所有操作记录。

**验收标准**:
1. 在`NovelWriterAPI`集成权限验证机制
2. 实现参数清理和注入攻击防护
3. 建立完整的审计日志系统，记录所有工具调用
4. 实现数据敏感性分级和屏蔽机制
5. 建立外部工具的资源使用限制

**集成验证**:
- IV1: 验证安全控制开销小于1ms，不影响性能
- IV2: 验证审计日志准确记录且不泄露敏感信息
- IV3: 验证权限控制与现有用户体验保持一致

## Story 1.7: 错误处理和故障恢复机制

**用户故事**:  
作为一个 系统维护者，  
我想要系统能够智能处理各种错误和故障，  
这样就能够确保服务的高可用性和用户体验连续性。

**验收标准**:
1. 实现错误分类系统（瞬态、永久、降级）
2. 建立指数回退重试机制，不同工具类型使用不同策略
3. 实现熔断器模式，防止级联故障
4. 建立降级服务机制，关键功能在故障时继续可用
5. 实现完整的错误追踪和告警体系

**集成验证**:
- IV1: 验证故障处理不影响正常工具调用性能
- IV2: 验证故障恢复后所有功能完全恢复正常
- IV3: 验证降级服务保持数据一致性和用户体验

## Story 1.8: 性能监控和指标收集

**用户故事**:  
作为一个 运维工程师，  
我想要实时监控系统性能和工具调用指标，  
这样就能够及时发现问题并进行针对性优化。

**验收标准**:
1. 实现`PerformanceMonitor`类，收集延迟、成功率、并发数
2. 建立实时性能统计（P95、P99、平均值）计算
3. 实现性能基准对比和趋势分析
4. 建立性能告警机制，超阈值自动通知
5. 集成性能监控到状态栏显示

**集成验证**:
- IV1: 验证指标收集开销<0.5%，对工具调用性能影响极小
- IV2: 验证性能监控界面符合现有UI设计规范
- IV3: 验证告警机制准确性，避免误报

## Story 1.9: 用户界面集成和配置管理

**用户故事**:  
作为一个 novelWriter用户，  
我想要在熟悉的界面中管理混合架构功能，  
这样我就能够在不改变工作习惯的前提下享受工具化的强大功能。

**验收标准**:
1. 扩展AI设置对话框，添加"混合架构"配置选项卡
2. 在主状态栏集成工具调用实时指标显示
3. 实现外部MCP工具管理界面，支持启用/禁用和配置
4. 建立配置验证和热更新机制
5. 严格遵循现有PyQt6主题和国际化系统

**集成验证**:
- IV1: 验证新UI界面与现有界面视觉风格完全一致
- IV2: 验证配置界面支持浅色/深色主题切换
- IV3: 验证UI响应时间不影响用户编辑体验(<100ms)

## Story 1.10: 测试框架和质量保证

**用户故事**:  
作为一个 质量工程师，  
我想要有完整的测试框架确保架构重构质量，  
这样就能够保证每次发布都是高质量和可靠的。

**验收标准**:
1. 建立针对架构重构的专项测试套件
2. 实现回归测试，确保现有功能100%保持可用
3. 建立性能基准测试，验证重构后性能不退化
4. 实现故障注入测试，验证错误处理和恢复机制
5. 建立持续集成测试，确保每次代码变更的质量

**集成验证**:
- IV1: 验证测试套件执行时间合理(<5分钟)
- IV2: 验证测试覆盖率达到90%以上，包含所有关键路径
- IV3: 验证测试在CI/CD环境中的稳定性和可靠性

---
