# 9. 源码树组织

## 8.1 现有项目结构（重构为统一访问）

```plaintext
novelwriter/
├── ai/                          # ✅ AI功能模块（重构访问方式）
│   ├── __init__.py             # AIConfig等导出
│   ├── ai_core.py              # 🔄 原api.py重命名，AI核心业务逻辑
│   ├── providers/              # ✅ AI provider抽象层
│   ├── config.py               # ✅ AI配置管理
│   ├── models.py               # ✅ AI数据模型
│   ├── cache.py                # ✅ AI缓存
│   └── ...                     # ✅ 其他AI组件
├── extensions/
│   └── ai_copilot/             # ✅ 现有AI Copilot UI（重构访问）
└── core/, gui/, formats/       # ✅ 现有核心架构
```

## 8.2 新增文件组织（统一API中间层）

```plaintext
novelwriter/
├── api/                        # 🆕 统一API中间层
│   ├── __init__.py             # NovelWriterAPI等主要导出
│   ├── novelwriter_api.py      # 🆕 统一的内部数据访问API
│   ├── mcp_server.py          # 🆕 MCP工具化暴露层
│   ├── tools/                 # MCP工具实现
│   │   ├── __init__.py
│   │   ├── base.py            # 🆕 统一工具基类和Schema
│   │   ├── registry.py        # 🆕 工具注册表
│   │   ├── local_tools.py     # 🆕 本地工具包装器
│   │   ├── project_tools.py   # 项目信息工具
│   │   ├── document_tools.py  # 文档操作工具
│   │   └── search_tools.py    # 搜索功能工具
│   ├── external_mcp/           # 外部MCP管理
│   │   ├── __init__.py
│   │   ├── connection.py      # MCP连接管理
│   │   ├── discovery.py       # 工具发现机制
│   │   └── client.py          # MCP协议客户端
│   ├── base/                   # 共享基础组件
│   │   ├── __init__.py
│   │   ├── security.py        # 安全控制器
│   │   ├── performance.py     # 性能监控
│   │   └── config.py          # 混合配置管理
│   ├── models.py               # 数据模型
│   └── exceptions.py           # 统一异常处理
```

## 8.3 集成指导原则

**依赖关系图**（统一API中间层）：
```plaintext
novelwriter/ai/功能模块              # AI功能模块
novelwriter/extensions/ai_copilot/   # AI Copilot UI
novelwriter/api/mcp_server.py       # MCP工具服务器
    ↓ 统一访问（所有模块）
novelwriter/api/novelwriter_api.py  # 统一API中间层
    ↓ 唯一数据访问路径
novelwriter/core/                    # 核心数据层
```

---
