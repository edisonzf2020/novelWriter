# novelWriter MCP混合架构与职责分离重构 PRD

**版本:** v3.0 (架构重构版)  
**创建日期:** 2025年9月24日  
**PM:** John (BMAD PM)  
**基于:** Brownfield Enhancement PRD模板 v2.0  
**状态:** 已完成架构对齐版本

---

## 1. 项目分析和上下文 (Project Analysis and Context)

### 1.1 现有项目概述 (Existing Project Overview)

#### 分析来源 (Analysis Source)
- 架构文档分析：基于完整的MCP混合架构设计文档 (727行)
- 代码深度分析：ai/api.py (1912行) 职责分离需求确认
- IDE-based新鲜分析：实时项目状态评估

#### 当前项目状态 (Current Project State)
novelWriter是一个**成熟的AI增强创作应用**，已完成Story 5.0开发，具备完整的AI Copilot集成。当前需要通过**架构演进型重构**实现MCP工具化，将现有功能抽象为标准化工具接口，支持AI agent深度参与创作工作流。

### 1.2 可用文档分析 (Available Documentation Analysis)

#### 可用文档清单
- [x] 技术栈文档：Python 3.10+, PyQt6 6.4+, MCP Python SDK
- [x] 源码树/架构：完整的混合MCP架构设计
- [x] 编码标准：PEP 8, 类型提示, camelCase方法名
- [x] API文档：现有NWAiApi和新设计的统一API
- [x] 外部API文档：MCP协议标准和工具生态
- [x] 技术债务文档：ai/api.py职责混合问题识别
- [ ] UX/UI指南：需要基于现有AI Copilot扩展

### 1.3 增强范围定义 (Enhancement Scope Definition)

#### 增强类型
- [x] **Major Feature Modification** - MCP工具化是核心功能改进
- [x] **Integration with New Systems** - MCP协议和外部工具生态集成
- [x] **Technology Stack Enhancement** - 职责分离重构和统一API

#### 增强描述
通过创建统一API中间层和AI模块职责分离重构，将novelWriter核心功能抽象为高性能本地工具，同时集成外部MCP工具生态，实现完整的混合MCP架构。

#### 影响评估
- [x] **Moderate to Significant Impact** - 需要架构层重构但保持功能完整性

### 1.4 目标和背景上下文 (Goals and Background Context)

#### 目标
• 实现统一API中间层，提供一致的数据访问接口和权限控制
• 完成AI模块职责分离，ai/api.py → ai/ai_core.py，提升架构清洁度
• 建立高性能本地工具抽象层，支持<10ms延迟的工具调用
• 集成外部MCP工具生态，扩展功能边界和创作能力
• 确保100%向后兼容性，现有用户工作流无任何影响

#### 背景上下文
现有架构虽然功能完整，但存在职责分离不清的技术债务。ai/api.py混合了通用数据访问和AI特定业务逻辑，导致维护复杂性。同时，为了支持AI agent深度参与创作，需要将功能工具化并标准化。通过架构重构可以解决技术债务，同时为MCP集成奠定坚实基础。

#### 变更日志
| 变更 | 日期 | 版本 | 描述 | 作者 |
|------|------|------|------|------|
| 初始创建 | 2025-09-24 | v3.0 | 基于架构重构需求的完整PRD | John (BMAD PM) |

---

## 2. 需求 (Requirements)

### 2.1 功能需求 (Functional Requirements)

**FR1**: 系统必须创建统一API中间层`api/novelwriter_api.py`，作为所有数据访问的唯一入口点，替代各模块对core的直接访问。

**FR2**: 系统必须将现有`ai/api.py`重构为`ai/ai_core.py`，分离通用数据访问功能到统一API层，保留AI特定业务逻辑。

**FR3**: 系统必须实现`MCPServer`类，支持本地工具直接调用和外部MCP工具协议调用的统一路由。

**FR4**: 系统必须实现8个核心本地工具：项目信息、文档读写、项目树、创建文档、全局搜索、标签列表、字数统计。

**FR5**: 系统必须支持通过MCP协议连接和调用外部工具生态（时间服务、GitHub集成等）。

**FR6**: 所有新模块必须通过构造函数依赖注入接收API实例，避免循环导入和紧耦合。

### 2.2 非功能需求 (Non-Functional Requirements)

**NFR1**: 重构过程必须保持现有AI Copilot功能100%可用，不得破坏任何现有用户工作流。

**NFR2**: 性能要求 - 统一API访问延迟<5ms，本地工具调用延迟<10ms (P95)，外部MCP工具调用延迟<200ms (P95)。

**NFR3**: 新增架构层的内存占用不得超过现有应用内存使用的15%。

**NFR4**: 系统必须支持优雅降级，外部工具不可用时本地功能完全正常。

### 2.3 兼容性需求 (Compatibility Requirements)

**CR1**: 现有`extensions/ai_copilot/`模块必须无需修改即可继续工作，保持API接口向后兼容。

**CR2**: 现有`AIConfig`系统必须保持完全兼容，新增配置通过扩展实现，无任何格式变更。

**CR3**: 项目文件格式、缓存格式、配置文件格式必须保持100%兼容，确保用户数据无损。

**CR4**: 现有UI主题系统、国际化机制必须完全兼容，新增界面遵循现有设计规范。

---

## 3. 用户界面增强目标 (User Interface Enhancement Goals)

### 3.1 与现有UI集成 (Integration with Existing UI)
新增UI组件必须完全集成到现有PyQt6应用架构，遵循当前主题系统、本地化机制。所有新界面作为现有AI Copilot扩展点的自然延伸，保持视觉一致性。

### 3.2 修改/新增界面和视图 (Modified/New Screens and Views)
**新增界面**: MCP混合架构配置面板、性能监控仪表板、外部工具管理界面、工具调用历史查看器
**修改界面**: AI设置对话框（添加混合架构选项卡）、主状态栏（集成性能指标）

### 3.3 UI一致性要求 (UI Consistency Requirements)
严格遵循现有PyQt6主题系统，支持浅色/深色主题，使用现有图标库，采用统一字体和间距规范，支持完整国际化和RTL语言。

---

## 4. 技术约束和集成要求 (Technical Constraints and Integration Requirements)

### 4.1 现有技术栈 (Existing Technology Stack)
**语言**: Python 3.10+  
**框架**: PyQt6 6.4+  
**数据库**: XML + JSON项目文件  
**基础设施**: 桌面应用架构  
**外部依赖**: httpx, asyncio + QThread

### 4.2 集成方案 (Integration Approach)
**数据库集成策略**: 通过NovelWriterAPI提供统一数据访问，职责分离，事务管理复用  
**API集成策略**: 依赖注入架构，向后兼容保证，渐进式迁移  
**前端集成策略**: PyQt6扩展，主题系统复用，国际化集成  
**测试集成策略**: pytest框架扩展，回归测试强化，性能基准测试

### 4.3 代码组织和标准 (Code Organization and Standards)
**文件结构方案**: 新增api/目录，ai/目录重构，保持现有core/结构  
**命名规范**: PascalCase类名，camelCase方法名，职责导向文件命名  
**编码标准**: PEP 8，强制类型提示，完整文档字符串  
**文档标准**: ADR文档化，Sphinx API文档，详细重构指南

### 4.4 部署和运维 (Deployment and Operations)
**构建过程集成**: pyproject.toml扩展，可选依赖机制  
**部署策略**: 零风险回滚，渐进式启用，用户透明升级  
**监控和日志**: 现有logging扩展，结构化指标收集，健康检查集成  
**配置管理**: CONFIG系统扩展，智能默认值，配置验证

### 4.5 风险评估和缓解 (Risk Assessment and Mitigation)
**技术风险**: 循环导入风险 → 依赖注入缓解，性能回归风险 → 基准测试缓解  
**集成风险**: 功能破坏风险 → 向后兼容测试缓解，配置冲突风险 → 命名空间缓解  
**部署风险**: 依赖兼容风险 → 可选依赖缓解，用户体验风险 → 透明升级缓解  
**缓解策略**: 分阶段交付，完整测试覆盖，实时监控告警，详细文档支持

---

## 5. Epic和故事结构 (Epic and Story Structure)

### 5.1 Epic方案 (Epic Approach)
**Epic结构决策**: **单一综合Epic** - MCP混合架构作为内聚的技术增强，职责分离重构、统一API创建、工具抽象化都服务于同一目标。技术依赖关系紧密，分离会破坏架构完整性。

---

## 6. Epic 1: novelWriter MCP混合架构与职责分离重构

**Epic目标**: 通过统一API中间层和AI模块职责分离重构，实现完整的混合MCP架构，将novelWriter核心功能抽象为高性能本地工具，同时集成外部MCP工具生态，为AI agent深度参与文学创作提供稳定、安全、高性能的技术基础。

**集成要求**: 保持现有所有功能完整性，通过依赖注入避免循环导入，实现零破坏性架构演进。

### Story 1.1: 统一API中间层创建

**用户故事**:  
作为一个 系统架构师，  
我想要创建统一的数据访问API层，  
这样所有模块就能够通过一致的接口访问项目数据，避免直接依赖core模块。

**验收标准**:
1. 创建`novelwriter/api/novelwriter_api.py`，实现`NovelWriterAPI`类
2. 抽象出8个核心数据访问方法：项目元数据、文档列表、文档读写、项目树、搜索、标签、统计
3. 实现统一的权限控制、参数验证和错误处理
4. 建立与现有`NWProject`的清洁依赖注入关系
5. 添加完整的类型提示和API文档

**集成验证**:
- IV1: 验证统一API不影响现有应用启动时间
- IV2: 验证API调用延迟小于5ms (P95)
- IV3: 验证现有所有功能保持完全可用

### Story 1.2: AI模块职责分离重构

**用户故事**:  
作为一个 AI功能维护者，  
我想要将AI模块的职责清晰分离，  
这样通用数据访问和AI业务逻辑就能够独立演进和维护。

**验收标准**:
1. 将`ai/api.py`重构为`ai/ai_core.py`，保留AI特定业务逻辑
2. 重构`AICoreService`类，通过依赖注入使用`NovelWriterAPI`
3. 保留所有AI核心功能：对话、建议、校对、记忆管理
4. 更新`extensions/ai_copilot/`的依赖注入以使用新架构
5. 确保所有AI provider和配置系统继续工作

**集成验证**:
- IV1: 验证现有AI Copilot功能100%可用且性能无回退
- IV2: 验证AI对话、建议、校对功能完全正常
- IV3: 验证AI配置和provider系统无任何破坏

### Story 1.3: 混合MCP服务器基础架构

**用户故事**:  
作为一个 AI agent开发者，  
我想要有一个统一的工具调用接口，  
这样我就能够无缝地使用本地和外部工具来操作novelWriter。

**验收标准**:
1. 创建`MCPServer`类，基于FastMCP框架
2. 实现统一的`call_tool`接口，支持工具路由
3. 建立本地工具和外部工具的注册发现机制
4. 实现基于streamable-http的传输协议支持
5. 集成安全控制和性能监控基础设施

**集成验证**:
- IV1: 验证MCP服务器不影响应用正常使用
- IV2: 验证工具路由准确性和响应时间
- IV3: 验证与外部MCP协议的标准兼容性

### Story 1.4: 本地工具抽象层实现

**用户故事**:  
作为一个 AI agent，  
我想要能够通过标准化接口调用novelWriter的核心功能，  
这样我就能够高效地进行文档操作、搜索和项目管理。

**验收标准**:
1. 基于`NovelWriterAPI`实现8个核心本地工具类
2. 所有工具实现零开销的直接调用，延迟<10ms (P95)
3. 建立统一的工具基类和参数验证Schema
4. 实现工具结果的标准化格式化
5. 添加完整的单元测试覆盖，确保与直接API调用结果一致

**集成验证**:
- IV1: 验证本地工具性能优于外部MCP调用5倍以上
- IV2: 验证工具调用结果与现有功能完全一致
- IV3: 验证工具异常处理不影响应用稳定性

### Story 1.5: 外部MCP工具集成和发现

**用户故事**:  
作为一个 AI agent，  
我想要能够访问外部MCP工具生态（如时间服务、GitHub集成等），  
这样我就能够扩展novelWriter的功能边界。

**验收标准**:
1. 实现MCP协议客户端，支持streamable-http传输
2. 建立外部工具自动发现和动态注册机制
3. 实现工具调用的超时管理和重试机制
4. 建立连接健康检查和自动重连
5. 实现外部工具调用的结果缓存优化

**集成验证**:
- IV1: 验证外部工具不可用时不影响本地工具使用
- IV2: 验证外部工具调用延迟小于200ms (P95)
- IV3: 验证网络异常的优雅降级和恢复

### Story 1.6: 安全控制和权限管理

**用户故事**:  
作为一个 系统管理员，  
我想要确保所有工具调用都经过安全验证和审计，  
这样我就能够控制访问权限并跟踪所有操作记录。

**验收标准**:
1. 在`NovelWriterAPI`集成权限验证机制
2. 实现参数清理和注入攻击防护
3. 建立完整的审计日志系统，记录所有工具调用
4. 实现数据敏感性分级和屏蔽机制
5. 建立外部工具的资源使用限制

**集成验证**:
- IV1: 验证安全控制开销小于1ms，不影响性能
- IV2: 验证审计日志准确记录且不泄露敏感信息
- IV3: 验证权限控制与现有用户体验保持一致

### Story 1.7: 错误处理和故障恢复机制

**用户故事**:  
作为一个 系统维护者，  
我想要系统能够智能处理各种错误和故障，  
这样就能够确保服务的高可用性和用户体验连续性。

**验收标准**:
1. 实现错误分类系统（瞬态、永久、降级）
2. 建立指数回退重试机制，不同工具类型使用不同策略
3. 实现熔断器模式，防止级联故障
4. 建立降级服务机制，关键功能在故障时继续可用
5. 实现完整的错误追踪和告警体系

**集成验证**:
- IV1: 验证故障处理不影响正常工具调用性能
- IV2: 验证故障恢复后所有功能完全恢复正常
- IV3: 验证降级服务保持数据一致性和用户体验

### Story 1.8: 性能监控和指标收集

**用户故事**:  
作为一个 运维工程师，  
我想要实时监控系统性能和工具调用指标，  
这样就能够及时发现问题并进行针对性优化。

**验收标准**:
1. 实现`PerformanceMonitor`类，收集延迟、成功率、并发数
2. 建立实时性能统计（P95、P99、平均值）计算
3. 实现性能基准对比和趋势分析
4. 建立性能告警机制，超阈值自动通知
5. 集成性能监控到状态栏显示

**集成验证**:
- IV1: 验证指标收集开销<0.5%，对工具调用性能影响极小
- IV2: 验证性能监控界面符合现有UI设计规范
- IV3: 验证告警机制准确性，避免误报

### Story 1.9: 用户界面集成和配置管理

**用户故事**:  
作为一个 novelWriter用户，  
我想要在熟悉的界面中管理混合架构功能，  
这样我就能够在不改变工作习惯的前提下享受工具化的强大功能。

**验收标准**:
1. 扩展AI设置对话框，添加"混合架构"配置选项卡
2. 在主状态栏集成工具调用实时指标显示
3. 实现外部MCP工具管理界面，支持启用/禁用和配置
4. 建立配置验证和热更新机制
5. 严格遵循现有PyQt6主题和国际化系统

**集成验证**:
- IV1: 验证新UI界面与现有界面视觉风格完全一致
- IV2: 验证配置界面支持浅色/深色主题切换
- IV3: 验证UI响应时间不影响用户编辑体验(<100ms)

### Story 1.10: 测试框架和质量保证

**用户故事**:  
作为一个 质量工程师，  
我想要有完整的测试框架确保架构重构质量，  
这样就能够保证每次发布都是高质量和可靠的。

**验收标准**:
1. 建立针对架构重构的专项测试套件
2. 实现回归测试，确保现有功能100%保持可用
3. 建立性能基准测试，验证重构后性能不退化
4. 实现故障注入测试，验证错误处理和恢复机制
5. 建立持续集成测试，确保每次代码变更的质量

**集成验证**:
- IV1: 验证测试套件执行时间合理(<5分钟)
- IV2: 验证测试覆盖率达到90%以上，包含所有关键路径
- IV3: 验证测试在CI/CD环境中的稳定性和可靠性

---

## 7. 检查清单结果报告 (Checklist Results Report)

**PM检查清单完成状态**:
- ✅ 项目范围明确定义（架构重构型增强）
- ✅ 现有系统深度分析（ai/api.py职责分离识别）
- ✅ 技术约束全面评估（兼容性和性能要求）
- ✅ 风险识别和缓解策略（重构风险和向后兼容）
- ✅ 用户故事与架构要求对齐（支撑所有架构决策）
- ✅ 验收标准具体可测试（每个故事都有明确IV验证）
- ✅ Epic结构逻辑合理（单一内聚Epic适合技术依赖）

---

## 8. 后续步骤 (Next Steps)

### 8.1 架构师提示 (Architect Prompt)
"PRD已完成架构对齐更新，确认了统一API中间层创建、AI模块职责分离重构等关键要求。请基于此PRD验证架构文档的实施细节，特别确认：1)NovelWriterAPI的详细接口设计，2)ai/api.py → ai/ai_core.py重构的具体步骤，3)依赖注入链条的安全性验证。架构文档应包含详细的重构时序和回滚策略。"

### 8.2 开发团队提示 (Development Team Prompt)
"请严格按照Epic 1中定义的故事序列开始开发，特别注意Story 1.1-1.3的基础架构必须在其他故事之前完成。每个故事的集成验证(IV)要求是强制性的，确保：1)现有功能100%保持可用，2)性能指标严格达标，3)向后兼容性完全验证。从Story 1.1统一API创建开始，建立架构重构基础。"

---

**文档状态**: ✅ 已完成架构对齐版本  
**审核状态**: ✅ 已通过PM检查清单验证  
**下一步行动**: 架构师验证实施细节，开发团队开始Story 1.1

---

**创建摘要**:
这份PRD v3.0专门针对架构重构需求进行了全面更新，解决了原有PRD与架构文档的不一致性问题。主要成果包括：明确了统一API中间层的创建需求、AI模块职责分离重构(ai/api.py → ai/ai_core.py)、重新设计了10个逻辑清晰的故事序列。所有需求、故事和验收标准都与架构文档的设计决策完全对齐，为开发团队提供了准确的实施指导。
