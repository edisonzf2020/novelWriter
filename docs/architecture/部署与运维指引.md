# 部署与运维指引

- **依赖安装**：AI 功能依赖 `httpx` 等可选库，通过 `pip install novelWriter[ai]` 或
  `pip install .[ai]` 进行安装；上线前运行
  `python -m pytest tests/test_ai/test_ai_suggestions.py` 验证环境满足可选依赖。
- **上线检查**：在预生产环境中执行 `CONFIG.ai.create_provider()` 或 `novelwriter --info`，确认
  能力检测成功，并保存 `CONFIG.ai.getProviderCapabilitiesSummary()` 输出以备诊断。
- **回滚与发布策略**：若官方 SDK 出现重大异常，立即将 `AIConfig.provider` 切换回
  `openai`（HTTP 兼容方案）、重启 Copilot，并恢复 `.env` 或配置中的 httpx 兼容设置。上线阶段
  建议采用金丝雀策略：测试环境完成回归后，于生产先启用约 10% 用户并持续 30 分钟监控请求
  成功率 ≥ 99%、Responses→Chat 降级次数 < 3；若指标异常立即回滚。
- **监控与告警方案**：部署后需观察请求成功率、Responses→Chat 降级触发次数、SDK 错误码分布
  和平均响应时延。建议阈值：成功率 < 98% 或降级 ≥ 5 次/5 分钟触发 P1 告警；
  `invalid_request_error` 连续 3 次触发 P2 告警；运维手册需列出 Grafana 仪表盘和日志查询入口。
- **兼容端点验证**：需要对 OpenAI 兼容服务做冒烟测试时，使用
  `pytest --compat-env-file=test.env` 装载 `NOVELWRITER_COMPAT_*` 配置后运行
  `tests/test_ai/test_openai_compat_live.py::test_openai_compat_responses_endpoint_live`；未配置时测试会
  自动跳过，避免影响常规 CI。
- **回归验证计划**：阶段性回归清单——单元（`tests/test_ai/test_ai_suggestions.py`、
  `tests/test_ai/test_providers.py`、`tests/test_ai/test_openai_sdk_provider.py`）、GUI（
  `tests/test_gui/test_gui_preferences_ai.py`、`tests/test_gui/test_gui_ai_copilot.py`）、兼容端点
  （`tests/test_ai/test_openai_compat_live.py` 配合 `test.env`）。触发时机：主干合并前、发布候选回归、
  线上异常复盘；责任人：迭代开发者负责单元/集成，轮值 QA 负责 GUI/兼容检查。
