# Story 2.1: NWAiApi 写入与建议应用

## Status
Done

## Story
**As an** AI Agent,
**I want** 通过 NWAiApi 安全地修改文档或应用建议,
**so that** 在获得作者授权后，AI 可以以可控、可回滚的方式更新 novelWriter 项目内容。

## Acceptance Criteria
1. `setDocText(handle, text, apply=True)` 在活动事务内执行时写入文档内容；`apply=False` 返回 Diff 预览而不持久化；对于无效句柄或非事务上下文抛出 `NWAiApiError`。[Source: docs/prd/第二部分p1-核心功能与写入-api.md#用户故事-04-实现-api-的安全写入与建议应用接口][Source: novelwriter/ai/api.py:436]
2. `previewSuggestion(handle, TextRange, newText)` 生成可读 Diff，并返回带唯一 ID 的 `Suggestion`；`applySuggestion(id)` 复用现有事务机制应用该建议（含 Diff/Undo 信息），重复或未知 ID 抛出 `NWAiApiError`。[Source: docs/prd/第一部分p0-基础框架与只读-api.md#用户故事-13-基础的-ai-文本建议与预览][Source: novelwriter/ai/models.py:22]
3. 写入操作完成后将变更详情推送到事务上下文的 `_pending_operations`，提交时写入审计日志；回滚调用挂接的 undo 回调恢复原文本。[Source: novelwriter/ai/api.py:221]
4. 与 `CONFIG.ai` 的选项保持一致：`dry_run_default` 控制 `setDocText` 的默认 `apply` 行为，`ask_before_apply` 在 `applySuggestion` 需要人工确认时提供占位逻辑（记录审计并返回待确认状态）。[Source: novelwriter/ai/config.py:26][Source: novelwriter/dialogs/preferences.py:868]
5. 新增/扩展测试覆盖成功写入、Diff 预览、建议应用、重复应用拒绝、事务回滚恢复及审计记录内容；现有只读及事务测试全部通过。

## Tasks / Subtasks
- [x] 在 `NWAiApi` 中实现 `_snapshot_document(handle)` 和 `_write_document(handle, text)` 辅助方法，基于 `NWDocument` 提供的读写 API，返回原文本和 undo 回调。(AC: 1,3)[Source: novelwriter/core/document.py:120]
- [x] 实现 `setDocText`：
  - 校验事务与句柄，提取原文本与新文本。
  - 若 `apply` 为 False 或 `CONFIG.ai.dry_run_default` 为 True，则生成 Diff（使用 `difflib.unified_diff`），返回预览信息而不写入。
  - 若 `apply` 为 True，写入文档、更新项目索引/统计（调用 `NWProject.updateCounts()`），并将 `_PendingOperation` 推入当前事务队列以支持回滚与审计。(AC: 1,3)[Source: novelwriter/core/project.py:330]
- [x] 为 `previewSuggestion` 创建内存缓存（如 `self._pending_suggestions: dict[str, _SuggestionPayload]`），生成 Diff、预览文本与唯一 ID，并记录审计条目。(AC: 2)
- [x] 实现 `applySuggestion`：
  - 校验事务、查找缓存，应用写入逻辑（复用 `setDocText` 内部写入路径），应用成功后清理缓存并审计；若 `CONFIG.ai.ask_before_apply` 为 True，可返回状态标识要求 UI 进行二次确认。(AC: 2,4)
- [x] 在写入/回滚流程中补充审计记录，确保提交时 `transaction.operation.committed` 包含操作摘要，回滚时 `transaction.operation.rolled_back` 包含 Diff/描述。(AC: 3)
- [x] 扩展 `_queue_pending_operation` 支持携带 undo 回调与 Diff 元数据，提交时写入审计日志，回滚时按逆序执行 undo。(AC: 3)
- [x] 新增 `tests/test_ai/test_api_write.py`：覆盖
  - Dry-run 与 apply 场景、预览 Diff 内容
  - 建议生成+应用+重复应用拒绝
  - 事务回滚恢复原文本与审计记录
  - 配置选项（`dry_run_default`, `ask_before_apply`）对行为的影响。(AC: 5)
- [x] 更新 GUI 测试 `tests/test_gui/test_gui_ai_copilot.py` 或新增补充测试，验证 Dock 在启用写入后可引用事务 API 进行占位提示（可使用 monkeypatch 断言 `refresh_from_config` 在写入后仍正常工作）。(AC: 4,5)

## Dev Notes

### Previous Story Insights
- Story 2.0 已提供事务栈、审计记录与 `_queue_pending_operation` 能力，本故事需在写入操作中充分利用该框架，避免重复事务校验逻辑。[Source: docs/stories/2.0.nwaiapi-transactions.md][Source: novelwriter/ai/api.py:304]
- Story 1.2 中 `CONFIG.ai` 暴露的 `dry_run_default` / `ask_before_apply` 需在写入流程中尊重，以与偏好设置保持一致。[Source: novelwriter/ai/config.py:35]

### Safety & Diff Generation
- 建议使用 `difflib.unified_diff(old.splitlines(), new.splitlines(), ...)` 生成文本差异，写入 `Suggestion.diff` 字段，并在预览响应中返回；注意控制 Diff 长度（可限制最大行数）以防 UI 卡顿。
- 在写入前进行内容长度/变更比例检查（例如限制一次写入超过 X 字符时记录警告审计，为后续安全栅栏打基础）。

### Undo Strategy
- 使用 `_pending_operations` 存储 undo 回调：写入前保存原文本，回滚时写回；对建议应用可共享 `setDocText` 逻辑，避免重复实现。
- 需考虑多个写入作用于同一文档的情况，确保 undo 顺序正确执行（使用栈结构逆序回滚）。

### Testing Notes
- 可借助 `pytest` fixture 构造简化文档，使用 `monkeypatch` 固定 `uuid4`、`datetime` 以确保 Diff 与审计日志可预测。
- Dry-run 与 apply 流程需断言审计记录条目数、内容与操作目标，保证符合合规审计要求。

## Testing
- `pytest tests/test_ai/test_api_write.py`
- `pytest tests/test_ai/test_api_transactions.py tests/test_ai/test_api_readonly.py`

## Change Log
| Date | Version | Description | Author |
| --- | --- | --- | --- |
| 2025-09-17 | 0.1 | Initial draft | Codex (Scrum Master) |

## Dev Agent Record
### Agent Model Used
_TBD_

### Debug Log References
_TBD_

### Completion Notes List
_TBD_

### File List
_TBD_

## QA Results

### 质量评估结果 - PASS ✅

**测试架构师审查日期:** 2025-09-17  
**审查者:** Quinn (Test Architect)

#### ✅ 功能完整性
- **setDocText 实现:** ✅ 完整实现事务校验、预览/应用模式、undo回调支持
- **Suggestions 工作流:** ✅ previewSuggestion 和 applySuggestion 完整实现，包含缓存机制
- **事务集成:** ✅ 与现有事务栈良好集成，支持回滚恢复
- **配置集成:** ✅ dry_run_default 和 ask_before_apply 配置正确实现

#### ✅ 代码质量 
- **架构设计:** ✅ 良好的模块化设计，复用现有事务基础设施
- **错误处理:** ✅ 适当的错误边界和异常处理
- **类型检查:** ✅ Pyright 通过，无类型错误
- **代码风格:** ✅ 符合项目编码规范

#### ✅ 测试覆盖 
- **单元测试:** ✅ 10个测试用例全部通过，覆盖核心功能路径
- **边界测试:** ✅ 包含错误情况、回滚测试、权限校验
- **集成测试:** ✅ 事务和只读API测试继续通过 (12个测试)

#### ✅ 安全性
- **事务隔离:** ✅ 所有写入操作要求活跃事务
- **输入校验:** ✅ 句柄验证、范围检查、缓存验证
- **审计追踪:** ✅ 完整的审计日志记录

#### ⚠️ 风险识别
- **中等风险:** ask_before_apply 功能当前为占位实现，需要后续UI集成
- **低风险:** Diff生成无长度限制，大文档可能影响性能

#### 📋 质量指标
- **测试通过率:** 100% (22/22 相关测试)
- **代码覆盖率:** 估计 >90% (基于测试范围)
- **类型安全:** 100% (Pyright 通过)
- **需求跟踪性:** 100% (5/5 AC 验证通过)

### 推荐
1. **生产就绪:** 代码质量良好，可以合并到主分支
2. **后续改进:** 考虑为Diff生成添加长度限制保护
3. **UI集成:** ask_before_apply 需要在后续故事中完整实现

**最终评级:** ⭐⭐⭐⭐⭐ (5/5) - 优秀实现
