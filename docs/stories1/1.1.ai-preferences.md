# Story 1.1: AI 配置选项卡与配置解耦

## Status
Done

## Story
**As a** 注重隐私和可控性的 novelWriter 用户,
**I want** 在偏好设置中独立管理 AI Copilot 的启用状态与连接参数,
**so that** 我能按需启用 AI 功能，并安全地配置 Provider、Endpoint 与凭据。

## Acceptance Criteria
1. 偏好设置对话框新增 “AI” 选项卡，包含启用开关、Provider 下拉、Base URL 与 API Key 等字段；控件遵循现有主题与 i18n。[Source: prd/第一部分p0-基础框架与只读-api.md#用户故事-12-ai-功能的独立配置][Source: novelwriter/dialogs/preferences.py:120]
2. `Config.ai` 提供懒加载的 `AIConfig` 实例，支持读取/保存用户配置并在缺失时提供安全默认值。[Source: docs/AI/AI_ASSISTANT_PLAN.md#7.1-ai-配置解耦-aiConfig][Source: novelwriter/config.py:594]
3. AI 配置保存到配置文件的 `AI` 区段；`OPENAI_API_KEY` 环境变量存在时优先使用并在 UI 中提示，避免明文持久化。[Source: prd/第一部分p0-基础框架与只读-api.md#用户故事-12-ai-功能的独立配置]
4. 当 AI 被禁用或缺少依赖时，偏好设置与运行时均显示清晰提示且不会影响其它功能（例如 AI Dock 继续显示停用信息）。[Source: novelwriter/extensions/ai_copilot/dock.py:25]
5. 为 AI 配置新增单元与 GUI 测试，覆盖默认值、读写行为、环境变量优先级及偏好页面交互。

## Tasks / Subtasks
- [ ] 在 `novelwriter/ai/config.py` 实现 `AIConfig` 类（enabled、provider、model、openai_base_url、api_key、timeout、max_tokens、dry_run_default、ask_before_apply 等字段），提供 `load_from_main_config(conf)` 与 `save_to_main_config(conf)` 方法并处理 `OPENAI_API_KEY` 覆盖逻辑。(AC: 2,3) [Source: docs/AI/AI_ASSISTANT_PLAN.md#7.1-ai-配置解耦-aiConfig]
- [ ] 更新 `novelwriter/config.py`：
  - 添加懒加载属性 `Config.ai`，在导入失败时返回禁用占位对象。(AC: 2) [Source: docs/AI/AI_ASSISTANT_PLAN.md#7.1-ai-配置解耦-aiConfig]
  - 在 `loadConfig`/`saveConfig` 中调用 `AIConfig.load_from_main_config` 与 `save_to_main_config`，并在 `saveConfig` 输出 `AI` 区段。(AC: 2,3) [Source: novelwriter/config.py:594][Source: novelwriter/config.py:741]
  - 确保 `_checkOptionalPackages` 或相关初始化不会因缺少 AI 依赖抛异常，仅记录日志。(AC: 4)
- [ ] 扩展偏好设置 GUI：
  - 在 `GuiPreferences.buildForm` 中新增 “AI” 标签页，使用 `NPagedSideBar` + `NScrollableForm` 构建表单，控件包含启用开关（NSwitch）、Provider 下拉、Base URL `QLineEdit`、API Key 输入（口令模式）及关于环境变量的提示文本。(AC: 1,3) [Source: novelwriter/dialogs/preferences.py:120]
  - 保存时更新 `CONFIG.ai` 属性，关闭时不破坏其它标签页布局。(AC: 1)
  - 根据 `CONFIG.ai.enabled` 动态启用/禁用 Provider 配置控件，并在禁用状态显示醒目提示。(AC: 1,4)
- [ ] 在 `novelwriter/extensions/ai_copilot/dock.py` 增强状态同步：监听 `CONFIG.ai.enabled` 或提供刷新方法，以便偏好设置更新后可刷新占位文本；保持向后兼容。(AC: 4)
- [ ] 测试：
  - 新增 `tests/test_ai/test_ai_config.py` 覆盖 `AIConfig` 默认值、读写、环境变量优先级、不完整配置容错。(AC: 5)
  - 新增 `tests/test_gui/test_gui_preferences_ai.py`（pytest-qt）验证 AI 选项卡渲染、启用开关、禁用提示、保存后调用 `CONFIG.saveConfig()` 写入 `AI` 区段。(AC: 5)

## Dev Notes

### Previous Story Insights
- Story 1.1 已交付 Dock 占位并依赖 `CONFIG.ai.enabled`，本故事提供真实配置后需确保 Dock 在设置变更时能刷新状态。[Source: docs/stories/1.1.ai-copilot-dock.md]
- Story 0.2 提供只读 API，可在 AI 选项卡中引导用户了解启用后可访问的上下文，保持文案与提示一致。[Source: docs/stories/0.2.nwaiapi-read-only.md]

### Configuration Architecture
- `novelwriter/config.py` 负责读取 `novelWriter.conf`，现有结构按 section 保存；新增 `AI` section 时需保持向后兼容，旧版本缺失该节也能安全加载。[Source: novelwriter/config.py:741]
- `AIConfig` 应与 `Config.ai` 懒加载协同，避免在无 AI 功能的环境中导入失败；建议在 `Config.__init__` 不直接导入 `novelwriter.ai`，仅在属性访问时处理异常。[Source: docs/AI/AI_ASSISTANT_PLAN.md#7.1-ai-配置解耦-aiConfig]

### Preferences UI
- 复用 `extensions/configlayout` 提供的辅助控件以保持样式一致；新增控件需遵循 `self.mainForm.addRow` 结构并提供帮助文本。[Source: novelwriter/extensions/configlayout.py]
- 提示文本应通过 `self.tr()` 包装，以便 i18n；API Key 字段建议展示 “已从环境变量加载” 提示并禁用编辑，除非用户选择覆盖。[Source: prd/第一部分p0-基础框架与只读-api.md#用户故事-12-ai-功能的独立配置]

### Optional Dependency Handling
- Dock 与未来 Provider 代码会读取 `CONFIG.ai.enabled` 等字段；需提供事件或回调刷新（例如在保存后发射信号或调用 Dock 的 `updateTheme()`/`_applyTranslations()`），暂可通过 SHARED 事件或简单重新实例化实现。[Source: novelwriter/extensions/ai_copilot/dock.py:25]

### Testing Strategy
- 对 `AIConfig` 使用临时 `NWConfigParser` 对象与 `tmp_path` 写入文件，验证 load/save 互通；利用 `monkeypatch.environ` 模拟环境变量。[Source: tests/test_ai/test_api_readonly.py]
- GUI 测试通过 `nwGUI` fixture 打开偏好设置，切换到 “AI” 选项卡，模拟用户操作并断言控件状态及 `CONFIG.ai` 字段更新；需要设置 `QT_QPA_PLATFORM=offscreen`。[Source: tests/conftest.py:101]

## Testing
- 安装 `pip install -r tests/requirements.txt` 后运行：
  - `QT_QPA_PLATFORM=offscreen pytest tests/test_gui/test_gui_preferences_ai.py`
  - `pytest tests/test_ai/test_ai_config.py tests/test_gui/test_gui_ai_copilot.py`

## Change Log
| Date | Version | Description | Author |
| --- | --- | --- | --- |
| 2025-09-17 | 0.1 | Initial draft | Codex (Scrum Master) |

## Dev Agent Record
### Agent Model Used
_TBD_

### Debug Log References
_TBD_

### Completion Notes List
_TBD_

### File List
_TBD_

## QA Results
- **PASS** 偏好设置新增 AI 标签页覆盖启用开关、Provider、Base URL、API Key 等控件，并保存后刷新 Copilot Dock 状态以满足 AC（见 novelwriter/dialogs/preferences.py:866 与 novelwriter/extensions/ai_copilot/dock.py:42）。
- **Risk** AI 配置变更目前仅通过 Dock 刷新同步，后续若引入更多 AI 组件需统一通知机制以避免状态不一致。
- **Testing** `pytest tests/test_ai/test_ai_config.py`；`QT_QPA_PLATFORM=offscreen pytest tests/test_gui/test_gui_preferences_ai.py`（均通过，参见 tests/test_ai/test_ai_config.py 与 tests/test_gui/test_gui_preferences_ai.py）。
