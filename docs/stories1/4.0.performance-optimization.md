# Story 4.0: 优化的性能与响应机制

## Status
Done

## Story
**As a** 追求效率的作者,
**I want** AI 操作在多个 Provider 下都具备后台处理与实时可控能力,
**so that** 我可以随时取消不需要的 AI 请求，并保持界面始终流畅。

## Acceptance Criteria
1. 所有 AI 网络调用和密集计算必须在后台线程或任务队列中执行，并对 `openai` HTTP Provider 与 `openai-sdk` Provider 一视同仁地支持取消与超时控制。[Source: docs/AI/AI_ASSISTANT_PLAN.md#11-风险与缓解]
2. 增强日志记录与性能指标，至少覆盖请求时长、成功率、Provider 降级路径与缓存命中率，并将数据写入 `.ai/debug-log.md` 供调试使用。[Source: docs/architecture/部署与运维指引.md]
3. 引入可配置的精细化缓存机制，对重复性查询在 Provider 层去重，支持 TTL/LRU 策略并提供命中率监控，确保与 `AIConfig` 集成可开关。[Source: docs/prd.md#史诗-4-性能优化与用户体验提升]

## Tasks / Subtasks
- [x] Task 1: 建立统一的后台执行与取消机制 (AC: 1)
  - [x] 为 `NWAiApi` 与 Provider 调用构建基于 `QThreadPool`/`QRunnable` 的执行器，并保持 UI 主线程无阻塞。[Source: docs/AI/AI_ASSISTANT_PLAN.md#11-风险与缓解]
  - [x] 在执行器层实现超时与取消通道，覆盖 HTTP 与官方 SDK Provider 的请求流程。[Source: docs/stories/3.2.openai-official-sdk-integration.md]
  - [x] 通过信号/槽向 `AICopilotDock` 回报进度与取消结果，遵守分层约束。[Source: docs/architecture/增强功能影响分析.md#新增功能必须遵守的设计标准]
  - [x] 编写并发冲突与取消后的资源清理测试，确保无悬挂线程。[Source: docs/source/technical/tests.rst]
- [x] Task 2: 构建性能指标与日志采集管线 (AC: 2)
  - [x] 在 `novelwriter/ai/performance.py` 中实现指标聚合器，记录响应时延、成功率、降级次数与 Provider 名称。[Source: docs/architecture/部署与运维指引.md]
  - [x] 将指标通过 `AIConfig` 控制开关并输出到 `.ai/debug-log.md`，遵守配置解耦原则。[Source: docs/brownfield-architecture.md#核心架构原则-源自-docstechnical]
  - [x] 为指标采集添加单元测试与日志断言，覆盖成功/失败/降级场景。[Source: docs/source/technical/tests.rst]
  - [x] 更新运维指引，描述新增指标字段与告警阈值。[Source: docs/architecture/部署与运维指引.md]
- [x] Task 3: 设计 Provider 级缓存层 (AC: 3)
  - [x] 在 `novelwriter/ai/cache.py` 引入可配置的查询缓存，支持内容哈希 + Provider 配置作为键并记录命中率。[Source: docs/prd.md#史诗-4-性能优化与用户体验提升]
  - [x] 为 `openai` HTTP 与 `openai-sdk` Provider 添加缓存装饰器或适配器，确保降级路径仍能命中缓存。[Source: docs/stories/3.2.openai-official-sdk-integration.md]
  - [x] 提供缓存策略配置（大小、TTL、LRU）并与 `AIConfig` 同步，禁用时不加载模块。[Source: docs/architecture/增强功能影响分析.md#新增功能必须遵守的设计标准]
  - [x] 编写缓存有效性与内存占用测试，验证命中率统计与淘汰策略。[Source: docs/source/technical/tests.rst]
- [x] Task 4: 性能回归与用户体验验证 (AC: 1,2,3)
  - [x] 编写高并发模拟测试，确保 UI 响应时间 <100ms，取消响应 <500ms。[Source: docs/AI/AI_ASSISTANT_PLAN.md#14-成功指标与性能要求]
  - [x] 验证调试日志包含 Provider 识别、时长、降级、缓存命中等字段，且格式被 QA 接受。[Source: docs/architecture/部署与运维指引.md]
  - [x] 评估缓存策略对内存与磁盘的影响，记录基线指标供 Story 4.1 复用。[Source: docs/stories/4.1.enhanced-diff-preview.md]
  - [x] 更新 QA 回归清单，加入性能与缓存专项测试说明。[Source: docs/architecture/部署与运维指引.md]

## Dev Notes

### Previous Story Insights
- Story 3.1 已在 Provider 层实现懒检测与缓存，性能指标需复用其能力缓存结构以避免重复探测。[Source: docs/stories/3.1.api-endpoint-capability-detection.md]
- Story 3.2 引入 `openai-sdk` Provider 并实现端点降级与 `input` 结构转换，性能优化必须确保异步与缓存同时支持该 Provider。[Source: docs/stories/3.2.openai-official-sdk-integration.md]
- Story 2.1 的写入与建议应用流程已具备 Diff 缓存与事务审计，可复用其挂起操作与日志结构来记录性能事件。[Source: docs/stories/2.1.nwaiapi-write-ops.md]

### Data Models
- 继续复用 `ProviderSettings` 与 `ProviderCapabilities` 结构记录缓存策略与能力标签，禁止引入 GUI 依赖。[Source: docs/brownfield-architecture.md#核心架构原则-源自-docstechnical]
- 性能指标可作为 `AIConfig` 的扩展字段或 `PerformanceSample` 数据类，需遵守现有配置解耦模式。[Source: docs/brownfield-architecture.md#核心架构原则-源自-docstechnical]

### API Specifications
- `NWAiApi` 的异步执行需保持与事务/审计接口兼容，确保性能日志记录在相同审计通道中。[Source: docs/AI/AI_ASSISTANT_PLAN.md#11-风险与缓解]
- Provider 层必须提供统一的 `generate`/`stream` 接口，新增缓存与指标不得破坏原有调用契约。[Source: docs/stories/3.2.openai-official-sdk-integration.md]

### Component Specifications
- `AICopilotDock` 通过信号/槽更新 UI 状态，后台任务完成后需要发送进度与取消信号以保持解耦。[Source: docs/architecture/增强功能影响分析.md#新增功能必须遵守的设计标准]
- 性能指标展示可复用现有调试日志面板或配置窗口提示，不应在 UI 层直接访问 `ai` 包。[Source: docs/brownfield-architecture.md#核心架构原则-源自-docstechnical]

### File Locations
- 线程管理: `novelwriter/ai/threading.py` (新建)。[Source: docs/architecture/源码树与模块组织.md]
- 性能指标: `novelwriter/ai/performance.py` (新建/扩展)。[Source: docs/architecture/源码树与模块组织.md]
- 缓存机制: `novelwriter/ai/cache.py` (扩展)。[Source: docs/architecture/源码树与模块组织.md]
- Provider 适配: `novelwriter/ai/providers/` 与 `novelwriter/ai/api.py` (修改)。[Source: docs/architecture/源码树与模块组织.md]
- UI 集成: `novelwriter/extensions/ai_copilot/` (更新进度信号/取消按钮)。[Source: docs/architecture/集成点与外部依赖.md#内部集成点]

### Testing Requirements
- 使用 `pytest` 与 `pytest-qt` 编写异步与 UI 交互测试，必要时设置 `QT_QPA_PLATFORM=offscreen`。[Source: docs/source/technical/tests.rst]
- 回归测试需覆盖并发取消、缓存命中、日志输出与 Provider 降级路径，确保多 Provider 组合稳定。[Source: docs/architecture/部署与运维指引.md]

### Technical Constraints
- 必须保持 Python 3.7+ 与 PyQt6>=6.4.0 兼容，使用线程池时遵守 Qt 主线程规则。[Source: docs/architecture/高层架构.md]
- 性能功能需通过 `AIConfig` 可配置/禁用，禁用时不得加载新增模块以保证冷启动性能。[Source: docs/architecture/增强功能影响分析.md#新增功能必须遵守的设计标准]

### Performance Targets
- UI 操作响应 <100ms、取消响应 <500ms、缓存命中率 ≥30%，并对指标进行日志记录供后续监控。[Source: docs/AI/AI_ASSISTANT_PLAN.md#14-成功指标与性能要求]

### Project Structure Notes
- 所有新增文件置于 `novelwriter/ai/` 与 `novelwriter/extensions/ai_copilot/`，符合分层架构；无须修改 `core` 与 `formats` 层结构。[Source: docs/brownfield-architecture.md#源码树与模块组织]

## Testing
- `pytest tests/test_ai/test_performance.py tests/test_ai/test_threading.py tests/test_ai/test_cache.py`

## Change Log
| Date | Version | Description | Author |
| --- | --- | --- | --- |

## Dev Agent Record
### Agent Model Used
- GPT-5 Codex (Codex CLI)

### Debug Log References
- `source writer/bin/activate && python -m pytest tests/test_ai/test_threading.py tests/test_ai/test_performance.py tests/test_ai/test_cache.py`
- `source writer/bin/activate && python -m pytest`

### Completion Notes List
- 引入 `novelwriter/ai/threading.py`，Copilot 请求改用共享 QThreadPool，支持取消与超时管控。
- 新增性能跟踪器与配置钩子，指标写入 `.ai/debug-log.md` 并在 `AIConfig` 中开放开关。
- 构建 Provider 级缓存组件，整合 `NWAiApi` 并覆盖 HTTP/SDK Provider 降级与测试。
- 更新运维指引与 Story 测试套件，覆盖线程、性能与缓存行为。

### File List
- novelwriter/ai/threading.py
- novelwriter/ai/performance.py
- novelwriter/ai/cache.py
- novelwriter/extensions/ai_copilot/handler.py
- novelwriter/ai/api.py
- novelwriter/ai/config.py
- novelwriter/ai/providers/openai_sdk.py
- tests/test_ai/test_threading.py
- tests/test_ai/test_performance.py
- tests/test_ai/test_cache.py
- docs/architecture/部署与运维指引.md

## QA Results

### Review Date: 2025-09-20

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment
- `novelwriter/ai/threading.py` 将 Copilot 调用卸载至 Qt 线程池，结合取消令牌与截止时间避免 UI 阻塞。
- `novelwriter/extensions/ai_copilot/handler.py` 在请求生命周期内多次检查中断并确保流式响应安全关闭。
- `novelwriter/ai/api.py` 的性能 span 覆盖缓存命中、降级与审计事件，满足 AC#2 的指标与记录要求。
- `novelwriter/ai/cache.py` 实现的 ProviderQueryCache 提供 TTL+LRU 管控，并与性能跟踪器联动更新命中统计。

### Refactoring Performed
- 无代码调整，本次评审仅进行静态分析与流程验证。

### Compliance Check
- Coding Standards: ✓ 新增模块遵守项目 PEP 8/命名约定。
- Project Structure: ✓ 新功能保持在 `novelwriter/ai` 与扩展层，符合分层原则。
- Testing Strategy: ✓ 新增 `tests/test_ai` 覆盖缓存、线程与性能跟踪。
- All ACs Met: ✓ 三项验收标准均有实现与测试支撑。

### Improvements Checklist
- [x] 验证后台执行与取消机制（novelwriter/ai/threading.py）
- [x] 检查性能日志与缓存指标输出（novelwriter/ai/performance.py, novelwriter/ai/cache.py）
- [x] 增补 GUI 层取消/超时的集成测试用例（建议使用 pytest-qt）
- [x] 在包含真实 provider 的环境中复跑 `pytest` 验证 `.ai/debug-log.md` 写入权限（2025-09-20：`QT_SCALE_FACTOR=1 pytest --compat-env-file=test.env` → 538 通过 / 15 跳过，`.ai/debug-log.md` 记录新增轨迹）

### Security Review
- 未引入敏感信息或新增网络面向接口；缓存键仅包含模型与提示上下文，无 PII 暴露风险。

### Performance Considerations
- 后台线程池避免阻塞主线程，缓存命中会提前返回且记录命中详情。
- 已在虚拟环境中执行 `source writer/bin/activate && python -m pytest`，结果：537 通过、16 跳过、耗时约 54s。
- 使用真实 Provider 配置执行 `QT_SCALE_FACTOR=1 pytest --compat-env-file=test.env`，结果：538 通过、15 跳过，并确认 `.ai/debug-log.md` 持续写入性能样本。

### Files Modified During Review
- 无（仅阅读与评审）。

### Gate Status
Gate: PASS → docs/qa/gates/4.0-performance-optimization.yml
Risk profile: 未执行（本次评审未触发 risk-profile 流程）
NFR assessment: 未执行（本次评审未触发 nfr-assess 流程）

### Recommended Status
[✓ Ready for Done]