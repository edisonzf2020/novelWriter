# Story 3.2: 引入 OpenAI 官方 Python SDK Provider

## Status
Done

## Story
**As a** AI Copilot 维护者,
**I want** 在现有 Provider 体系中集成官方 OpenAI Python SDK 并提供可配置切换,
**so that** 可以减少协议变更导致的请求错误并提升对最新能力的兼容性。

## Acceptance Criteria
1. 在 `AIConfig` 和 Provider 工厂中新增 "openai-sdk" 选项，启用后 `NWAiApi` 通过官方 `openai.OpenAI` 客户端执行 `/v1/responses` 与 `/v1/chat/completions` 请求，并保留原有 `openai` 兼容实现作为回退策略。
2. 官方 SDK Provider 能正确处理 `input` 载荷（包含字符串与复合多段输入），避免日志中 `Invalid type for 'input': expected string, but got array.` 的错误；当 `/v1/responses` 不可用时自动降级到 `/v1/chat/completions` 并记录调试日志。
3. 能力探测与模型列表通过官方 SDK (`client.models.list`/`retrieve`) 实现，返回结果映射至 `ProviderCapabilities` 结构，并写入审核日志以供 UI 查询。
4. `AIConfig` 持久化模型/参数时兼容新 Provider，`novelwriter/dialogs/preferences.py` 中的 Provider 下拉和连接校验按钮支持选择、保存和回显 "OpenAI Official SDK"，未安装 SDK 时显示可用性提醒。
5. `pyproject.toml` 的 `ai` 可选依赖扩展包含兼容版本的 `openai` 包，缺失依赖时 Copilot 展示友好提示；新增单元与 GUI 测试覆盖 Provider 构建、流式输出、错误映射和 UI 切换场景，并通过 CI。

## Tasks / Subtasks
- [x] Task 1: 构建官方 SDK Provider (AC: 1,2,3)
  - [x] 在 `novelwriter/ai/providers/` 下新增 `openai_sdk.py`，封装 `openai.OpenAI` 客户端，复用现有 `ProviderCapabilities` 结构并支持流式输出、工具调用与响应端点回退。[Source: docs/brownfield-architecture.md#核心架构原则-源自-docstechnical]
  - [x] 统一错误处理，将 `openai.APIStatusError` 等异常映射到 `NWAiProviderError`，并在 `NWAiApi` 审核日志中记录失败原因。[Source: docs/architecture/增强功能影响分析.md#新增功能必须遵守的设计标准]
  - [x] 通过官方 SDK 的 `responses.create` 与 `chat.completions.create` API，实现 `input` 结构转换，确保兼容现有 `NWAiApi.streamChatCompletion` 消息格式。

- [x] Task 2: 扩展配置与工厂 (AC: 1,4,5)
  - [x] 更新 `AIConfig`，为 `provider` 字段加入 "openai-sdk" 枚举值，确保 `load/save`、`build_provider_settings` 与 `create_provider` 支持官方 SDK，并处理缺失依赖时的 `availability_reason`。[Source: docs/architecture/核心架构原则-源自-docstechnical.md#配置解耦]
  - [x] 调整 `novelwriter/ai/providers/factory.py` 与 `__init__.py` 注册新 Provider，维持懒加载和可选依赖策略。
  - [x] 修改 `novelwriter/dialogs/preferences.py` Provider 下拉与连接校验逻辑，允许用户选择官方 SDK，并在未安装 `openai` 包时显示禁用提示。

- [x] Task 3: 界面与体验联动 (AC: 1,2,4)
  - [x] 在 `AICopilotDock` / `CopilotRequestManager` 中检测 Provider 切换，必要时调用 `NWAiApi.resetProvider()`，并在状态栏提示当前 Provider 类型。[Source: docs/architecture/集成点与外部依赖.md#内部集成点]
  - [x] 更新日志与错误提示文案，明确官方 SDK 回退策略及依赖缺失信息。

- [x] Task 4: 依赖与打包 (AC: 5)
  - [x] 更新 `pyproject.toml` `ai` 可选依赖以包含 `openai>=1.0`（与 httpx 共存），同步 `requirements-dev.txt`。
  - [x] 在 `docs/architecture/部署与运维指引.md` 补充安装步骤与诊断命令（如 `pip install novelWriter[ai]` 安装 SDK、`OPENAI_LOG` 诊断）。

- [x] Task 5: 测试覆盖 (AC: 2,3,4,5)
  - [x] 新增 `tests/test_ai/test_openai_sdk_provider.py`，通过 monkeypatch 模拟 `openai` 客户端，覆盖成功响应、端点降级、模型列表与错误映射。
  - [x] 扩展 `tests/test_ai/test_ai_config.py` / `tests/test_gui/test_gui_preferences_ai.py`，验证 Provider 切换、依赖缺失提醒与配置持久化。
  - [x] 更新 `tests/test_gui/test_gui_ai_copilot.py` 覆盖 UI 显示当前 Provider 标签与切换后状态同步。

## Dev Notes

### Previous Story Insights
- Story 3.1 的端点能力检测当前依赖自研 httpx 流程，通过官方 SDK 实现需要复用 `ProviderCapabilities` 输出并保持会话缓存逻辑。[Source: docs/stories/3.1.api-endpoint-capability-detection.md]

### Data Models
- `ProviderCapabilities` 与 `ProviderSettings` 是跨 Provider 的标准数据结构，新实现必须复用并避免引入 GUI 依赖。[Source: docs/brownfield-architecture.md#核心架构原则-源自-docstechnical]

### API Specifications
- `NWAiApi.streamChatCompletion` 期望 Provider 支持流式迭代，同时记录审计日志并在失败时抛出 `NWAiApiError`，官方 SDK Provider 需维持该契约。[Source: novelwriter/ai/api.py]

### Component Specifications
- AI Copilot UI 通过 `AICopilotDock.refresh_from_config()` 读取 `CONFIG.ai` 状态，新增 Provider 后需保持相同刷新机制并通过信号/槽刷新文案。[Source: novelwriter/extensions/ai_copilot/dock.py]

### File Locations
- Provider 逻辑位于 `novelwriter/ai/providers/`，UI 扩展在 `novelwriter/extensions/ai_copilot/`，配置在 `novelwriter/ai/config.py`，符合 Brownfield 架构定义的分层要求。[Source: docs/architecture/源码树与模块组织.md#项目结构-集成后]

### Testing Requirements
- 维持 `pytest` 与 `pytest-qt` 流程，需在测试中 mock 官方 SDK 响应，并确保 `pip install novelWriter[ai]` 后所有新测试通过。[Source: docs/architecture/部署与运维指引.md]

### Technical Constraints
- 遵守分层架构与可选依赖策略；未安装官方 SDK 时应用仍需正常运行并保持提示友好。[Source: docs/architecture/增强功能影响分析.md#新增功能必须遵守的设计标准]

### UI/UX Notes
- Provider 下拉已在缺失官方 SDK 时禁用并给出指向 `pip install novelWriter[ai]` 的提示；切换后状态栏会显示当前 Provider，布局与快捷键均与既有控件一致，无额外可访问性限制。

## Project Structure Notes
- 新增 Provider 文件置于 `novelwriter/ai/providers/`，UI 调整局限于 `extensions/ai_copilot`，符合源码层级规划，无需修改核心 MVC 分层。[Source: docs/architecture/源码树与模块组织.md#项目结构-集成后]

## Testing
- `pytest tests/test_ai/test_openai_sdk_provider.py tests/test_ai/test_ai_config.py tests/test_gui/test_gui_preferences_ai.py tests/test_gui/test_gui_ai_copilot.py`

## Change Log
| Date | Version | Description | Author |
| --- | --- | --- | --- |
| 2025-09-21 | 1.0 | Implemented official OpenAI SDK provider integration and UI/packaging updates | James (Dev) |
| 2025-09-20 | 0.1 | Draft story for integrating official OpenAI Python SDK provider | Bob (Scrum Master) |

## Dev Agent Record
### Agent Model Used
- GPT-5 Codex (Codex CLI)

### Debug Log References
- `source writer/bin/activate && pip install 'openai>=1.0,<2.0'`
- `source writer/bin/activate && pytest -q tests/test_ai/test_ai_config.py`
- `source writer/bin/activate && pytest -q tests/test_ai/test_providers.py`
- `source writer/bin/activate && pytest -q tests/test_ai/test_openai_sdk_provider.py`
- `source writer/bin/activate && pytest -q tests/test_gui/test_gui_preferences_ai.py`
- `source writer/bin/activate && pytest -q tests/test_gui/test_gui_ai_copilot.py`
- `source writer/bin/activate && NOVELWRITER_COMPAT_BASE=http://192.168.1.29:1234 NOVELWRITER_COMPAT_KEY=123456 NOVELWRITER_COMPAT_MODEL=qwen3-next-80b-a3b-instruct-mlx pytest tests/test_ai/test_openai_compat_live.py::test_openai_compat_responses_endpoint_live`
(以上命令全部通过)

### Completion Notes List
- Added `novelwriter/ai/providers/openai_sdk.py` implementing the official OpenAI SDK provider with capability detection, streaming adapters, and graceful endpoint fallback.
- Extended configuration, factory registration, and GUI surfaces to support the new provider, including availability diagnostics when the SDK is missing.
- Enhanced the OpenAI-compatible HTTP provider：自动识别 `input` 结构差异、在 Responses 端点失败时回退到纯字符串模式，并修复流式上下文 `_GeneratorContextManager` 异常；同步刷新可选依赖与架构文档。
- Introduced unit/GUI tests 与 env-driven integration checks，覆盖 provider 行为、配置归一、UI 提示及真实兼容端点验证。

### File List
- docs/architecture/部署与运维指引.md
- docs/stories/3.2.openai-official-sdk-integration.md
- novelwriter/ai/config.py
- novelwriter/ai/providers/__init__.py
- novelwriter/ai/providers/factory.py
- novelwriter/ai/providers/openai_compatible.py
- novelwriter/ai/providers/openai_sdk.py
- novelwriter/dialogs/preferences.py
- novelwriter/extensions/ai_copilot/dock.py
- novelwriter/extensions/ai_copilot/handler.py
- pyproject.toml
- requirements-dev.txt
- tests/test_ai/test_ai_config.py
- tests/test_ai/test_openai_sdk_provider.py
- tests/test_ai/test_openai_compat_live.py
- tests/test_ai/test_providers.py
- tests/test_gui/test_gui_ai_copilot.py
- tests/test_gui/test_gui_preferences_ai.py

## QA Results

### Review Date: 2025-09-20

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

- 新增 `OpenAISDKProvider` 通过官方 SDK 完成能力探测、流式输出与端点回退，模型列表与元数据映射符合现有 `ProviderCapabilities` 契约（novelwriter/ai/providers/openai_sdk.py）。
- `AIConfig`、Provider 工厂与 `AICopilotDock` 现已支持 "openai-sdk"，同时在首选项面板提供依赖可用性提醒与 UI 回显（novelwriter/ai/config.py、novelwriter/dialogs/preferences.py、novelwriter/extensions/ai_copilot/dock.py）。
- HTTP Provider 扩展了 Responses 输入模式自适应逻辑，解决历史 `Invalid type for 'input'` 报错并保留缓存语义（novelwriter/ai/providers/openai_compatible.py）。
- 文档与可选依赖同步更新，`pyproject.toml` / `requirements-dev.txt` 包含 `openai>=1.0,<2.0`，运维指引新增安装与诊断步骤（pyproject.toml、docs/architecture/部署与运维指引.md）。

### Refactoring Performed

未做额外重构；聚焦 Provider 引入与配置联动。

### Compliance Check

- 编码标准: ✓ 符合项目 PEP8/命名约定。
- 项目结构: ✓ 新文件、修改均遵循分层架构。
- 测试策略: ✓ 新增单元与 GUI 覆盖官方 SDK Provider、偏好设置与 UI 提示。
- 所有验收标准: ✓ AC1-AC5 皆满足。

### Improvements Checklist

- [x] 官方 SDK Provider 支持 Responses/Chat 端点与输入转换。
- [x] Provider 工厂、配置与 UI 面板整合 "openai-sdk" 选项。
- [x] 可选依赖与运维文档覆盖官方 SDK 安装与诊断。
- [x] 单元/GUI 测试覆盖 Provider 构建、流式输出、降级及 UI 切换。
- [ ] 将 Story `Status` 更新为 `Done` 并在发布说明中补充 SDK 切换的用户沟通要点。

### Security Review

延续原有密钥与可选依赖策略，无新增泄漏面；官方 SDK 客户端按需复用自定义 headers。

### Performance Considerations

模型列表/元数据仍采用缓存 + TTL；Responses/Chat 流式适配未引入额外阻塞。

### Files Modified During Review

本次评审未追加代码变更，所有反馈均记录于 QA 结果与 Gate。

### Gate Status

Gate: PASS → docs/qa/gates/3.2-openai-official-sdk-integration.yml
Risk profile: 暂未生成（如需进一步评估可使用 `*risk-profile` 指令）
NFR assessment: 同上

### Recommended Status

✓ Ready for Done（待 Story 状态字段同步）
