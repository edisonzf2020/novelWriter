# Story 1.2: 基础的 AI 文本建议与预览

## Status
Done

## Story
**As a** novelWriter 作者,
**I want** 向 AI Copilot 请求文本建议并在应用前预览,
**so that** 我可以安全、可控地利用 AI 提升写作效率。

## Acceptance Criteria
1. Copilot 面板包含输入框和消息区，能流式显示 AI 响应不卡顿 UI。[Source: docs/prd/第一部分p0-基础框架与只读-api.md#用户故事-12-基础的-ai-文本建议与预览]
2. 提供至少 3 个基础快捷动作（如："摘要"、"续写"、"改写"）。[Source: docs/prd/第一部分p0-基础框架与只读-api.md#用户故事-12-基础的-ai-文本建议与预览]
3. 当 AI 生成修改建议时，通过 `previewSuggestion` API 提供清晰的 Diff 预览。[Source: docs/prd/第一部分p0-基础框架与只读-api.md#用户故事-12-基础的-ai-文本建议与预览][Source: novelwriter/ai/api.py:590]
4. P0 阶段写操作为手动应用，用户预览后需点击按钮确认。[Source: docs/prd/第一部分p0-基础框架与只读-api.md#用户故事-12-基础的-ai-文本建议与预览]
5. AI 网络调用支持超时（默认 30 秒）和取消操作。[Source: docs/prd/第一部分p0-基础框架与只读-api.md#用户故事-12-基础的-ai-文本建议与预览]

## Tasks / Subtasks
- [x] 扩展 AI Copilot Dock UI 组件 (AC: 1,2)
  - [x] 在 `novelwriter/extensions/ai_copilot/dock.py` 中替换占位内容为功能性 UI
  - [x] 添加用户输入区域：包含多行文本输入框（QTextEdit）和发送按钮（QPushButton）
  - [x] 添加快捷动作区域：至少包含"摘要"、"续写"、"改写"三个预设按钮
  - [x] 添加响应显示区域：支持流式文本显示的 QTextBrowser 或类似组件
  - [x] 确保所有控件支持主题切换和 i18n 翻译
- [x] 实现 AI 请求处理逻辑 (AC: 1,3,5)
  - [x] 创建 `novelwriter/extensions/ai_copilot/handler.py` 处理 AI 交互
  - [x] 实现异步 AI 请求发送，使用 QThread 或 QTimer 避免 UI 阻塞
  - [x] 集成 NWAiApi 的事务管理和上下文获取功能
  - [x] 实现超时控制（默认30秒）和用户取消操作
  - [x] 处理网络错误和 API 错误，显示用户友好的错误消息
- [x] 实现建议预览和应用功能 (AC: 3,4)
  - [x] 使用 `NWAiApi.previewSuggestion()` 生成 Diff 预览
  - [x] 创建建议预览 UI 组件，清晰展示原文本和建议文本的差异
  - [x] 实现"应用建议"和"拒绝建议"按钮
  - [x] 集成 `NWAiApi.applySuggestion()` 完成建议应用
  - [x] 在应用建议后更新编辑器视图和项目状态
- [x] 实现快捷动作处理 (AC: 2,3)
  - [x] 为"摘要"动作：基于当前上下文生成内容摘要
  - [x] 为"续写"动作：基于当前文档位置生成后续内容建议
  - [x] 为"改写"动作：基于选中文本生成替换建议，使用 previewSuggestion 流程
  - [x] 根据用户选择的上下文范围（选中文本、当前文档等）调整请求内容
- [x] 增强错误处理和用户体验 (AC: 5)
  - [x] 实现请求进度指示器和加载状态
  - [x] 添加取消按钮允许用户中断正在进行的 AI 请求
  - [x] 处理 AI 服务不可用、网络超时等异常情况
  - [x] 提供清晰的状态反馈和错误消息
- [x] 更新测试覆盖 (AC: 1-5)
  - [x] 扩展 `tests/test_gui/test_gui_ai_copilot.py` 验证新增 UI 组件
  - [x] 新增 `tests/test_ai/test_ai_suggestions.py` 测试建议预览和应用流程
  - [x] 添加异步请求和错误处理的单元测试
  - [x] 验证快捷动作功能和上下文处理

## Dev Notes

### Previous Story Insights
- Story 1.0 已完成 AI Copilot Dock 的基础集成，提供了占位 UI 和依赖检测。[Source: docs/stories/1.0.ai-copilot-dock.md]
- Story 1.1 已完成 AI 配置系统，提供了 `CONFIG.ai` 配置和偏好设置界面。[Source: docs/stories/1.1.ai-preferences.md]
- Story 2.1 已完成 NWAiApi 写入功能，提供了 `previewSuggestion` 和 `applySuggestion` API。[Source: docs/stories/2.1.nwaiapi-write-ops.md]

### Architecture Integration
- 当前 Dock 实现位于 `novelwriter/extensions/ai_copilot/dock.py`，包含上下文选择器和占位内容。[Source: novelwriter/extensions/ai_copilot/dock.py:25]
- NWAiApi 已提供完整的事务支持、建议预览和应用功能。[Source: novelwriter/ai/api.py:590]
- 主窗口集成已完成，Dock 可以通过 `contextScopeChanged` 信号获取上下文变更。[Source: novelwriter/extensions/ai_copilot/dock.py:15]

### UI Implementation Guidelines
- 使用 PyQt6 组件构建响应式 UI，确保在不同主题下正确显示。[Source: novelwriter/extensions/ai_copilot/dock.py:142]
- 遵循现有的 i18n 模式，所有用户可见文本通过 `self.tr()` 包装。[Source: novelwriter/extensions/ai_copilot/dock.py:224]
- 利用 `SHARED.theme` 获取主题相关的颜色和字体设置。[Source: novelwriter/extensions/ai_copilot/dock.py:225]

### AI Request Handling
- 使用异步模式避免 UI 阻塞，推荐 QThread 或 QTimer 实现。
- 集成现有的 NWAiApi 事务管理，确保所有写入操作在事务上下文中执行。[Source: novelwriter/ai/api.py:221]
- 处理 `CONFIG.ai.timeout` 配置，默认30秒超时。[Source: novelwriter/ai/config.py:26]

### Suggestion Preview Implementation
- 使用 `NWAiApi.previewSuggestion()` 生成 unified diff 格式的预览。[Source: novelwriter/ai/api.py:590]
- 建议展示应该清晰区分原文本和建议文本，可考虑使用颜色编码或并排显示。
- 预览后的应用操作使用 `NWAiApi.applySuggestion()` 确保一致的事务处理。[Source: novelwriter/ai/api.py:647]

### Quick Actions Design
- "摘要"：基于当前上下文生成内容概要，不涉及文本修改
- "续写"：在当前光标位置或文档末尾生成继续内容建议
- "改写"：基于选中文本生成替换建议，使用 previewSuggestion 流程
- 根据 Dock 的上下文选择器（selection、current_document、outline、project）调整请求范围

### Deployment & Rollback Plan
- 上线前通过 `pip install .[ai]` 或 `pip install novelWriter[ai]` 安装 httpx 等 Copilot 依赖，并在 `python -m pytest tests/test_ai/test_ai_suggestions.py` 中验证安装可用。
- 首次启用 AI 功能前，使用偏好设置中的“AI”页确认 `provider`、`api_key`、`base_url` 已填写，同时在开发环境内执行一次 `CONFIG.ai.create_provider()` 以触发能力检测并记录日志。
- 若部署后需要回退，可在偏好设置中禁用 AI，并执行以下步骤：
  1. 在 `~/.config/novelWriter/novelWriter.conf` 或相应配置目录中备份现有 `AI` 段落。
  2. 运行 `novelwriter --info` 确认 `AI Copilot` Dock 已恢复到占位状态。
  3. 如需彻底撤销代码，使用 Git 回滚至 Story 1.1 的标签（`git checkout <pre-story-1.2-tag>`）并重新启动应用。
- 回滚责任人：AI 功能上线由 Feature Owner（当前为 AI 小组）值守，若触发严重问题由 Feature Owner 发起回退并通知支持团队。

### Ops & Support Considerations
- 监控：上线后持续关注 `~/.cache/novelWriter/log/novelWriter.log` 中的 `provider.request.failed`、`suggestion.apply_failed` 日志；建议集成到现有桌面诊断脚本以便用户反馈。
- 支持路径：若用户报告 AI 服务异常，指导其执行偏好设置中的“禁用 AI”，并收集日志与 `CONFIG.ai.getProviderCapabilitiesSummary()` 输出供排查。
- 沟通：上线前在社区与发行说明中提示需安装 `novelWriter[ai]` optional extras，并说明 Copilot 功能仍为预览阶段。

### Error Handling Strategy
- 网络超时：显示友好提示并允许重试
- API 错误：解析 NWAiApiError 并显示具体错误信息
- 配置错误：引导用户检查 AI 配置设置
- 服务不可用：提供离线模式或降级功能提示

### Testing Strategy
- GUI 测试：使用 `nwGUI` fixture 和 `QT_QPA_PLATFORM=offscreen` 模式
- API 集成测试：模拟 AI 响应和网络条件
- 异步操作测试：验证请求取消和超时处理
- 用户交互测试：验证按钮点击、文本输入和预览应用流程

## Testing
- `QT_QPA_PLATFORM=offscreen pytest tests/test_gui/test_gui_ai_copilot.py`
- `pytest tests/test_ai/test_ai_suggestions.py`
- `pytest tests/test_ai/test_api_write.py` (确保无回归)

## Change Log
| Date | Version | Description | Author |
| --- | --- | --- | --- |
| 2025-09-18 | 0.1 | Initial draft as补充故事 | Bob (Scrum Master) |

## Dev Agent Record
### Agent Model Used
- Codex (GPT-5)

### Debug Log References
- `python -m pytest`
- `python -m pytest tests/test_gui/test_gui_doceditor.py::testGuiEditor_TextManipulation tests/test_gui/test_gui_doceditor.py::testGuiEditor_Search tests/test_gui/test_gui_guimain.py::testGuiMain_Viewing tests/test_gui/test_gui_guimain.py::testGuiMain_Features tests/test_gui/test_gui_guimain.py::testGuiMain_FocusView tests/test_gui/test_gui_mainmenu.py::testGuiMainMenu_Insert tests/test_gui/test_gui_preferences_ai.py::test_preferences_ai_updates_configuration tests/test_gui/test_gui_search.py::testGuiDocSearch_Main`
- `source /Users/fanmac/AI/novelWriter/writer/bin/activate && python -m pytest tests/test_ai/test_ai_suggestions.py`

### Completion Notes List
- 添加 AI Copilot 交互界面（输入区、消息流、快捷动作、建议预览）并与 `NWAiApi` 写入流程打通。
- 新增异步请求管理器 `CopilotRequestManager`，支持流式输出、取消、错误提示及会话记忆记录。
- 补充 GUI/AI 测试覆盖 Dock 行为、写入流程与跨平台快捷键逻辑。
- 调整 `NWAiApi.streamChatCompletion` 与 `CopilotWorker`，支持显式关闭流式请求并在线程取消时主动释放底层资源，新增单测校验 `close()` 行为。

### File List
- novelwriter/extensions/ai_copilot/dock.py
- novelwriter/extensions/ai_copilot/handler.py
- novelwriter/ai/api.py
- novelwriter/ai/providers/openai_compatible.py
- tests/test_ai/test_ai_suggestions.py
- tests/test_gui/test_gui_ai_copilot.py
- tests/test_gui/test_gui_doceditor.py
- tests/test_gui/test_gui_guimain.py
- tests/test_gui/test_gui_mainmenu.py
- tests/test_gui/test_gui_preferences_ai.py
- tests/test_gui/test_gui_search.py

## QA Results
- **PASS** 取消逻辑现通过 `_set_active_stream` 跟踪迭代器并在 `CopilotWorker.cancel` 中显式关闭流式响应，`streamChatCompletion` 的生成器在 `close()` 时抛出并被标记为已取消，Dock 控件和事务恢复正常（novelwriter/extensions/ai_copilot/handler.py:19-131，novelwriter/ai/api.py:175-223）。
- **Testing** `pytest tests/test_ai/test_ai_suggestions.py tests/test_ai/test_api_readonly.py tests/test_ai/test_ai_config.py`（20 passed in 0.60s）。